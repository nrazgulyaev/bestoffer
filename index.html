<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arconique / Калькулятор рассрочки для любимых клиентов — v8.1</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        *{box-sizing:border-box}
        
        :root{
            /* Современная цветовая палитра */
            --bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            --card: rgba(255,255,255,0.03);
            --card-hover: rgba(255,255,255,0.08);
            --card-active: rgba(255,255,255,0.12);
            --line: rgba(255,255,255,0.08);
            --line-hover: rgba(255,255,255,0.15);
            --muted: #94a3b8;
            --ink: #f8fafc;
            --ink-secondary: #cbd5e1;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --success-hover: #059669;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --radius: 16px;
            --radius-sm: 8px;
            --radius-lg: 24px;
            
            /* Современные тени */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Анимации */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Отступы и размеры */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Высота блоков */
            --block-min-height: 200px;
            --block-max-height: 600px;
            
            /* Z-index слои */
            --z-base: 1;
            --z-card: 10;
            --z-modal: 1000;
            --z-tooltip: 1100;
        }
        
        /* Базовые стили */
        body{
            margin:0;
            font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            background:var(--bg);
            color:var(--ink);
            min-height:100vh;
            overflow-x:hidden;
            line-height:1.6;
        }
        
        /* Современные анимации для элементов */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-8px) rotate(0.5deg); }
            66% { transform: translateY(4px) rotate(-0.5deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Современные компоненты */
        .wrap{
            max-width:1400px;
            margin:24px auto;
            padding:0 16px;
            animation: fadeInUp 0.8s ease-out;
        }
        
        h1{
            margin:0 0 16px;
            font-size:clamp(1.5rem, 4vw, 2.5rem);
            font-weight:700;
            background:linear-gradient(135deg, var(--ink) 0%, var(--ink-secondary) 100%);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            text-align:center;
        }
        
        /* Современная сетка */
        .grid{
            display:grid;
            grid-template-columns:420px 1fr;
            gap:24px;
            animation: fadeInScale 0.6s ease-out 0.2s both;
        }
        
        @media (max-width: 1023px) {
            .grid { grid-template-columns: 1fr; gap: 16px; }
        }
        
        /* Полноширинный блок для каталога */
        .full-width-block {
            grid-column: 1 / -1;
            margin-top: 24px;
        }
        
        /* Современные карточки */
        .card{
            background:var(--card);
            border:1px solid var(--line);
            border-radius:var(--radius);
            padding:24px;
            backdrop-filter:blur(20px);
            box-shadow:var(--shadow);
            transition:all var(--transition-normal);
            position:relative;
            overflow:hidden;
            margin-bottom: var(--spacing-lg);
            animation: slideInUp 0.6s ease-out;
        }
        
        .card::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            height:1px;
            background:linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity:0;
            transition:opacity var(--transition-normal);
        }
        
        .card:hover{
            background:var(--card-hover);
            border-color:var(--line-hover);
            transform:translateY(-4px);
            box-shadow:var(--shadow-lg);
        }
        
        .card:hover::before{
            opacity:1;
        }
        
        .card:active{
            background:var(--card-active);
            transform:translateY(-2px);
            box-shadow:var(--shadow-md);
        }
        
        /* Современные заголовки карточек */
        .card-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:20px;
            padding-bottom:16px;
            border-bottom:1px solid var(--line);
        }
        
        .card-header h3{
            margin:0;
            font-size:1.25rem;
            font-weight:600;
            color:var(--ink);
            display:flex;
            align-items:center;
            gap:8px;
        }
        
        .card-header h3::before{
            content:'';
            width:4px;
            height:20px;
            background:linear-gradient(180deg, var(--primary), var(--accent));
            border-radius:2px;
        }
        
        .card-actions{
            display:flex;
            gap:8px;
        }
        
        /* Умные вкладки */
        .smart-tabs{
            display:flex;
            gap:4px;
            margin-bottom:20px;
            background:var(--card);
            border-radius:var(--radius-sm);
            padding:4px;
            border:1px solid var(--line);
        }
        
        .smart-tab{
            flex:1;
            padding:12px 16px;
            border-radius:var(--radius-sm);
            border:none;
            background:transparent;
            color:var(--muted);
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            transition:all var(--transition-fast);
            position:relative;
            overflow:hidden;
            display:flex;
            align-items:center;
            gap:8px;
            justify-content:center;
        }
        
        .smart-tab::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:var(--primary);
            border-radius:var(--radius-sm);
            transform:scale(0);
            transition:transform var(--transition-bounce);
        }
        
        .smart-tab span{
            position:relative;
            z-index:1;
        }
        
        .smart-tab:hover{
            color:var(--ink);
        }
        
        .smart-tab.active{
            color:white;
        }
        
        .smart-tab.active::before{
            transform:scale(1);
        }
        
        .tab-icon{
            font-size:16px;
        }
        
        .tab-counter{
            background:rgba(255,255,255,0.2);
            border-radius:12px;
            padding:2px 8px;
            font-size:11px;
            font-weight:600;
        }
        
        /* Современные кнопки */
        .btn{
            appearance:none;
            border:none;
            background:var(--card);
            color:var(--ink);
            padding:12px 20px;
            border-radius:var(--radius-sm);
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            transition:all var(--transition-fast);
            border:1px solid var(--line);
            position:relative;
            overflow:hidden;
            display:inline-flex;
            align-items:center;
            gap:8px;
            text-decoration:none;
            white-space: nowrap;
        }
        
        .btn::before{
            content:'';
            position:absolute;
            top:0;
            left:-100%;
            width:100%;
            height:100%;
            background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition:left var(--transition-slow);
        }
        
        .btn:hover::before{
            left:100%;
        }
        
        .btn:hover{
            background:var(--card-hover);
            border-color:var(--line-hover);
            transform:translateY(-2px);
            box-shadow:var(--shadow-md);
        }
        
        .btn:active{
            transform:translateY(0);
            box-shadow:var(--shadow-sm);
        }
        
        .btn.primary{
            background:var(--primary);
            border-color:var(--primary);
            color:white;
        }
        
        .btn.primary:hover{
            background:var(--primary-hover);
            border-color:var(--primary-hover);
        }
        
        .btn.success{
            background:var(--success);
            border-color:var(--success);
            color:white;
        }
        
        .btn.success:hover{
            background:var(--success-hover);
            border-color:var(--success-hover);
        }
        
        .btn.warning{
            background:var(--warning);
            border-color:var(--warning);
            color:white;
        }
        
        .btn.warning:hover{
            background:var(--warning-hover);
            border-color:var(--warning-hover);
        }
        
        .btn.danger{
            background:var(--danger);
            border-color:var(--danger);
            color:white;
        }
        
        .btn.danger:hover{
            background:var(--danger-hover);
            border-color:var(--danger-hover);
        }
        
        .btn.icon{
            padding:10px;
            border-radius:50%;
            min-width:40px;
            justify-content:center;
        }
        
        /* Современные поля ввода */
        .field{
            display:grid;
            gap:8px;
            margin-bottom:20px;
        }
        
        .field label{
            color:var(--muted);
            font-size:13px;
            font-weight:500;
            display:flex;
            align-items:center;
            gap:6px;
        }
        
        .field label::before{
            content:'';
            width:3px;
            height:3px;
            background:var(--accent);
            border-radius:50%;
        }
        
        .field input, .field select, .field textarea{
            width:100%;
            padding:14px 18px;
            border-radius:var(--radius-sm);
            border:1px solid var(--line);
            background:var(--card);
            color:var(--ink);
            font-size:14px;
            transition:all var(--transition-fast);
            backdrop-filter:blur(10px);
        }
        
        .field input:focus, .field select:focus, .field textarea:focus{
            outline:none;
            border-color:var(--primary);
            background:var(--card-hover);
            box-shadow:0 0 0 3px rgba(59, 130, 246, 0.1);
            transform:translateY(-1px);
        }
        
        .field input:hover, .field select:hover, .field textarea:hover{
            border-color:var(--line-hover);
            background:var(--card-hover);
        }
        
        /* Компактные поля для настроек */
        .field.compact {
            min-width: 120px;
            max-width: 180px;
        }
        
        .field.compact input, .field.compact select {
            padding: 10px 12px;
            font-size: 13px;
        }
        
        /* Строки с полями */
        .row{
            display:flex;
            gap:var(--spacing-lg);
            align-items:flex-end;
            margin-bottom:var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .row .field{
            flex:1;
            margin-bottom:0;
            min-width: 140px;
        }
        
        /* Адаптивность для строк */
        @media (max-width: 768px) {
            .row { flex-direction: column; gap: var(--spacing-md); }
            .row .field { margin-bottom: var(--spacing-md); min-width: auto; }
        }

                /* Современные таблицы */
        .calc-scroll{
            overflow:auto;
            max-height:35vh;
            border:1px solid var(--line);
            border-radius:var(--radius-sm);
            background:var(--card);
            position:relative;
            margin-bottom: var(--spacing-lg);
        }
        
        .calc-scroll::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            height:1px;
            background:linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity:0.5;
        }
        
        .calc-table{
            min-width:800px;
            border-collapse:separate;
            border-spacing:0;
            width: 100%;
        }
        
        .calc-table th{
            position:sticky;
            top:0;
            background:rgba(15, 20, 32, 0.95);
            backdrop-filter:blur(20px);
            z-index:10;
            padding:16px 12px;
            font-weight:600;
            font-size:13px;
            color:var(--ink);
            border-bottom:2px solid var(--line);
            text-align:center;
            transition:background var(--transition-fast);
        }
        
        .calc-table th:hover{
            background:rgba(15, 20, 32, 0.98);
        }
        
        .calc-table td{
            padding:14px 12px;
            border-bottom:1px solid var(--line);
            text-align:center;
            transition:all var(--transition-fast);
        }
        
        .calc-table tr:hover td{
            background:rgba(255,255,255,0.02);
        }
        
        .calc-table tr:hover td:first-child{
            border-left:3px solid var(--primary);
        }
        
        /* Оптимизированная таблица этапов */
        .stages-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .stages-table th, .stages-table td {
            padding: var(--spacing-sm);
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid var(--line);
        }
        
        .stages-table th {
            background: var(--card-hover);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--line);
        }
        
        .stages-table .col-stage {
            width: 40%;
            min-width: 150px;
            text-align: left;
        }
        
        .stages-table .col-percent {
            width: 15%;
            min-width: 80px;
            max-width: 100px;
        }
        
        .stages-table .col-month {
            width: 15%;
            min-width: 80px;
            max-width: 100px;
        }
        
        .stages-table .col-actions {
            width: 20%;
            min-width: 100px;
        }
        
        .stages-table tr:last-child td {
            border-bottom: none;
        }
        
        .stages-table tr:hover {
            background: var(--card-hover);
        }
        
        .stages-table tr:hover td {
            border-color: var(--line-hover);
        }
        
        /* Стилизованные поля для этапов */
        .stage-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            color: var(--ink);
            font-size: 13px;
            transition: all var(--transition-fast);
        }
        
        .stage-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--card-hover);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .stage-number-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            color: var(--ink);
            font-size: 13px;
            text-align: center;
            max-width: 80px;
        }
        
        .stage-number-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--card-hover);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Отображение месяца с реальной датой */
        .month-display {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .month-number {
            font-weight: 600;
            color: var(--ink);
        }
        
        .month-date {
            font-size: 11px;
            color: var(--muted);
            font-style: italic;
        }
        
        /* Кнопки действий для этапов */
        .stage-actions {
            display: flex;
            gap: var(--spacing-xs);
            justify-content: center;
        }
        
        .delete-stage-btn {
            padding: 6px 10px;
            background: var(--danger);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }
        
        .delete-stage-btn:hover {
            background: var(--danger-hover);
            transform: translateY(-1px);
        }
        
        /* Таблица кэшфлоу */
        .cashflow-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .cashflow-table th {
            background: var(--card-hover);
            border-bottom: 2px solid var(--line);
            border-right: 1px solid var(--line);
            padding: var(--spacing-md);
            font-weight: 600;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .cashflow-table th:last-child {
            border-right: none;
        }
        
        .cashflow-table td {
            border-bottom: 1px solid var(--line);
            border-right: 1px solid var(--line);
            padding: var(--spacing-md);
            text-align: center;
        }
        
        .cashflow-table td:last-child {
            border-right: none;
        }
        
        .cashflow-table tr:last-child td {
            border-bottom: none;
        }
        
        .cashflow-table tbody tr:hover {
            background: var(--card-hover);
        }
        
        .cashflow-table tbody tr:hover td {
            border-color: var(--line-hover);
        }
        
        /* Современные модальные окна */
        .modal-overlay{
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:rgba(0,0,0,0.8);
            backdrop-filter:blur(8px);
            display:flex;
            align-items:center;
            justify-content:center;
            padding:20px;
            z-index:1000;
            animation:fadeInScale 0.3s ease-out;
        }
        
        .modal-content{
            background:var(--card);
            border:1px solid var(--line);
            border-radius:var(--radius-lg);
            padding:0;
            max-width:90vw;
            max-height:90vh;
            overflow:hidden;
            box-shadow:var(--shadow-xl);
            animation:fadeInUp 0.4s ease-out 0.1s both;
            position:relative;
        }
        
        .modal-content::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            height:3px;
            background:linear-gradient(90deg, var(--primary), var(--accent), var(--success));
        }
        
        .modal-header{
            padding:24px 24px 16px;
            border-bottom:1px solid var(--line);
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        
        .modal-header h3{
            margin:0;
            font-size:1.5rem;
            font-weight:600;
            color:var(--ink);
        }
        
        .modal-body{
            padding:24px;
            overflow-y:auto;
            max-height:60vh;
        }
        
        /* Современные формы */
        .form-section{
            margin-bottom:24px;
        }
        
        .form-section h4{
            margin:0 0 16px;
            font-size:1.1rem;
            font-weight:600;
            color:var(--ink);
            display:flex;
            align-items:center;
            gap:8px;
        }
        
        .form-section h4::before{
            content:'';
            width:3px;
            height:16px;
            background:var(--accent);
            border-radius:2px;
        }
        
        .form-row{
            display:grid;
            grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
            gap:16px;
            margin-bottom:16px;
        }
        
        .form-group{
            display:grid;
            gap:6px;
        }
        
        .form-actions{
            display:flex;
            gap:12px;
            justify-content:flex-end;
            padding-top:20px;
            border-top:1px solid var(--line);
            margin-top:24px;
        }
        
        /* Современные KPI блоки */
        .kpis{
            display:grid;
            grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
            gap:16px;
            margin:20px 0;
        }
        
        .kpi{
            background:var(--card);
            border:1px solid var(--line);
            border-radius:var(--radius-sm);
            padding:16px;
            text-align:center;
            transition:all var(--transition-normal);
            position:relative;
            overflow:hidden;
            animation: slideInUp 0.6s ease-out;
        }
        
        .kpi::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            height:2px;
            background:linear-gradient(90deg, var(--primary), var(--accent));
            transform:scaleX(0);
            transition:transform var(--transition-normal);
        }
        
        .kpi:hover{
            background:var(--card-hover);
            border-color:var(--line-hover);
            transform:translateY(-2px);
            box-shadow:var(--shadow-md);
        }
        
        .kpi:hover::before{
            transform:scaleX(1);
        }
        
        .kpi .muted{
            font-size:12px;
            color:var(--muted);
            margin-bottom:8px;
            display:block;
        }
        
        .kpi .v{
            font-size:1.5rem;
            font-weight:700;
            color:var(--ink);
            background:linear-gradient(135deg, var(--ink) 0%, var(--accent) 100%);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
        }
        
        /* Группировка настроек */
        .settings-group {
            margin-bottom: 20px;
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .settings-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--card-hover);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .settings-header:hover {
            background: var(--card-active);
        }
        
        .group-icon {
            font-size: 18px;
        }
        
        .group-title {
            flex: 1;
            font-weight: 600;
            color: var(--ink);
        }
        
        .group-toggle {
            font-size: 20px;
            font-weight: bold;
            color: var(--muted);
            transition: transform var(--transition-fast);
        }
        
        .settings-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-normal);
        }
        
        .settings-content.expanded {
            max-height: 800px; /* Увеличил высоту для корректного отображения */
        }
        
        .settings-content > div {
            padding: 20px;
        }
        
        /* Дополнительные элементы */
        .pill{
            padding:6px 12px;
            border-radius:999px;
            background:rgba(255,255,255,0.1);
            border:1px solid rgba(255,255,255,0.2);
            font-size:12px;
            color:var(--ink);
        }
        
        .badge{
            background:rgba(255,255,255,0.1);
            border:1px solid rgba(255,255,255,0.2);
            padding:4px 8px;
            border-radius:6px;
            font-size:11px;
            color:var(--muted);
        }
        
        .muted{color:var(--muted)}
        
        .hr{ 
            height:1px; 
            background:var(--line); 
            border:0; 
            margin:var(--spacing-lg) 0; 
        }
        
        .scroll{ 
            overflow:auto; 
            max-height:50vh; 
        }
        
        /* Адаптивность */
        @media (max-width: 767px) {
            .form-row { grid-template-columns: 1fr; }
            .kpis { grid-template-columns: repeat(2, 1fr); }
            .smart-tabs { flex-direction: column; }
            .modal-content { margin: 20px; max-width: calc(100vw - 40px); }
            .stages-table .col-stage { min-width: 120px; }
            .stages-table .col-percent, .stages-table .col-month { min-width: 60px; max-width: 70px; }
        }
        
        @media (min-width: 1200px) {
            .settings-row { gap: var(--spacing-2xl); }
        }
        
        @media (max-width: 480px) {
            .field.compact { min-width: 100px; }
        }
        
        /* Мобильная навигация */
        @media (max-width: 768px) {
            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--card);
                border-top: 1px solid var(--line);
                padding: 12px;
                z-index: 1000;
                display: flex;
                gap: 8px;
                justify-content: space-around;
            }
            
            .mobile-nav-btn {
                flex: 1;
                padding: 12px;
                border: none;
                background: transparent;
            color: var(--muted);
                border-radius: var(--radius-sm);
                transition: all var(--transition-fast);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                font-size: 12px;
            }
            
            .mobile-nav-btn.active {
                background: var(--primary);
                color: white;
            }
            
            .mobile-nav-btn:hover {
                background: var(--card-hover);
                color: var(--ink);
            }
        }
        
        /* Индикатор автосохранения */
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            transition: all var(--transition-fast);
            opacity: 0;
            transform: translateY(-10px);
        }
        
        .auto-save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .auto-save-indicator.saving {
            background: var(--warning);
            color: white;
        }
        
        .auto-save-indicator.saved {
            background: var(--success);
            color: white;
        }
        
        .auto-save-indicator.error {
            background: var(--danger);
            color: white;
        }
        
        /* Умные подсказки */
        .smart-tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: 12px;
            color: var(--ink);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-fast);
            z-index: var(--z-tooltip);
            box-shadow: var(--shadow-lg);
        }
        
        .smart-tooltip:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-4px);
        }
        
        /* Анимации для всех элементов */
        .animate-fade-in {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .animate-slide-left {
            animation: slideInLeft 0.6s ease-out;
        }
        
        .animate-scale {
            animation: fadeInScale 0.6s ease-out;
        }
        
        /* Улучшенные поля ввода */
        .field input:focus, .field select:focus, .field textarea:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        
        /* Улучшенные кнопки */
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

                /* Дополнительные стили для каталога */
        .catalog-card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            overflow: hidden;
            transition: all var(--transition-fast);
        }
        
        .catalog-card:hover {
            border-color: var(--line-hover);
            box-shadow: var(--shadow-md);
        }
        
        .catalog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--card-hover);
            border-bottom: 1px solid var(--line);
        }
        
        .catalog-actions {
            display: flex;
            gap: 8px;
        }
        
        .catalog-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .catalog-table th,
        .catalog-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--line);
        }
        
        .catalog-table th {
            background: var(--card-hover);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .catalog-table input {
            width: 100%;
            padding: 8px 12px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            color: var(--ink);
            font-size: 13px;
            transition: all var(--transition-fast);
        }
        
        .catalog-table input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--card-hover);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Стили для отображения данных */
        .project-name-display,
        .villa-name-display,
        .area-display,
        .ppsm-display,
        .base-strong,
        .line-total {
            padding: 8px 12px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            color: var(--ink);
            font-size: 13px;
            text-align: center;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .base-strong {
            font-weight: 600;
            color: var(--strong);
        }
        
        .line-total {
            font-weight: 700;
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }
        
        /* Заголовок расчета */
        .calculation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        /* Адаптивность для мобильных */
        @media (max-width: 768px) {
            .mobile-optimized-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-card {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .mobile-button {
                min-height: 48px;
                padding: 12px 20px;
                font-size: 16px;
            }
            
            .catalog-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .catalog-actions {
                justify-content: center;
            }
        }
        
        /* Планшетная оптимизация */
        @media (min-width: 769px) and (max-width: 1024px) {
            .tablet-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <h1 id="app-title">Arconique / Калькулятор рассрочки для любимых клиентов</h1>
        
        <!-- Индикатор автосохранения -->
        <div id="auto-save-indicator" class="auto-save-indicator"></div>
        
        <!-- Диагностика загрузки -->
        <div id="boot-diagnostics" style="position:fixed;left:10px;top:10px;z-index:99999;background:#1b2336;color:#fff;border:1px solid #334;padding:8px 10px;border-radius:8px;font:12px/1.4 system-ui;max-width:80vw;display:none"></div>
        
        <div id="root"></div>
    </div>
    
    <!-- CDN библиотеки -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Диагностика загрузки -->
    <script>
        (function(){
            const box=document.getElementById('boot-diagnostics');
            const log=(msg)=>{
                box.style.display='block';
                box.innerHTML+=(box.innerHTML?'<br>':'')+msg;
            };
            
            window.addEventListener('error',e=>log('JS error: '+(e?.message||e)));
            window.addEventListener('unhandledrejection',e=>log('Promise error: '+(e?.reason?.message||e?.reason||e)));
            
            let tries=0;
            function tick(){
                const okReact=!!(window.React&&window.ReactDOM);
                const okBabel=!!window.Babel;
                
                if(!okReact) log('React не загрузился (CDN?)');
                if(!okBabel) log('Babel не загрузился — JSX не скомпилируется');
                
                if(okReact&&okBabel){
                    try{
                        window.Babel.transformScriptTags();
                    } catch(e){
                        log('Babel.transformScriptTags() error: '+e.message);
                    }
                    return;
                }
                
                if(++tries<30) setTimeout(tick,200);
                else log('Таймаут ожидания библиотек — проверь блокировщики/фаервол/CDN');
            }
            setTimeout(tick,0);
        })();
    </script>
    
    <!-- Основное приложение -->
    <script type="text/babel" data-presets="env,react">
        const {useEffect,useMemo,useRef,useState} = React;
        
        /* ---------- PIN / security ---------- */
        const PIN_CODE = '334346';
        const PIN_SALT = 'enso-v8.1-salt-1';
        const PIN_HASH_HEX = 'c0b37fd5b1ebc835af06c260b9ceb435285f79ecffd7f0a68be695db347d2aa6';
        
        async function sha256Hex(str){
            try{
                if (!crypto.subtle) {
                    console.warn('crypto.subtle not available, using fallback');
                    return '';
                }
                const buf = new TextEncoder().encode(str);
                const digest = await crypto.subtle.digest('SHA-256', buf);
                return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,'0')).join('');
            }catch(e){
                console.warn('SHA-256 failed:', e);
                return '';
            }
        }
        
        async function verifyPinFlow(){
            const pin = prompt('Enter PIN');
            if(pin==null) return false;
            const hex = await sha256Hex(`${pin}|${PIN_SALT}`);
            if(hex && hex === PIN_HASH_HEX) return true;
            return pin === PIN_CODE;
        }
        
        /* ---------- i18n ---------- */
        const T = {
            ru: {
                title:'Arconique / Калькулятор рассрочки для любимых клиентов',
                editor:'Редактор',
                client:'Клиент',
                lang:'Язык интерфейса',
                currencyDisplay:'Валюта отображения',
                idrRate:'IDR за 1 USD',
                eurRate:'EUR за 1 USD',
                handoverMonth:'Месяц получения ключей',
                globalTerm:'Глобальный срок post‑handover (6–24 мес)',
                globalRate:'Глобальная ставка, %/мес',
                clientTerm:'Срок post‑handover (мес)',
                stagesTitle:'Этапы ДО ключей',
                stage:'Этап',
                percent:'%',
                month:'Месяц',
                addStage:'Добавить этап',
                delete:'Удалить',
                villasTitle:'Расчёт (позиции)',
                project:'Проект',
                villa:'Вилла',
                qty:'Кол-во',
                area:'м²',
                ppsm:'$ / м²',
                price:'База (USD)',
                discount:'Скидка, %',
                prePct:'До ключей, %',
                months:'Срок, мес',
                rate:'Ставка, %/мес',
                firstPost:'Первый платёж',
                lineTotal:'Итог по строке',
                addFromCatalog:'Добавить из каталога',
                cashflowTitle:'Сводный кэшфлоу по месяцам',
                cashMonth:'Месяц',
                cashDesc:'Описание',
                cashTotal:'Сумма к оплате',
                cashBalance:'Остаток долга',
                totals:'Итоги',
                base:'База',
                prepay:'Оплата до ключей',
                after:'Остаток после ключей',
                interestTotal:'Проценты (post)',
                final:'Итоговая цена',
                lines:'Позиций',
                keys:'Ключи: мес.',
                chartTitle:'Платежи по месяцам',
                sumStages:'Сумма этапов',
                targetPrepay:'Целевой % до ключей',
                mismatch:'— отличается от целевого',
                mixedTargets:'разные цели у строк',
                shareCopied:'Ссылка скопирована',
                exportCSV:'Экспорт CSV',
                exportXLSX:'Экспорт Excel',
                exportPDF:'Сохранить в PDF',
                tabCalc:'Расчёт',
                tabCatalog:'Каталог',
                catalogTitle:'Каталог проектов и вилл (редактор)',
                addProject:'Добавить проект',
                addVilla:'Добавить виллу',
                importJSON:'Импорт JSON',
                exportJSON:'Экспорт JSON',
                selectFromCatalog:'Выбор из каталога',
                search:'Поиск',
                areaFrom:'м² от',
                areaTo:'м² до',
                priceFrom:'Цена от',
                priceTo:'Цена до',
                sort:'Сортировать',
                byPrice:'по цене',
                byArea:'по площади',
                byName:'по названию',
                addSelected:'Добавить выбранные',
                cancel:'Отмена',
                qtyShort:'Кол-во',
                baseUSD:'База (USD)',
                projectId:'ID проекта',
                projectName:'Название проекта',
                villaId:'ID виллы',
                villaName:'Название виллы',
                villaArea:'Площадь (м²)',
                villaPpsm:'Цена за м² ($)',
                villaBasePrice:'Базовая цена ($)',
                save:'Сохранить',
                edit:'Редактировать',
                remove:'Удалить',
                projectNameRequired:'Введите название проекта',
                villaNameRequired:'Введите название виллы',
                overview:'Обзор',
                stages:'Этапы',
                catalog:'Каталог',
                settings:'Настройки',
                analytics:'Аналитика',
                backup:'Резервная копия',
                restore:'Восстановить',
                undo:'Отменить',
                redo:'Повторить',
                autoSave:'Автосохранение',
                saving:'Сохранение...',
                saved:'Сохранено',
                error:'Ошибка',
                notes:'Заметки',
                addNote:'Добавить заметку',
                noteType:'Тип заметки',
                noteContent:'Содержание заметки',
                tags:'Теги',
                addTag:'Добавить тег',
                tagName:'Название тега',
                tagColor:'Цвет тега',
                templates:'Шаблоны',
                saveTemplate:'Сохранить как шаблон',
                templateName:'Название шаблона',
                loadTemplate:'Загрузить шаблон',
                deleteTemplate:'Удалить шаблон',
                confirmDelete:'Подтвердить удаление',
                areYouSure:'Вы уверены?',
                yes:'Да',
                no:'Нет',
                close:'Закрыть',
                loading:'Загрузка...',
                success:'Успешно',
                warning:'Внимание',
                info:'Информация'
            },
            en: {
                title:'Arconique / Installments Calculator',
                editor:'Editor',
                client:'Client',
                lang:'Language',
                currencyDisplay:'Display currency',
                idrRate:'IDR per 1 USD',
                eurRate:'EUR per 1 USD',
                handoverMonth:'Handover month',
                globalTerm:'Global post‑handover term (6–24 mo)',
                globalRate:'Global rate, %/month',
                clientTerm:'Post‑handover term (months)',
                stagesTitle:'Pre‑handover stages',
                stage:'Stage',
                percent:'%',
                month:'Month',
                addStage:'Add stage',
                delete:'Delete',
                villasTitle:'Calculation (lines)',
                project:'Project',
                villa:'Villa',
                qty:'Qty',
                area:'sqm',
                ppsm:'$ / sqm',
                price:'Base (USD)',
                discount:'Discount, %',
                prePct:'Pre‑handover, %',
                months:'Term, mo',
                rate:'Rate, %/mo',
                firstPost:'First payment',
                lineTotal:'Line total',
                addFromCatalog:'Add from catalog',
                cashflowTitle:'Monthly consolidated cashflow',
                cashMonth:'Month',
                cashDesc:'Description',
                cashTotal:'Amount due',
                cashBalance:'Remaining balance',
                totals:'Totals',
                base:'Base',
                prepay:'Paid before keys',
                after:'Balance after keys',
                interestTotal:'Interest (post)',
                final:'Final price',
                lines:'Lines',
                keys:'Keys: mo.',
                chartTitle:'Payments by month',
                sumStages:'Stages sum',
                targetPrepay:'Target pre‑handover %',
                mismatch:'— differs from target',
                mixedTargets:'different line targets',
                shareCopied:'Link copied',
                exportCSV:'Export CSV',
                exportXLSX:'Export Excel',
                exportPDF:'Save to PDF',
                tabCalc:'Calculation',
                tabCatalog:'Catalog',
                catalogTitle:'Projects & Villas Catalog (editor)',
                addProject:'Add project',
                addVilla:'Add villa',
                importJSON:'Import JSON',
                exportJSON:'Export JSON',
                selectFromCatalog:'Select from catalog',
                search:'Search',
                areaFrom:'sqm from',
                areaTo:'sqm to',
                priceFrom:'Price from',
                priceTo:'Price to',
                sort:'Sort',
                byPrice:'by price',
                byArea:'by area',
                byName:'by name',
                addSelected:'Add selected',
                cancel:'Cancel',
                qtyShort:'Qty',
                baseUSD:'Base (USD)',
                projectId:'Project ID',
                projectName:'Project Name',
                villaId:'Villa ID',
                villaName:'Villa Name',
                villaArea:'Area (sqm)',
                villaPpsm:'Price per sqm ($)',
                villaBasePrice:'Base Price ($)',
                save:'Save',
                edit:'Edit',
                remove:'Remove',
                projectNameRequired:'Enter project name',
                villaNameRequired:'Enter villa name',
                overview:'Overview',
                stages:'Stages',
                catalog:'Catalog',
                settings:'Settings',
                analytics:'Analytics',
                backup:'Backup',
                restore:'Restore',
                undo:'Undo',
                redo:'Redo',
                autoSave:'Auto-save',
                saving:'Saving...',
                saved:'Saved',
                error:'Error',
                notes:'Notes',
                addNote:'Add note',
                noteType:'Note type',
                noteContent:'Note content',
                tags:'Tags',
                addTag:'Add tag',
                tagName:'Tag name',
                tagColor:'Tag color',
                templates:'Templates',
                saveTemplate:'Save as template',
                templateName:'Template name',
                loadTemplate:'Load template',
                deleteTemplate:'Delete template',
                confirmDelete:'Confirm deletion',
                areYouSure:'Are you sure?',
                yes:'Yes',
                no:'No',
                close:'Close',
                loading:'Loading...',
                success:'Success',
                warning:'Warning',
                info:'Information'
            }
        };
        
        /* ---------- Утилиты ---------- */
        const clamp=(v,lo,hi)=>Math.min(hi,Math.max(lo,v));
        const fmtMoney=(n,c='USD')=>new Intl.NumberFormat('en-US',{style:'currency',currency:c,maximumFractionDigits:2}).format(n??0);
        
        // Функция генерации уникальных ID
        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };
        
        // Функция определения текущего месяца и года
        const getCurrentMonth = () => {
            const now = new Date();
            return {
                month: now.getMonth() + 1, // 1-12
                year: now.getFullYear(),
                monthIndex: now.getMonth(), // 0-11 для Date
                monthName: now.toLocaleDateString('ru-RU', { month: 'long' }),
                monthNameEn: now.toLocaleDateString('en-US', { month: 'long' })
            };
        };
        
        // Функция расчета реальной даты с переводом
        const calculateRealDate = (monthsFromNow, language) => {
            const date = new Date();
            date.setMonth(date.getMonth() + monthsFromNow);
            
            if (language === 'en') {
                return date.toLocaleDateString('en-US', { 
                    month: 'long', 
                    year: 'numeric' 
                });
            } else {
                return date.toLocaleDateString('ru-RU', { 
                    month: 'long', 
                    year: 'numeric' 
                });
            }
        };
        
        // Функция валидации данных
        const validateData = (data) => {
            const errors = [];
            
            if (data.prePct < 50 || data.prePct > 100) {
                errors.push('Процент до ключей должен быть от 50% до 100%');
            }
            
            if (data.area <= 0) {
                errors.push('Площадь должна быть больше 0');
            }
            
            if (data.ppsm <= 0) {
                errors.push('Цена за м² должна быть больше 0');
            }
            
            return errors;
        };
        
        /* ---------- URL state (compressed hash) ---------- */
        const readHash=()=>{const h=location.hash.startsWith('#')?location.hash.slice(1):location.hash;const sp=new URLSearchParams(h);return {s:sp.get('s'),view:sp.get('view')}};
        const encodeState=(state,{view}={})=>{try{const s=LZString.compressToEncodedURIComponent(JSON.stringify(state));const u=new URL(location.href);const sp=new URLSearchParams();sp.set('s',s);if(view)sp.set('view',view);u.hash=sp.toString();return u.toString()}catch{return''}};
        const decodeState=()=>{try{const {s,view}=readHash();if(!s)return null;const json=LZString.decompressFromEncodedURIComponent(s);return {state:JSON.parse(json),view}}catch{return null}};
        
        /* ---------- demo catalog ---------- */
        const DEFAULT_CATALOG=[
            {projectId:'ahao',projectName:'AHAO Gardens',villas:[
                {villaId:'ahao-2br',name:'2BR Garden Villa',area:100,ppsm:2500,baseUSD:250000},
                {villaId:'ahao-3br',name:'3BR Garden Villa',area:130,ppsm:2450,baseUSD:318500}
            ]},
            {projectId:'enso',projectName:'Enso Villas',villas:[
                {villaId:'enso-2br',name:'Enso 2BR',area:100,ppsm:2500,baseUSD:250000},
                {villaId:'enso-3br',name:'Enso 3BR',area:120,ppsm:2700,baseUSD:324000}
            ]},
            {projectId:'eternal',projectName:'Eternal Villas',villas:[
                {villaId:'eternal-1br',name:'Eternal 1BR Loft',area:80,ppsm:2600,baseUSD:208000},
                {villaId:'eternal-2br',name:'Eternal 2BR',area:110,ppsm:2550,baseUSD:280500}
            ]}
        ];

                /* ---------- Компоненты ---------- */
        function App(){
            const [lang,setLang]=useState('ru');
            const t=T[lang];
            const [tab,setTab]=useState('overview');
            const [isClient,setIsClient]=useState(true);
            const [currency,setCurrency]=useState('USD');
            const [idrPerUsd,setIdrPerUsd]=useState(16500);
            const [eurPerUsd,setEurPerUsd]=useState(0.92);
            const toCurrency=usd=>currency==='USD'?usd:(currency==='IDR'?usd*idrPerUsd:usd*eurPerUsd);
            
            // Текущий месяц для расчетов
            const currentMonth = getCurrentMonth();
            const [handoverMonth,setHandoverMonth]=useState(12);
            const [months,setMonths]=useState(12);
            const [monthlyRatePct,setMonthlyRatePct]=useState(8.33);
            
            // Этапы с реальными датами
            const [stages,setStages]=useState([
                {id:1,label:'Договор',pct:30,month:0,realDate:''},
                {id:2,label:'50% готовности',pct:30,month:6,realDate:''},
                {id:3,label:'70% готовности',pct:20,month:9,realDate:''},
                {id:4,label:'90% готовности',pct:15,month:11,realDate:''},
                {id:5,label:'Ключи',pct:5,month:12,realDate:''},
            ]);
            
            // Обновляем реальные даты при изменении языка
            useEffect(() => {
                setStages(prev => prev.map(s => ({
                    ...s,
                    realDate: calculateRealDate(s.month, lang)
                })));
            }, [lang]);
            
            const stagesSumPct=useMemo(()=>stages.reduce((s,x)=>s+(+x.pct||0),0),[stages]);
            const [catalog,setCatalog]=useState(DEFAULT_CATALOG);
            const [lines,setLines]=useState([
                {id:1,projectId:'enso',villaId:'enso-2br',qty:1,prePct:70,ownTerms:false,months:null,monthlyRatePct:null,firstPostUSD:0,discountPct:0, snapshot:{name:'Enso 2BR',area:100,ppsm:2500,baseUSD:250000}}
            ]);
            
            // Состояния для модальных окон
            const [showAddProjectModal, setShowAddProjectModal] = useState(false);
            const [showAddVillaModal, setShowAddVillaModal] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [newProjectForm, setNewProjectForm] = useState({ projectId: '', projectName: '', villas: [] });
            const [newVillaForm, setNewVillaForm] = useState({ villaId: '', name: '', area: 100, ppsm: 2500, baseUSD: 250000 });
            const [modalOpen,setModalOpen]=useState(false);
            const [catalogModalOpen,setCatalogModalOpen]=useState(false);
            
            // Новые состояния для улучшений
            const [autoSaveStatus, setAutoSaveStatus] = useState('saved');
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
            const [expandedGroups, setExpandedGroups] = useState({
                basic: true,
                stages: false,
                catalog: false
            });
            const [notes, setNotes] = useState([]);
            const [tags, setTags] = useState([
                { id: 1, name: 'VIP', color: '#ff6b6b' },
                { id: 2, name: 'Срочно', color: '#feca57' },
                { id: 3, name: 'Отложено', color: '#48dbfb' }
            ]);
            const [templates, setTemplates] = useState([
                {
                    id: 1,
                    name: 'Стандартная схема',
                    stages: stages,
                    months: 12,
                    rate: 8.33
                },
                {
                    id: 2,
                    name: 'Быстрая схема',
                    stages: [
                        {id:1,label:'Договор',pct:40,month:0,realDate:''},
                        {id:2,label:'Ключи',pct:60,month:6,realDate:''}
                    ],
                    months: 6,
                    rate: 12.5
                }
            ]);
            
            // История изменений
            const [history, setHistory] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(-1);
            
            // Функция добавления в историю
            const addToHistory = (action, data) => {
                const newEntry = {
                    id: Date.now(),
                    action,
                    data: JSON.parse(JSON.stringify(data)),
                    timestamp: new Date()
                };
                
                setHistory(prev => [...prev.slice(0, currentIndex + 1), newEntry]);
                setCurrentIndex(prev => prev + 1);
            };
            
            // Функции отмены/повтора
            const undo = () => {
                if (currentIndex > 0) {
                    setCurrentIndex(prev => prev - 1);
                    restoreFromHistory(history[currentIndex - 1]);
                }
            };
            
            const redo = () => {
                if (currentIndex < history.length - 1) {
                    setCurrentIndex(prev => prev + 1);
                    restoreFromHistory(history[currentIndex + 1]);
                }
            };
            
            const restoreFromHistory = (entry) => {
                if (entry.data.lines) setLines(entry.data.lines);
                if (entry.data.stages) setStages(entry.data.stages);
                if (entry.data.catalog) setCatalog(entry.data.catalog);
            };
            
            // Функции для работы с заметками
            const addNote = (type, content, targetId) => {
                const newNote = {
                    id: Date.now(),
                    type, // 'project', 'villa', 'stage', 'line'
                    content,
                    targetId,
                    timestamp: new Date(),
                    author: 'user'
                };
                setNotes(prev => [...prev, newNote]);
            };
            
            // Функции для работы с тегами
            const addTag = (name, color) => {
                const newTag = {
                    id: Date.now(),
                    name,
                    color
                };
                setTags(prev => [...prev, newTag]);
            };
            
            // Функции для работы с шаблонами
            const saveTemplate = (name) => {
                const newTemplate = {
                    id: Date.now(),
                    name,
                    stages: stages,
                    months: months,
                    rate: monthlyRatePct
                };
                setTemplates(prev => [...prev, newTemplate]);
            };
            
            const loadTemplate = (templateId) => {
                const template = templates.find(t => t.id === templateId);
                if (template) {
                    setStages(template.stages);
                    setMonths(template.months);
                    setMonthlyRatePct(template.rate);
                }
            };
            
            // Функции для работы с проектами
            const addProject = () => {
                const projectId = generateId();
                setNewProjectForm({ 
                    projectId, 
                    projectName: '', 
                    villas: [] 
                });
                setShowAddProjectModal(true);
            };
            
            const saveProject = () => {
                if (!newProjectForm.projectName) {
                    alert(t.projectNameRequired);
                    return;
                }
                
                const projectExists = catalog.find(p => p.projectId === newProjectForm.projectId);
                if (projectExists) {
                    alert('Проект с таким ID уже существует');
                    return;
                }
                
                const newProject = {
                    projectId: newProjectForm.projectId,
                    projectName: newProjectForm.projectName,
                    villas: newProjectForm.villas
                };
                
                setCatalog(prev => [...prev, newProject]);
                addToHistory('addProject', { catalog: [...catalog, newProject] });
                setShowAddProjectModal(false);
                setNewProjectForm({ projectId: '', projectName: '', villas: [] });
            };
            
            // Функции для работы с виллами
            const addVilla = (projectId) => {
                const villaId = generateId();
                setNewVillaForm({ 
                    villaId, 
                    name: '', 
                    area: 100, 
                    ppsm: 2500, 
                    baseUSD: 250000 
                });
                setEditingProject(projectId);
                setShowAddVillaModal(true);
            };
            
            const saveVilla = () => {
                if (!newVillaForm.name) {
                    alert(t.villaNameRequired);
                    return;
                }
                
                const project = catalog.find(p => p.projectId === editingProject);
                if (!project) return;
                
                const villaExists = project.villas.find(v => v.villaId === newVillaForm.villaId);
                if (villaExists) {
                    alert('Вилла с таким ID уже существует в этом проекте');
                    return;
                }
                
                const newVilla = {
                    villaId: newVillaForm.villaId,
                    name: newVillaForm.name,
                    area: newVillaForm.area,
                    ppsm: newVillaForm.ppsm,
                    baseUSD: newVillaForm.area * newVillaForm.ppsm
                };
                
                const updatedCatalog = catalog.map(p => 
                    p.projectId === editingProject 
                        ? { ...p, villas: [...p.villas, newVilla] }
                        : p
                );
                
                setCatalog(updatedCatalog);
                addToHistory('addVilla', { catalog: updatedCatalog });
                setShowAddVillaModal(false);
                setEditingProject(null);
                setNewVillaForm({ villaId: '', name: '', area: 100, ppsm: 2500, baseUSD: 250000 });
            };
            
            // Функция переключения групп настроек
            const toggleGroup = (groupName) => {
                setExpandedGroups(prev => ({
                    ...prev,
                    [groupName]: !prev[groupName]
                }));
            };
            
            // Автосохранение
            useEffect(() => {
                const timeoutId = setTimeout(() => {
                    if (hasUnsavedChanges) {
                        setAutoSaveStatus('saving');
                        try {
                            localStorage.setItem('arconique_v81', JSON.stringify(snapshot()));
                            setAutoSaveStatus('saved');
                            setHasUnsavedChanges(false);
                        } catch (error) {
                            setAutoSaveStatus('error');
                        }
                    }
                }, 2000);
                
                return () => clearTimeout(timeoutId);
            }, [lines, stages, catalog, hasUnsavedChanges]);
            
            // Отображение индикатора автосохранения
            useEffect(() => {
                const indicator = document.getElementById('auto-save-indicator');
                if (indicator) {
                    indicator.textContent = t[autoSaveStatus];
                    indicator.className = `auto-save-indicator ${autoSaveStatus}`;
                    
                    if (autoSaveStatus !== 'saved') {
                        indicator.classList.add('show');
                        setTimeout(() => {
                            indicator.classList.remove('show');
                        }, 3000);
                    }
                }
            }, [autoSaveStatus, t]);
            
            // Основные вычисления
            const linesData=useMemo(()=>lines.map(line=>{
                const base0=line.snapshot?.baseUSD ?? ((line.snapshot?.area||0)*(line.snapshot?.ppsm||0));
                const disc=clamp(+line.discountPct||0,0,20);
                const base=base0*(1-disc/100);
                const prePct=clamp(line.prePct ?? 50, 50, 100); // Ограничение 50-100%
                const k=stagesSumPct===0?0:prePct/stagesSumPct;
                
                const preSchedule=stages.map(s=>({ 
                    month:Math.max(0,Math.min(handoverMonth,Math.round(+s.month||0))), 
                    label:s.label, 
                    amountUSD: base*(((+s.pct||0)*k)/100),
                    realDate: calculateRealDate(s.month, lang)
                })).filter(r=>r.amountUSD>0).sort((a,b)=>a.month-b.month);
                
                const preTotalOne=preSchedule.reduce((s,r)=>s+r.amountUSD,0);
                const vMonths=line.ownTerms && line.months ? line.months : months;
                const rate=(line.ownTerms && line.monthlyRatePct!=null)?(line.monthlyRatePct/100):(monthlyRatePct/100);
                const firstPostUSD=Math.max(0,+line.firstPostUSD||0);
                const principalBase=Math.max(0, base - preTotalOne - firstPostUSD);
                
                let bal=principalBase,totalInterest=0;
                const principalShare=vMonths>0?principalBase/vMonths:0;
                const postRows=[];
                
                for(let i=1;i<=vMonths;i++){
                    const interest=bal*rate;
                    totalInterest+=interest;
                    const payment=principalShare+interest;
                    const realDate = calculateRealDate(handoverMonth + i, lang);
                    postRows.push({
                        month:handoverMonth+i,
                        label:(lang==='ru'?'Месяц ':'Month ')+i,
                        principalUSD:principalShare,
                        interestUSD:interest,
                        paymentUSD:payment,
                        balanceAfterUSD:Math.max(0,bal-principalShare),
                        realDate
                    });
                    bal-=principalShare;
                }
                
                const lineTotalOne=base+totalInterest;
                const qty=Math.max(1,parseInt(line.qty||1,10));
                const preScheduleQ=preSchedule.map(r=>({...r,amountUSD:r.amountUSD*qty}));
                const postRowsQ=postRows.map(r=>({...r,principalUSD:r.principalUSD*qty,interestUSD:r.interestUSD*qty,paymentUSD:r.paymentUSD*qty}));
                const preTotal=preTotalOne*qty;
                const firstPostQ=firstPostUSD*qty;
                const baseQ=base*qty;
                const lineTotal=lineTotalOne*qty;
                
                return {line,qty,baseOne:base,base:baseQ,preSchedule:preScheduleQ,preTotal,firstPostUSD:firstPostQ,postRows:postRowsQ,lineTotal,vMonths,rate,discountPct:disc};
            }),[lines,stages,stagesSumPct,handoverMonth,months,monthlyRatePct,lang]);
            
            const project=useMemo(()=>{
                const totals={
                    baseUSD:linesData.reduce((s,x)=>s+x.base,0),
                    preUSD: linesData.reduce((s,x)=>s+x.preTotal,0),
                    finalUSD:linesData.reduce((s,x)=>s+x.lineTotal,0),
                };
                totals.interestUSD = totals.finalUSD - totals.baseUSD;
                totals.afterUSD = totals.finalUSD - totals.preUSD;
                
                const m=new Map();
                const push=(month,amt,desc)=>{
                    if(amt<=0) return;
                    const prev=m.get(month)||{month,items:[],amountUSD:0};
                    prev.items.push(desc);
                    prev.amountUSD+=amt;
                    m.set(month,prev);
                };
                
                linesData.forEach(ld=>{
                    ld.preSchedule.forEach(r=>
                        push(r.month,r.amountUSD,`${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${r.label}`));
                    if(ld.firstPostUSD>0) 
                        push(handoverMonth+1, ld.firstPostUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${lang==='ru'?'Первый платёж':'First payment'}`);
                    ld.postRows.forEach(r=>
                        push(r.month, r.paymentUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${r.label}`));
                });
                
                const raw=[...m.values()].sort((a,b)=>a.month-b.month);
                let cumulative=0;
                const cashflow=raw.map(row=>{
                    cumulative+=row.amountUSD;
                    const balanceUSD=Math.max(0, totals.finalUSD - cumulative);
                    return {...row,cumulativeUSD:cumulative,balanceUSD, realDate: calculateRealDate(row.month, lang)};
                });
                
                return {totals,cashflow};
            },[linesData,handoverMonth,lang]);
            
            // Графики
            const chartRef=useRef(null);
            const chartObj=useRef(null);
            
            useEffect(()=>{
                try{
                    const ctx=chartRef.current?.getContext('2d');
                    if(!ctx) return;
                    if(chartObj.current) chartObj.current.destroy();
                    
                    chartObj.current=new Chart(ctx,{
                        type:'bar',
                        data:{
                            labels:project.cashflow.map(c=>c.realDate || String(c.month)),
                            datasets:[{
                                label:t.chartTitle,
                                data:project.cashflow.map(c=>toCurrency(c.amountUSD)),
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            }]
                        },
                        options:{
                            responsive:true,
                            plugins:{
                                legend:{display:false},
                                tooltip:{
                                    callbacks:{
                                        label:(c)=>fmtMoney(c.parsed.y,currency)
                                    }
                                }
                            },
                            scales:{
                                y:{
                                    ticks:{
                                        callback:(v)=>fmtMoney(v,currency)
                                    }
                                }
                            }
                        }
                    });
                }catch(e){
                    console.warn('Chart.js error:', e);
                }
            },[project.cashflow,currency,idrPerUsd,eurPerUsd,lang]);
            
            // Функции экспорта
            const exportCSV=()=>{
                const rows=[[t.cashMonth,t.cashDesc,t.cashTotal,t.cashBalance],...project.cashflow.map(c=>[c.realDate || c.month,(c.items||[]).join(' + '),toCurrency(c.amountUSD).toFixed(2),toCurrency(c.balanceUSD).toFixed(2)])];
                const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
                const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
                const a=document.createElement('a');
                a.href=URL.createObjectURL(blob);
                a.download=`arconique_cashflow_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
                URL.revokeObjectURL(a.href);
            };
            
            const exportXLSX=()=>{
                const ws1=XLSX.utils.json_to_sheet(project.cashflow.map(c=>({[t.cashMonth]:c.realDate || c.month,[t.cashDesc]:(c.items||[]).join(' + '),[t.cashTotal]:toCurrency(c.amountUSD),[t.cashBalance]:toCurrency(c.balanceUSD)})));
                const ws2=XLSX.utils.json_to_sheet(linesData.map(ld=>({[t.project]:findProject(ld.line.projectId)?.projectName||ld.line.projectId,[t.villa]:ld.line.snapshot?.name,[t.qty]:ld.qty,[t.area]:ld.line.snapshot?.area,[t.ppsm]:ld.line.snapshot?.ppsm,[t.price]:ld.base,[t.discount]:(ld.discountPct||0)+'%',[t.prePct]:ld.line.prePct,[t.months]:ld.vMonths,[t.lineTotal]:ld.lineTotal})));
                const wb=XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb,ws1,'Cashflow');
                XLSX.utils.book_append_sheet(wb,ws2,'Lines');
                XLSX.writeFile(wb,`arconique_installments_${new Date().toISOString().slice(0,10)}.xlsx`);
            };
            
            // Улучшенная функция экспорта в PDF
            const exportPDF = () => {
                if (!project) return;
                
                const pdfContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>${findProject(lines[0]?.projectId)?.projectName || 'Project'} - Cashflow Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .header h1 { color: #333; margin: 0; }
                            .header .date { color: #666; margin-top: 10px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                            th { background-color: #f5f5f5; font-weight: bold; }
                            .summary { margin: 20px 0; padding: 20px; background: #f9f9f9; }
                            .summary h3 { margin-top: 0; }
                            .amount { font-weight: bold; color: #2c5aa0; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>${findProject(lines[0]?.projectId)?.projectName || 'Project'}</h1>
                            <div class="date">Отчет создан: ${new Date().toLocaleDateString('ru-RU')}</div>
                        </div>
                        <div class="summary">
                            <h3>Сводка проекта</h3>
                            <p><strong>Общая сумма:</strong> <span class="amount">${fmtMoney(project.totals.baseUSD,'USD')}</span></p>
                            <p><strong>Итоговая цена:</strong> <span class="amount">${fmtMoney(project.totals.finalUSD,'USD')}</span></p>
                            <p><strong>Проценты:</strong> <span class="amount">${fmtMoney(project.totals.interestUSD,'USD')}</span></p>
                        </div>
                        <h3>Денежный поток по месяцам</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Месяц</th>
                                    <th>Описание</th>
                                    <th>Сумма к оплате</th>
                                    <th>Остаток долга</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${project.cashflow.map(c => `
                                    <tr>
                                        <td>${c.realDate || c.month}</td>
                                        <td>${(c.items || []).join(' + ')}</td>
                                        <td class="amount">${fmtMoney(c.amountUSD,'USD')}</td>
                                        <td class="amount">${fmtMoney(c.balanceUSD,'USD')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;
                
                const element = document.createElement('div');
                element.innerHTML = pdfContent;
                document.body.appendChild(element);
                
                html2pdf()
                    .from(element)
                    .save(`${findProject(lines[0]?.projectId)?.projectName || 'Project'}-cashflow-${new Date().toISOString().slice(0, 10)}.pdf`)
                    .then(() => {
                        document.body.removeChild(element);
                    });
            };
            
            const findProject=pid=>catalog.find(p=>p.projectId===pid);
            const share=async(view)=>{const url=encodeState(snapshot(),{view}); if(url){await navigator.clipboard.writeText(url); alert(t.shareCopied)}};
            const updLine=(id,patch)=>{setLines(prev=>prev.map(l=>l.id===id?{...l,...patch}:l)); setHasUnsavedChanges(true);};
            const delLine=(id)=>{setLines(prev=>prev.filter(l=>l.id!==id)); setHasUnsavedChanges(true);};
            const dupLine=(id)=>{setLines(prev=>{const src=prev.find(x=>x.id===id); if(!src)return prev; const nid=(prev[prev.length-1]?.id||0)+1; return [...prev,{...src,id:nid,qty:1}]}); setHasUnsavedChanges(true);};
            
            const snapshot=()=>({lang,currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,catalog,lines,tab});
            
            // Загрузка и сохранение
            useEffect(()=>{(async()=>{
                try{
                    const fromUrl=decodeState();
                    const saved=fromUrl?.state || JSON.parse(localStorage.getItem('arconique_v81')||'null');
                    if(saved){
                        if(saved.lang) setLang(saved.lang);
                        if(saved.currency) setCurrency(saved.currency);
                        if(typeof saved.idrPerUsd==='number') setIdrPerUsd(saved.idrPerUsd);
                        if(typeof saved.eurPerUsd==='number') setEurPerUsd(saved.eurPerUsd);
                        if(typeof saved.handoverMonth==='number') setHandoverMonth(saved.handoverMonth);
                        if(typeof saved.months==='number') setMonths(saved.months);
                        if(typeof saved.monthlyRatePct==='number') setMonthlyRatePct(saved.monthlyRatePct);
                        if(Array.isArray(saved.stages)) setStages(saved.stages);
                        if(Array.isArray(saved.catalog)) setCatalog(saved.catalog);
                        if(Array.isArray(saved.lines)) setLines(saved.lines);
                        if(saved.tab) setTab(saved.tab);
                    }
                    
                    const view=(fromUrl?.view)|| (new URLSearchParams(location.hash.slice(1)).get('view'));
                    if(view==='editor'){
                        const ok=await verifyPinFlow();
                        setIsClient(!ok);
                        if(!ok){
                            const url=encodeState(snapshot(),{view:'client'});
                            if(url) history.replaceState(null,'',url);
                            alert(lang==='ru'?'Неверный PIN — открыт клиентский режим':'Wrong PIN — opened client view');
                        }
                    }else setIsClient(true);
                }catch(e){
                    console.error(e);
                }
                
                document.getElementById('app-title').textContent=t.title;
                document.title=t.title;
            })()},[]);
            
            useEffect(()=>{ 
                localStorage.setItem('arconique_v81',JSON.stringify(snapshot())); 
                document.getElementById('app-title').textContent=t.title; 
                document.title=t.title; 
            },[lang,currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,catalog,lines,tab]);

                    // Компонент KPI блока с отображением валюты
            function KPIBlock({isClient, t, totals, currency, toCurrency}){
                const getCurrencySymbol = (curr) => {
                    switch(curr) {
                        case 'USD': return '$';
                        case 'IDR': return 'Rp';
                        case 'EUR': return '€';
                        default: return '$';
                    }
                };
                
                const currencySymbol = getCurrencySymbol(currency);
                
                return (
                    <div className="kpis">
                        <div className="kpi animate-fade-in">
                            <span className="muted">{t.base}</span>
                            <div className="v">{currencySymbol} {toCurrency(totals.baseUSD).replace(/[^\d,.-]/g, '')}</div>
                        </div>
                        <div className="kpi animate-fade-in" style={{animationDelay: '0.1s'}}>
                            <span className="muted">{t.prepay}</span>
                            <div className="v">{currencySymbol} {toCurrency(totals.preUSD).replace(/[^\d,.-]/g, '')}</div>
                        </div>
                        <div className="kpi animate-fade-in" style={{animationDelay: '0.2s'}}>
                            <span className="muted">{t.after}</span>
                            <div className="v">{currencySymbol} {toCurrency(totals.afterUSD).replace(/[^\d,.-]/g, '')}</div>
                        </div>
                        <div className="kpi animate-fade-in" style={{animationDelay: '0.3s'}}>
                            <span className="muted">{t.interestTotal}</span>
                            <div className="v">{currencySymbol} {toCurrency(totals.interestUSD).replace(/[^\d,.-]/g, '')}</div>
                        </div>
                        <div className="kpi animate-fade-in" style={{animationDelay: '0.4s'}}>
                            <span className="muted">{t.final}</span>
                            <div className="v">{currencySymbol} {toCurrency(totals.finalUSD).replace(/[^\d,.-]/g, '')}</div>
                        </div>
                    </div>
                );
            }
            
            return (
                <>
                    <div className="grid">
                        <div className="card">
                            {!isClient && (
                                <div className="smart-tabs">
                                    <button className={`smart-tab ${tab==='overview'?'active':''}`} onClick={()=>setTab('overview')}>
                                        <span className="tab-icon">📊</span>
                                        <span className="tab-label">{t.overview}</span>
                                        <span className="tab-counter">{lines.length}</span>
                                    </button>
                                    <button className={`smart-tab ${tab==='stages'?'active':''}`} onClick={()=>setTab('stages')}>
                                        <span className="tab-icon">📅</span>
                                        <span className="tab-label">{t.stages}</span>
                                        <span className="tab-counter">{stages.length}</span>
                                    </button>
                                </div>
                            )}
                            
                            {/* Основные настройки */}
                            <div className="settings-group">
                                <div className="settings-header" onClick={() => toggleGroup('basic')}>
                                    <span className="group-icon">⚙️</span>
                                    <span className="group-title">{t.settings}</span>
                                    <span className="group-toggle">{expandedGroups.basic ? '−' : '+'}</span>
                                </div>
                                <div className={`settings-content ${expandedGroups.basic ? 'expanded' : ''}`}>
                                    <div className="row">
                                        <div className="field compact">
                                            <label>{t.lang}</label>
                                            <select value={lang} onChange={e=>setLang(e.target.value)}>
                                                <option value="ru">Русский</option>
                                                <option value="en">English</option>
                                            </select>
                                        </div>
                                        <div className="field compact">
                                            <label>{t.currencyDisplay}</label>
                                            <select value={currency} onChange={e=>setCurrency(e.target.value)}>
                                                <option>USD</option>
                                                <option>IDR</option>
                                                <option>EUR</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    {!isClient && (
                                        <div className="row">
                                            <div className="field compact">
                                                <label>{t.idrRate}</label>
                                                <input type="number" min="1" step="1" value={idrPerUsd} onChange={e=>setIdrPerUsd(clamp(parseFloat(e.target.value||0),1,1e9))}/>
                                            </div>
                                            <div className="field compact">
                                                <label>{t.eurRate}</label>
                                                <input type="number" min="0.01" step="0.01" value={eurPerUsd} onChange={e=>setEurPerUsd(clamp(parseFloat(e.target.value||0),0.01,100))}/>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="row">
                                        <div className="field compact">
                                            <label>{t.handoverMonth}</label>
                                            <input type="number" min="1" step="1" value={handoverMonth} onChange={e=>setHandoverMonth(clamp(parseInt(e.target.value||0,10),1,120))}/>
                                        </div>
                                        {!isClient ? (
                                            <>
                                                <div className="field compact">
                                                    <label>{t.globalRate}</label>
                                                    <input type="number" min="0" step="0.01" value={monthlyRatePct} onChange={e=>setMonthlyRatePct(clamp(parseFloat(e.target.value||0),0,1000))}/>
                                                </div>
                                                <div className="field compact">
                                                    <label>{t.globalTerm}</label>
                                                    <input type="range" min="6" max="24" step="1" value={months} onChange={e=>setMonths(parseInt(e.target.value,10))}/>
                                                    <div className="pill">{t.months}: {months}</div>
                                                </div>
                                            </>
                                        ) : (
                                            <div className="field compact">
                                                <label>{t.clientTerm}</label>
                                                <input type="number" min="6" step="1" value={months} onChange={e=>setMonths(clamp(parseInt(e.target.value||0,10),6,120))}/>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Этапы */}
                            {tab === 'stages' && (
                                <div className="settings-group">
                                    <div className="settings-header" onClick={() => toggleGroup('stages')}>
                                        <span className="group-icon">📅</span>
                                        <span className="group-title">{t.stagesTitle}</span>
                                        <span className="group-toggle">{expandedGroups.stages ? '−' : '+'}</span>
                                    </div>
                                    <div className={`settings-content ${expandedGroups.stages ? 'expanded' : ''}`}>
                                        <div className="scroll" style={{maxHeight:'26vh',border:'1px dashed #223',borderRadius:'8px',padding:'6px',marginBottom:'var(--spacing-lg)'}}>
                                            <table className="stages-table">
                                                <thead>
                                                    <tr>
                                                        <th className="col-stage">{t.stage}</th>
                                                        <th className="col-percent">{t.percent}</th>
                                                        <th className="col-month">{t.month}</th>
                                                        <th className="col-actions"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {stages.map(s=>(
                                                        <tr key={s.id}>
                                                            <td className="col-stage">
                                                                <input type="text" className="stage-input" value={s.label} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,label:e.target.value}:x))} />
                                                            </td>
                                                            <td className="col-percent">
                                                                <input type="number" className="stage-number-input" min="0" max="100" step="0.01" value={s.pct} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,pct:clamp(parseFloat(e.target.value||0),0,100)}:x))} />
                                                            </td>
                                                            <td className="col-month">
                                                                <input type="number" className="stage-number-input" min="0" step="1" value={s.month} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,month:clamp(parseInt(e.target.value||0,10),0,handoverMonth),realDate:calculateRealDate(clamp(parseInt(e.target.value||0,10),0,handoverMonth), lang)}:x))} />
                                                            </td>
                                                            <td className="col-actions">
                                                                <div className="stage-actions">
                                                                    <button className="delete-stage-btn" onClick={()=>setStages(prev=>prev.filter(x=>x.id!==s.id))}>
                                                                        {t.delete}
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <div className="row" style={{marginTop:8,alignItems:'center',justifyContent:'space-between'}}>
                                            <button className="btn primary" onClick={()=>setStages(prev=>{const last=prev[prev.length-1];const id=(last?.id||0)+1;const nextMonth=Math.min(handoverMonth,(last?.month??0)+1);return [...prev,{id,label:(lang==='ru'?'Этап':'Stage'),pct:5,month:nextMonth,realDate:calculateRealDate(nextMonth, lang)}]})}>
                                                {t.addStage}
                                            </button>
                                            {(() => {
                                                const vals=lines.map(l=>l.prePct||0);
                                                const allSame=vals.length?vals.every(v=>v===vals[0]):true;
                                                const targetText=allSame?`${vals[0]||0}%`:`${Math.min(...vals||[0])}%–${Math.max(...vals||[0])}%`;
                                                const mismatch=allSame ? (Math.round(stagesSumPct*100)/100!==(vals[0]||0)) : true;
                                                return <div className={`hint ${mismatch?'warn':''}`}>{t.sumStages}: {Math.round(stagesSumPct*100)/100}% · {t.targetPrepay}: {targetText} {mismatch? (allSame? ` ${t.mismatch}` : ` (${t.mixedTargets})`) : ''}</div>;
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <div className="hr"></div>
                            
                            {/* Кнопки действий */}
                            <div className="row" style={{justifyContent:'space-between',alignItems:'center'}}>
                                <div className="row" style={{gap:'var(--spacing-md)'}}>
                                    {!isClient && (
                                        <>
                                            <button className="btn" onClick={undo} disabled={currentIndex <= 0}>↶ {t.undo}</button>
                                            <button className="btn" onClick={redo} disabled={currentIndex >= history.length - 1}>↷ {t.redo}</button>
                                        </>
                                    )}
                                </div>
                                
                                <div className="row" style={{gap:'var(--spacing-md)'}}>
                                    {!isClient && (
                                        <>
                                            <button className="btn primary" onClick={()=>share('editor')}>{t.share} ({t.editor})</button>
                                            <button className="btn" onClick={()=>share('client')}>{t.share} ({t.client})</button>
                                        </>
                                    )}
                                    {isClient && <button className="btn" onClick={()=>share('client')}>{t.share}</button>}
                                </div>
                            </div>
                        </div>
                        
                        <div className="card">
                            <div className="row" style={{justifyContent:'space-between',alignItems:'baseline'}}>
                                <div className="row">
                                    <span className="badge">{t.lines}: {lines.length}</span>
                                    <span className="badge">{t.keys} {handoverMonth}</span>
                                    {!isClient && <span className="badge">{t.months}: {months}</span>}
                                </div>
                                <div className="muted">{isClient ? t.client : t.editor}</div>
                            </div>
                            
                            <KPIBlock isClient={isClient} t={t} totals={project.totals} currency={currency} toCurrency={toCurrency}/>
                            
                            <div className="hr"></div>
                            
                            {/* Заголовок расчета с кнопкой */}
                            <div className="calculation-header">
                                <h3 style={{margin:'6px 0'}}>{t.villasTitle}</h3>
                                {!isClient && <button className="btn success" onClick={()=>setModalOpen(true)}>{t.addFromCatalog}</button>}
                            </div>
                            
                            <div className="calc-scroll">
                                <table className="calc-table">
                                    <thead>
                                        <tr>
                                            <th className="col-project">{t.project}</th>
                                            <th className="col-villa">{t.villa}</th>
                                            <th className="col-qty">{t.qty}</th>
                                            <th className="col-area">{t.area}</th>
                                            <th className="col-ppsm">{t.ppsm}</th>
                                            <th className="col-base">{t.price}</th>
                                            {!isClient && <th className="col-disc">{t.discount}</th>}
                                            <th className="col-pre">{t.prePct}</th>
                                            {!isClient && <th className="col-months">{t.months}</th>}
                                            {!isClient && <th className="col-rate">{t.rate}</th>}
                                            <th className="col-first">{t.firstPost}</th>
                                            <th className="col-lineTotal">{t.lineTotal}</th>
                                            <th className="col-actions"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {linesData.map(ld=>{
                                            const projName=findProject(ld.line.projectId)?.projectName || ld.line.projectId;
                                            return (
                                                <tr key={ld.line.id}>
                                                    <td className="col-project">
                                                        <div className="project-name-display">{projName}</div>
                                                    </td>
                                                    <td className="col-villa">
                                                        <div className="villa-name-display">{ld.line.snapshot?.name}</div>
                                                    </td>
                                                    <td className="col-qty">
                                                        <input type="number" min="1" step="1" value={ld.qty} onChange={e=>updLine(ld.line.id,{qty:clamp(parseInt(e.target.value||0,10),1,1000)})} style={{width:'60px',textAlign:'center'}} />
                                                    </td>
                                                    <td className="col-area">
                                                        <div className="area-display">{ld.line.snapshot?.area}</div>
                                                    </td>
                                                    <td className="col-ppsm">
                                                        <div className="ppsm-display">{ld.line.snapshot?.ppsm}</div>
                                                    </td>
                                                    <td className="col-base">
                                                        <div className="base-strong">{fmtMoney(ld.base,'USD')}</div>
                                                    </td>
                                                    {!isClient && (
                                                        <td className="col-disc">
                                                            <input type="number" min="0" max="20" step="0.1" value={ld.line.discountPct||0} onChange={e=>updLine(ld.line.id,{discountPct:clamp(parseFloat(e.target.value||0),0,20)})} style={{width:'60px',textAlign:'center'}} />
                                                        </td>
                                                    )}
                                                    <td className="col-pre">
                                                        <input type="number" min="50" max="100" step="0.1" value={ld.line.prePct||70} onChange={e=>updLine(ld.line.id,{prePct:clamp(parseFloat(e.target.value||0),50,100)})} style={{width:'60px',textAlign:'center'}} />
                                                    </td>
                                                    {!isClient && (
                                                        <td className="col-months">
                                                            <input type="number" min="6" max="120" step="1" value={ld.vMonths} onChange={e=>updLine(ld.line.id,{months:clamp(parseInt(e.target.value||0,10),6,120)})} style={{width:'60px',textAlign:'center'}} />
                                                        </td>
                                                    )}
                                                    {!isClient && (
                                                        <td className="col-rate">
                                                            <input type="number" min="0" max="100" step="0.01" value={ld.line.ownTerms && ld.line.monthlyRatePct!=null ? ld.line.monthlyRatePct : monthlyRatePct} onChange={e=>updLine(ld.line.id,{monthlyRatePct:clamp(parseFloat(e.target.value||0),0,100)})} style={{width:'60px',textAlign:'center'}} />
                                                        </td>
                                                    )}
                                                    <td className="col-first">
                                                        <input type="number" min="0" step="1" value={ld.line.firstPostUSD||0} onChange={e=>updLine(ld.line.id,{firstPostUSD:clamp(parseFloat(e.target.value||0),0,ld.base)})} style={{width:'80px',textAlign:'center'}} />
                                                    </td>
                                                    <td className="col-lineTotal">
                                                        <div className="line-total">{fmtMoney(ld.lineTotal,'USD')}</div>
                                                    </td>
                                                    <td className="col-actions">
                                                        <div style={{display:'flex',gap:'4px',justifyContent:'center'}}>
                                                            <button className="btn icon" onClick={()=>dupLine(ld.line.id)} title="Дублировать">📋</button>
                                                            <button className="btn danger icon" onClick={()=>delLine(ld.line.id)} title="Удалить">✕</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="hr"></div>
                            
                            {/* Кэшфлоу */}
                            <h3 style={{margin:'6px 0'}}>{t.cashflowTitle}</h3>
                            <div className="scroll" style={{maxHeight:'30vh'}}>
                                <table className="cashflow-table">
                                    <thead>
                                        <tr>
                                            <th>{t.cashMonth}</th>
                                            <th>{t.cashDesc}</th>
                                            <th>{t.cashTotal}</th>
                                            <th>{t.cashBalance}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {project.cashflow.map(c=>(
                                            <tr key={c.month}>
                                                <td>{c.realDate || c.month}</td>
                                                <td style={{textAlign:'left'}}>{(c.items||[]).join(' + ')}</td>
                                                <td>{toCurrency(c.amountUSD)}</td>
                                                <td>{toCurrency(c.balanceUSD)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="hr"></div>
                            
                            {/* График */}
                            <h3 style={{margin:'6px 0'}}>{t.chartTitle}</h3>
                            <div style={{height:'300px',position:'relative'}}>
                                <canvas ref={chartRef} />
                            </div>
                            
                            <div className="hr"></div>
                            
                            {/* Экспорт */}
                            <div className="row" style={{justifyContent:'center',gap:'var(--spacing-md)'}}>
                                <button className="btn" onClick={exportCSV}>{t.exportCSV}</button>
                                <button className="btn" onClick={exportXLSX}>{t.exportXLSX}</button>
                                <button className="btn primary" onClick={exportPDF}>{t.exportPDF}</button>
                            </div>
                        </div>
                    </div>
                    
                    {/* Каталог проектов и вилл - перемещен вниз на всю ширину */}
                    {!isClient && (
                        <div className="full-width-block">
                            <div className="card">
                                <h3 style={{margin:'6px 0'}}>{t.catalogTitle}</h3>
                                
                                <div className="row" style={{gap:'var(--spacing-md)'}}>
                                    <button className="btn success" onClick={addProject}>{t.addProject}</button>
                                    <button className="btn" onClick={()=>{
                                        const json=prompt('Paste catalog JSON:', JSON.stringify(catalog,null,2));
                                        if(!json) return;
                                        try{
                                            const obj=JSON.parse(json);
                                            if(Array.isArray(obj)) setCatalog(obj);
                                            else alert('Invalid JSON');
                                        }catch{
                                            alert('Invalid JSON');
                                        }
                                    }}>{t.importJSON}</button>
                                    <button className="btn" onClick={()=>{
                                        const blob=new Blob([JSON.stringify(catalog,null,2)],{type:'application/json'});
                                        const a=document.createElement('a');
                                        a.href=URL.createObjectURL(blob);
                                        a.download=`arconique_catalog_${new Date().toISOString().slice(0,10)}.json`;
                                        a.click();
                                        URL.revokeObjectURL(a.href);
                                    }}>{t.exportJSON}</button>
                                </div>
                                
                                <div className="scroll" style={{maxHeight:'32vh'}}>
                                    {catalog.map(p=>(
                                        <div key={p.projectId} className="catalog-card">
                                            <div className="catalog-header">
                                                <div className="row" style={{flex:1}}>
                                                    <span className="badge">{t.project}:</span>
                                                    <input type="text" value={p.projectName} onChange={e=>setCatalog(prev=>prev.map(x=>x.projectId===p.projectId?{...x,projectName:e.target.value}:x))} style={{flex:1,marginRight:8}} />
                                                    <span className="pill">{p.projectId}</span>
                                                </div>
                                                <div className="catalog-actions">
                                                    <button className="btn primary" onClick={()=>addVilla(p.projectId)}>{t.addVilla}</button>
                                                    <button className="btn danger" onClick={()=>{
                                                        if(confirm(t.remove + ' ' + p.projectName + '?')) {
                                                            setCatalog(prev=>prev.filter(x=>x.projectId!==p.projectId));
                                                        }
                                                    }}>{t.remove}</button>
                                                </div>
                                            </div>
                                            
                                            <table className="catalog-table">
                                                <thead>
                                                    <tr>
                                                        <th style={{textAlign:'left'}}>{t.villa}</th>
                                                        <th>{t.area}</th>
                                                        <th>{t.ppsm}</th>
                                                        <th>{t.price}</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {p.villas.map(v=>(
                                                        <tr key={v.villaId}>
                                                            <td style={{textAlign:'left'}}>
                                                                <input value={v.name} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,name:e.target.value}:vv)}:pr))} />
                                                                <div className="muted" style={{fontSize:10}}>{v.villaId}</div>
                                                            </td>
                                                            <td>
                                                                <input type="number" min="1" step="0.1" value={v.area} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,area:clamp(parseFloat(e.target.value||0),1,100000)}:vv)}:pr))} />
                                                            </td>
                                                            <td>
                                                                <input type="number" min="0" step="1" value={v.ppsm} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,ppsm:clamp(parseFloat(e.target.value||0),0,1e9)}:vv)}:pr))} />
                                                            </td>
                                                            <td>
                                                                <input type="number" min="0" step="1" value={v.baseUSD} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,baseUSD:clamp(parseFloat(e.target.value||0),0,1e12)}:vv)}:pr))} />
                                                            </td>
                                                            <td>
                                                                <button className="btn danger icon" onClick={()=>{
                                                                    if(confirm(t.remove + ' ' + v.name + '?')) {
                                                                        setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.filter(vv=>vv.villaId!==v.villaId)}:pr));
                                                                    }
                                                                }}> ✕ </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Модальные окна */}
                    {showAddProjectModal && (
                        <div className="modal-overlay" onClick={() => setShowAddProjectModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{t.addProject}</h3>
                                    <button className="btn icon" onClick={() => setShowAddProjectModal(false)}>✕</button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-section">
                                        <h4>{t.projectName}</h4>
                                        <div className="form-group">
                                            <input type="text" value={newProjectForm.projectName} onChange={e => setNewProjectForm(prev => ({...prev, projectName: e.target.value}))} placeholder={t.projectName} />
                                        </div>
                                    </div>
                                    <div className="form-actions">
                                        <button className="btn" onClick={() => setShowAddProjectModal(false)}>{t.cancel}</button>
                                        <button className="btn primary" onClick={saveProject}>{t.save}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showAddVillaModal && (
                        <div className="modal-overlay" onClick={() => setShowAddVillaModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{t.addVilla}</h3>
                                    <button className="btn icon" onClick={() => setShowAddVillaModal(false)}>✕</button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-section">
                                        <h4>{t.villaName}</h4>
                                        <div className="form-group">
                                            <input type="text" value={newVillaForm.name} onChange={e => setNewVillaForm(prev => ({...prev, name: e.target.value}))} placeholder={t.villaName} />
                                        </div>
                                    </div>
                                    <div className="form-section">
                                        <h4>{t.villaArea}</h4>
                                        <div className="form-group">
                                            <input type="number" min="1" step="0.1" value={newVillaForm.area} onChange={e => setNewVillaForm(prev => ({...prev, area: parseFloat(e.target.value) || 0}))} />
                                        </div>
                                    </div>
                                    <div className="form-section">
                                        <h4>{t.villaPpsm}</h4>
                                        <div className="form-group">
                                            <input type="number" min="0" step="1" value={newVillaForm.ppsm} onChange={e => setNewVillaForm(prev => ({...prev, ppsm: parseFloat(e.target.value) || 0}))} />
                                        </div>
                                    </div>
                                    <div className="form-actions">
                                        <button className="btn" onClick={() => setShowAddVillaModal(false)}>{t.cancel}</button>
                                        <button className="btn primary" onClick={saveVilla}>{t.save}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Модальное окно выбора из каталога */}
                    {modalOpen && (
                        <div className="modal-overlay" onClick={() => setModalOpen(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{t.selectFromCatalog}</h3>
                                    <button className="btn icon" onClick={() => setModalOpen(false)}>✕</button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-section">
                                        <h4>{t.search}</h4>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>{t.areaFrom}</label>
                                                <input type="number" min="0" step="1" placeholder="0" />
                                            </div>
                                            <div className="form-group">
                                                <label>{t.areaTo}</label>
                                                <input type="number" min="0" step="1" placeholder="1000" />
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>{t.priceFrom}</label>
                                                <input type="number" min="0" step="1000" placeholder="0" />
                                            </div>
                                            <div className="form-group">
                                                <label>{t.priceTo}</label>
                                                <input type="number" min="0" step="1000" placeholder="1000000" />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="form-actions">
                                        <button className="btn" onClick={() => setModalOpen(false)}>{t.cancel}</button>
                                        <button className="btn primary">{t.addSelected}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Мобильная навигация */}
                    <div className="mobile-nav" style={{display: window.innerWidth <= 768 ? 'flex' : 'none'}}>
                        <button className={`mobile-nav-btn ${tab === 'overview' ? 'active' : ''}`} onClick={() => setTab('overview')}>
                            📊
                            <span>{t.overview}</span>
                        </button>
                        <button className={`mobile-nav-btn ${tab === 'stages' ? 'active' : ''}`} onClick={() => setTab('stages')}>
                            📅
                            <span>{t.stages}</span>
                        </button>
                    </div>
                </>
            );
        }
        
        // Рендер приложения
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

