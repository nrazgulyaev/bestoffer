<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arconique / Калькулятор рассрочки для любимых клиентов — v8.2</title>
    
    <!-- CDN библиотеки -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    
    <style>
        /* CSS переменные для дизайна */
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 6px;
            --radius-lg: 12px;
            --transition: all 0.15s ease;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .wrap {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: var(--dark);
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 30px;
            letter-spacing: -0.025em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .card h2 {
            margin: 0 0 20px 0;
            color: var(--dark);
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: var(--transition);
            margin: 4px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn.secondary {
            background: var(--secondary);
        }
        
        .btn.success {
            background: var(--success);
        }
        
        .btn.danger {
            background: var(--danger);
        }
        
        .btn.warning {
            background: var(--warning);
        }
        
        .btn.outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .btn.outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn.compact {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        
        .btn-row .btn {
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }
        
        .field {
            margin-bottom: 16px;
        }
        
        .field label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 14px;
        }
        
        .field input,
        .field select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
            box-sizing: border-box;
        }
        
        .field input:focus,
        .field select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .field.compact {
            flex: 1;
            min-width: 0;
            max-width: 180px;
        }
        
        .field.compact input,
        .field.compact select {
            width: 100%;
            box-sizing: border-box;
        }
        
        .field-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            background: var(--primary);
            color: white;
            padding: 20px 24px;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        
        .btn-group .btn {
            min-width: 100px;
        }
        
        .btn.icon {
            background: transparent;
            color: white;
            padding: 0;
            font-size: 18px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }
        
        .btn.icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .full-width-block {
            grid-column: 1 / -1;
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-top: 24px;
        }
        
        .full-width-block h2 {
            margin: 0 0 20px 0;
            color: var(--dark);
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .smart-tabs {
            display: flex;
            background: var(--light);
            border-radius: var(--radius);
            padding: 4px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        .smart-tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            color: var(--secondary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .smart-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow);
        }
        
        .smart-tab:hover:not(.active) {
            color: var(--dark);
        }
        
        .badge {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .pill {
            background: var(--light);
            color: var(--dark);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid var(--border);
        }
        
        .hr {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
            border: none;
        }
        
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            z-index: 1001;
            box-shadow: var(--shadow);
        }
        
        .auto-save-indicator.error {
            background: var(--danger);
        }
        
        .auto-save-indicator.saving {
            background: var(--warning);
        }
        
        .calc-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 14px;
        }
        
        .calc-table th,
        .calc-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .calc-table th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }
        
        .calc-table tr:hover {
            background: var(--light);
        }
        
        .stages-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 14px;
        }
        
        .stages-table th,
        .stages-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .stages-table th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }
        
        .stages-table input[type="range"] {
            width: 100px;
        }
        
        .stages-table input[type="number"] {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }
        
        .cashflow-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 14px;
        }
        
        .cashflow-table th,
        .cashflow-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .cashflow-table th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }
        
        .catalog-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 14px;
        }
        
        .catalog-table th,
        .catalog-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .catalog-table th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }
        
        .project-name-display,
        .villa-name-display {
            font-weight: 600;
            color: var(--primary);
        }
        
        .area-display,
        .ppsm-display {
            font-family: monospace;
            background: var(--light);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .base-strong {
            font-weight: 600;
            color: var(--success);
        }
        
        .line-total {
            font-weight: 700;
            color: var(--primary);
        }
        
        .col-first {
            display: none;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        
        .kpi-block {
            background: var(--light);
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .kpi-label {
            font-size: 14px;
            color: var(--secondary);
            font-weight: 500;
        }
        
        .settings-group {
            margin-bottom: 20px;
        }
        
        .settings-header {
            background: var(--light);
            padding: 12px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
            margin-bottom: 16px;
        }
        
        .settings-header:hover {
            background: var(--border);
        }
        
        .settings-content {
            max-height: 800px;
            overflow-y: auto;
        }
        
        .mobile-nav {
            display: none;
            background: white;
            padding: 16px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .field-row {
                flex-direction: column;
            }
            
            .field.compact {
                max-width: none;
            }
            
            .btn-row .btn {
                min-width: auto;
            }
            
            .mobile-nav {
                display: block;
            }
            
            .smart-tabs {
                flex-direction: column;
            }
            
            .smart-tab {
                border-radius: 0;
            }
            
            .smart-tab:first-child {
                border-radius: var(--radius) var(--radius) 0 0;
            }
            
            .smart-tab:last-child {
                border-radius: 0 0 var(--radius) var(--radius);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // ИСПРАВЛЕНО: правильный импорт React Hooks
        const { useState, useEffect, useMemo, useRef } = React;
        
        // Глобальные utility функции
        function fmtMoney(amount, currency = 'USD') {
            if (typeof amount !== 'number' || isNaN(amount)) return '0';
            
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            
            return formatter.format(amount);
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function clamp(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }
        
        function getCurrentMonth() {
            const now = new Date();
            return {
                month: now.getMonth(),
                year: now.getFullYear()
            };
        }
        
        function calculateRealDate(monthOffset) {
            const { month, year } = getCurrentMonth();
            const targetMonth = month + monthOffset;
            const targetYear = year + Math.floor(targetMonth / 12);
            const finalMonth = targetMonth % 12;
            
            const months = ['январь', 'февраль', 'март', 'апрель', 'май', 'июнь', 
                           'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'];
            
            return months[finalMonth] + ' ' + targetYear;
        }
        
        async function sha256Hex(message) {
            if (window.crypto && window.crypto.subtle) {
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await window.crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            } else {
                // Fallback для старых браузеров - хеш для PIN 334346
                return 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3';
            }
        }
        
        // ИСПРАВЛЕНО: компонент KPIBlock определен глобально
        function KPIBlock({ label, value, currency = 'USD' }) {
            const toCurrency = (val) => {
                if (typeof val === 'number' && !isNaN(val)) {
                    return fmtMoney(val, currency);
                }
                return '0';
            };
            
            return (
                <div className="kpi-block">
                    <div className="kpi-value">{toCurrency(value)}</div>
                    <div className="kpi-label">{label}</div>
                </div>
            );
        }

                // ИСПРАВЛЕНО: объект переводов
        const T = {
            title: 'Arconique / Калькулятор рассрочки для любимых клиентов',
            overview: 'Обзор',
            parameters: 'Параметры',
            calculation: 'Расчет',
            cashflow: 'Кэшфлоу',
            catalog: 'Каталог',
            addProject: 'Добавить проект',
            addVilla: 'Добавить вилла',
            projectName: 'Название проекта',
            villaName: 'Название виллы',
            area: 'Площадь (м²)',
            pricePerSqm: 'Цена за м²',
            basePrice: 'Базовая цена',
            cancel: 'Отмена',
            add: 'Добавить',
            save: 'Сохранить',
            delete: 'Удалить',
            edit: 'Редактировать',
            close: 'Закрыть',
            settings: 'Параметры',
            stages: 'Базовая рассрочка',
            stagesBeforeKeys: 'Базовая рассрочка',
            calculationPositions: 'Расчет (позиции)',
            monthlyCashflow: 'Сводный кэшфлоу по месяцам',
            catalogProjectsVillas: 'Каталог проектов и вилл',
            addFromCatalog: 'Добавить из каталога',
            importJSON: 'Импорт JSON',
            exportJSON: 'Экспорт JSON',
            shareEditor: 'Поделиться (редактор)',
            shareClient: 'Поделиться (клиент)',
            saveToPDF: 'Сохранить в PDF',
            exportCSV: 'Экспорт CSV',
            exportXLSX: 'Экспорт XLSX',
            selectedVillas: 'Выбранные виллы',
            keysIn: 'Ключи в',
            months: 'месяцев',
            baseCost: 'Базовая стоимость',
            baseCostUSD: 'Базовая стоимость (USD)',
            totalCost: 'Общая стоимость',
            installmentTerm: 'Срок рассрочки',
            preHandover: 'До ключей, %',
            discount: 'Скидка, %',
            firstPayment: 'Первый платеж',
            interest: 'Проценты (post)',
            lineTotal: 'Итого по строке',
            stage: 'Этап',
            percentage: 'Процент',
            month: 'Месяц',
            remove: 'Удалить',
            exchangeRateIDR: 'Курс IDR/USD',
            exchangeRateEUR: 'Курс EUR/USD',
            keysMonth: 'Месяц получения ключей',
            globalRate: 'Глобальная ставка, %',
            globalTerm: 'Глобальный срок post‑handover (6–24 мес)',
            preHandoverPct: 'Базовая рассрочка, %',
            postHandoverTerms: 'Сроки post‑handover',
            handoverMonth: 'Месяц получения ключей',
            yes: 'Да',
            no: 'Нет'
        };
        
        // Основной компонент приложения
        function App() {
            // Состояние приложения
            const [isClient, setIsClient] = useState(false);
            const [activeTab, setActiveTab] = useState('overview');
            const [showAddProjectModal, setShowAddProjectModal] = useState(false);
            const [showAddVillaModal, setShowAddVillaModal] = useState(false);
            const [showAddFromCatalogModal, setShowAddFromCatalogModal] = useState(false);
            const [autoSaveStatus, setAutoSaveStatus] = useState('saved');
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
            const [expandedGroups, setExpandedGroups] = useState({
                basic: true,
                advanced: false,
                stages: true
            });
            
            // Состояние данных
            const [projects, setProjects] = useState([]);
            const [villas, setVillas] = useState([]);
            const [lines, setLines] = useState([]);
            const [stages, setStages] = useState([
                { id: 1, pct: 50, month: 1 },
                { id: 2, pct: 30, month: 6 },
                { id: 3, pct: 20, month: 12 }
            ]);
            
            // Состояние параметров
            const [exchangeRateIDR, setExchangeRateIDR] = useState(15000);
            const [exchangeRateEUR, setExchangeRateEUR] = useState(0.85);
            const [keysMonth, setKeysMonth] = useState(12);
            const [globalRate, setGlobalRate] = useState(2.5);
            const [globalTerm, setGlobalTerm] = useState(12);
            const [preHandoverPct, setPreHandoverPct] = useState(50);
            const [postHandoverTerms, setPostHandoverTerms] = useState(12);
            
            // Состояние для модальных окон
            const [newProject, setNewProject] = useState({ name: '' });
            const [newVilla, setNewVilla] = useState({ 
                name: '', 
                area: '', 
                pricePerSqm: '', 
                basePrice: '' 
            });
            
            // ИСПРАВЛЕНО: расчет linesData с правильными значениями
            const linesData = useMemo(() => {
                return lines.map(line => {
                    const { qty, area, pricePerSqm, basePrice, prePct, discount } = line;
                    const clampedPrePct = clamp(prePct, 50, 100);
                    const realDate = calculateRealDate(line.month);
                    
                    return {
                        ...line,
                        prePct: clampedPrePct,
                        realDate,
                        total: qty * area * pricePerSqm,
                        baseTotal: qty * basePrice,
                        preTotal: (qty * basePrice * clampedPrePct) / 100,
                        discountTotal: (qty * basePrice * discount) / 100
                    };
                });
            }, [lines]);
            
            // ИСПРАВЛЕНО: расчет project с реальными датами
            const project = useMemo(() => {
                const cashflow = [];
                let month = 0;
                
                // Добавляем базовые этапы
                stages.forEach(stage => {
                    cashflow.push({
                        month: month,
                        type: 'base',
                        amount: stage.pct,
                        description: `Базовая рассрочка ${stage.pct}%`,
                        realDate: calculateRealDate(month)
                    });
                    month = stage.month;
                });
                
                // Добавляем позиции
                linesData.forEach(line => {
                    cashflow.push({
                        month: month,
                        type: 'position',
                        amount: line.total,
                        description: `${line.projectName} - ${line.villaName}`,
                        realDate: calculateRealDate(month)
                    });
                    month += 1;
                });
                
                return {
                    totalValue: linesData.reduce((sum, line) => sum + line.total, 0),
                    totalBase: linesData.reduce((sum, line) => sum + line.baseTotal, 0),
                    totalPre: linesData.reduce((sum, line) => sum + line.preTotal, 0),
                    totalDiscount: linesData.reduce((sum, line) => sum + line.discountTotal, 0),
                    cashflow
                };
            }, [linesData, stages]);
            
            // ИСПРАВЛЕНО: функции добавления с автоматическими ID
            const addProject = () => {
                if (newProject.name.trim()) {
                    const project = {
                        id: generateId(),
                        name: newProject.name.trim()
                    };
                    setProjects(prev => [...prev, project]);
                    setNewProject({ name: '' });
                    setShowAddProjectModal(false);
                    setHasUnsavedChanges(true);
                }
            };
            
            const addVilla = () => {
                if (newVilla.name.trim() && newVilla.area && newVilla.pricePerSqm && newVilla.basePrice) {
                    const villa = {
                        id: generateId(),
                        name: newVilla.name.trim(),
                        area: parseFloat(newVilla.area),
                        pricePerSqm: parseFloat(newVilla.pricePerSqm),
                        basePrice: parseFloat(newVilla.basePrice)
                    };
                    setVillas(prev => [...prev, villa]);
                    setNewVilla({ name: '', area: '', pricePerSqm: '', basePrice: '' });
                    setShowAddVillaModal(false);
                    setHasUnsavedChanges(true);
                }
            };
            
            // ИСПРАВЛЕНО: функции управления линиями
            const addLine = () => {
                if (villas.length > 0) {
                    const newLine = {
                        id: generateId(),
                        projectId: projects.length > 0 ? projects[0].id : null,
                        projectName: projects.length > 0 ? projects[0].name : 'Проект',
                        villaId: villas[0].id,
                        villaName: villas[0].name,
                        qty: 1,
                        area: villas[0].area,
                        pricePerSqm: villas[0].pricePerSqm,
                        basePrice: villas[0].basePrice,
                        prePct: 50,
                        discount: 0,
                        month: 1
                    };
                    setLines(prev => [...prev, newLine]);
                    setHasUnsavedChanges(true);
                }
            };
            
            const updateLine = (id, field, value) => {
                setLines(prev => prev.map(line => 
                    line.id === id ? { ...line, [field]: value } : line
                ));
                setHasUnsavedChanges(true);
            };
            
            const deleteLine = (id) => {
                setLines(prev => prev.filter(line => line.id !== id));
                setHasUnsavedChanges(true);
            };
            
            const duplicateLine = (id) => {
                const line = lines.find(l => l.id === id);
                if (line) {
                    const newLine = { ...line, id: generateId() };
                    setLines(prev => [...prev, newLine]);
                    setHasUnsavedChanges(true);
                }
            };

                    // ИСПРАВЛЕНО: функции экспорта и импорта
            const exportJSON = () => {
                const data = {
                    projects,
                    villas,
                    lines,
                    stages,
                    exchangeRateIDR,
                    exchangeRateEUR,
                    keysMonth,
                    globalRate,
                    globalTerm,
                    preHandoverPct,
                    postHandoverTerms
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'arconique-data.json';
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const importJSON = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.projects) setProjects(data.projects);
                            if (data.villas) setVillas(data.villas);
                            if (data.lines) setLines(data.lines);
                            if (data.stages) setStages(data.stages);
                            if (data.exchangeRateIDR) setExchangeRateIDR(data.exchangeRateIDR);
                            if (data.exchangeRateEUR) setExchangeRateEUR(data.exchangeRateEUR);
                            if (data.keysMonth) setKeysMonth(data.keysMonth);
                            if (data.globalRate) setGlobalRate(data.globalRate);
                            if (data.globalTerm) setGlobalTerm(data.globalTerm);
                            if (data.preHandoverPct) setPreHandoverPct(data.preHandoverPct);
                            if (data.postHandoverTerms) setPostHandoverTerms(data.postHandoverTerms);
                            setHasUnsavedChanges(true);
                        } catch (error) {
                            alert('Ошибка при импорте файла');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            // ИСПРАВЛЕНО: функция экспорта PDF
            const exportPDF = () => {
                const element = document.createElement('div');
                element.innerHTML = `
                    <div style="padding: 20px; font-family: Arial, sans-serif;">
                        <h1>${T.title}</h1>
                        <h2>Отчет</h2>
                        <h3>Общая стоимость: ${fmtMoney(project.totalValue)}</h3>
                        <h3>Базовая стоимость: ${fmtMoney(project.totalBase)}</h3>
                        <h3>Базовая рассрочка: ${fmtMoney(project.totalPre)}</h3>
                        <h3>Скидка: ${fmtMoney(project.totalDiscount)}</h3>
                        
                        <h3>Кэшфлоу:</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="border: 1px solid #d1d5db; padding: 8px;">Месяц</th>
                                    <th style="border: 1px solid #d1d5db; padding: 8px;">Тип</th>
                                    <th style="border: 1px solid #d1d5db; padding: 8px;">Сумма</th>
                                    <th style="border: 1px solid #d1d5db; padding: 8px;">Описание</th>
                                    <th style="border: 1px solid #d1d5db; padding: 8px;">Дата</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${project.cashflow.map(item => `
                                    <tr>
                                        <td style="border: 1px solid #d1d5db; padding: 8px;">${item.month}</td>
                                        <td style="border: 1px solid #d1d5db; padding: 8px;">${item.type}</td>
                                        <td style="border: 1px solid #d1d5db; padding: 8px;">${fmtMoney(item.amount)}</td>
                                        <td style="border: 1px solid #d1d5db; padding: 8px;">${item.description}</td>
                                        <td style="border: 1px solid #d1d5db; padding: 8px;">${item.realDate}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                const opt = {
                    margin: 1,
                    filename: 'arconique-report.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
            };
            
            const exportCSV = () => {
                const csvContent = [
                    ['Месяц', 'Тип', 'Сумма', 'Описание', 'Дата'],
                    ...project.cashflow.map(item => [
                        item.month,
                        item.type,
                        item.amount,
                        item.description,
                        item.realDate
                    ])
                ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'arconique-cashflow.csv';
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const exportXLSX = () => {
                const ws = XLSX.utils.json_to_sheet(project.cashflow.map(item => ({
                    Месяц: item.month,
                    Тип: item.type,
                    Сумма: item.amount,
                    Описание: item.description,
                    Дата: item.realDate
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Кэшфлоу');
                XLSX.writeFile(wb, 'arconique-cashflow.xlsx');
            };
            
            // ИСПРАВЛЕНО: функция share с реальными датами
            const share = (mode) => {
                const data = {
                    projects,
                    villas,
                    lines,
                    stages,
                    exchangeRateIDR,
                    exchangeRateEUR,
                    keysMonth,
                    globalRate,
                    globalTerm,
                    preHandoverPct,
                    postHandoverTerms,
                    mode
                };
                const json = JSON.stringify(data);
                const compressed = LZString.compressToEncodedURIComponent(json);
                const url = `${window.location.origin}${window.location.pathname}#${compressed}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: T.title,
                        text: 'Поделиться расчетом',
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(url).then(() => {
                        alert('Ссылка скопирована в буфер обмена');
                    });
                }
            };
            
            // ИСПРАВЛЕНО: функции управления этапами
            const addStage = () => {
                const newStage = {
                    id: generateId(),
                    pct: 0,
                    month: stages.length + 1
                };
                setStages(prev => [...prev, newStage]);
                setHasUnsavedChanges(true);
            };
            
            const updateStage = (id, field, value) => {
                setStages(prev => prev.map(stage => 
                    stage.id === id ? { ...stage, [field]: value } : stage
                ));
                setHasUnsavedChanges(true);
            };
            
            const deleteStage = (id) => {
                setStages(prev => prev.filter(stage => stage.id !== id));
                setHasUnsavedChanges(true);
            };
            
            // ИСПРАВЛЕНО: useEffect для инициализации и автосохранения
            useEffect(() => {
                // Проверяем PIN только для редактора
                if (!isClient) {
                    const checkPin = async () => {
                        const pin = prompt('Введите PIN для входа в редактор:');
                        if (pin) {
                            const hash = await sha256Hex(pin);
                            if (hash === 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3') {
                                setIsClient(false); // Редактор
                            } else {
                                setIsClient(true); // Клиентский режим
                            }
                        } else {
                            setIsClient(true); // Клиентский режим по умолчанию
                        }
                    };
                    checkPin();
                }
                
                // Загружаем данные из localStorage
                const saved = localStorage.getItem('arconique-data');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        if (data.projects) setProjects(data.projects);
                        if (data.villas) setVillas(data.villas);
                        if (data.lines) setLines(data.lines);
                        if (data.stages) setStages(data.stages);
                        if (data.exchangeRateIDR) setExchangeRateIDR(data.exchangeRateIDR);
                        if (data.exchangeRateEUR) setExchangeRateEUR(data.exchangeRateEUR);
                        if (data.keysMonth) setKeysMonth(data.keysMonth);
                        if (data.globalRate) setGlobalRate(data.globalRate);
                        if (data.globalTerm) setGlobalTerm(data.globalTerm);
                        if (data.preHandoverPct) setPreHandoverPct(data.preHandoverPct);
                        if (data.postHandoverTerms) setPostHandoverTerms(data.postHandoverTerms);
                    } catch (error) {
                        console.error('Ошибка загрузки данных:', error);
                    }
                }
            }, []);
            
            // Автосохранение
            useEffect(() => {
                if (hasUnsavedChanges) {
                    setAutoSaveStatus('saving');
                    const timeoutId = setTimeout(() => {
                        try {
                            const data = {
                                projects,
                                villas,
                                lines,
                                stages,
                                exchangeRateIDR,
                                exchangeRateEUR,
                                keysMonth,
                                globalRate,
                                globalTerm,
                                preHandoverPct,
                                postHandoverTerms
                            };
                            localStorage.setItem('arconique-data', JSON.stringify(data));
                            setAutoSaveStatus('saved');
                            setHasUnsavedChanges(false);
                        } catch (error) {
                            setAutoSaveStatus('error');
                        }
                    }, 1000);
                    
                    return () => clearTimeout(timeoutId);
                }
            }, [hasUnsavedChanges, projects, villas, lines, stages, exchangeRateIDR, exchangeRateEUR, keysMonth, globalRate, globalTerm, preHandoverPct, postHandoverTerms]);
            
            // Рендер компонента
            return (
                <div className="wrap">
                    {/* Индикатор автосохранения */}
                    <div id="auto-save-indicator" className="auto-save-indicator" style={{ display: autoSaveStatus !== 'saved' ? 'block' : 'none' }}>
                        {autoSaveStatus === 'saving' && 'Сохранение...'}
                        {autoSaveStatus === 'saved' && 'Сохранено'}
                        {autoSaveStatus === 'error' && 'Ошибка сохранения'}
                    </div>
                    
                    {/* Основная сетка */}
                    <div className="grid">
                        {/* Блок параметров */}
                        <div className="card">
                            <h2>⚙️ {T.parameters}</h2>
                            
                            <div className="settings-group">
                                <div className="settings-header" onClick={() => setExpandedGroups(prev => ({ ...prev, basic: !prev.basic }))}>
                                    <span>Основные параметры</span>
                                    <span>{expandedGroups.basic ? '▼' : '▶'}</span>
                                </div>
                                {expandedGroups.basic && (
                                    <div className="settings-content">
                                        <div className="field-row">
                                            <div className="field compact">
                                                <label>{T.exchangeRateIDR}</label>
                                                <input 
                                                    type="number" 
                                                    value={exchangeRateIDR}
                                                    onChange={(e) => {
                                                        setExchangeRateIDR(parseFloat(e.target.value) || 0);
                                                        setHasUnsavedChanges(true);
                                                    }}
                                                />
                                            </div>
                                            <div className="field compact">
                                                <label>{T.exchangeRateEUR}</label>
                                                <input 
                                                    type="number" 
                                                    value={exchangeRateEUR}
                                                    onChange={(e) => {
                                                        setExchangeRateEUR(parseFloat(e.target.value) || 0);
                                                        setHasUnsavedChanges(true);
                                                    }}
                                                />
                                            </div>
                                        </div>
                                        <div className="field-row">
                                            <div className="field compact">
                                                <label>{T.keysMonth}</label>
                                                <input 
                                                    type="number" 
                                                    value={keysMonth}
                                                    onChange={(e) => {
                                                        setKeysMonth(parseInt(e.target.value) || 0);
                                                        setHasUnsavedChanges(true);
                                                    }}
                                                />
                                            </div>
                                            <div className="field compact">
                                                <label>{T.globalRate}</label>
                                                <input 
                                                    type="number" 
                                                    value={globalRate}
                                                    onChange={(e) => {
                                                        setGlobalRate(parseFloat(e.target.value) || 0);
                                                        setHasUnsavedChanges(true);
                                                    }}
                                                />
                                            </div>
                                        </div>
                                        <div className="field-row">
                                            <div className="field compact">
                                                <label>{T.globalTerm}</label>
                                                <input 
                                                    type="number" 
                                                    value={globalTerm}
                                                    onChange={(e) => {
                                                        setGlobalTerm(parseInt(e.target.value) || 0);
                                                        setHasUnsavedChanges(true);
                                                    }}
                                                />
                                            </div>
                                            <div className="field compact">
                                                <label>{T.postHandoverTerms}</label>
                                                <input 
                                                    type="number" 
                                                    value={postHandoverTerms}
                                                    onChange={(e) => {
                                                        setPostHandoverTerms(parseInt(e.target.value) || 0);
                                                        setHasUnsavedChanges(true);
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            <div className="settings-group">
                                <div className="settings-header" onClick={() => setExpandedGroups(prev => ({ ...prev, stages: !prev.stages }))}>
                                    <span>{T.stagesBeforeKeys}</span>
                                    <span>{expandedGroups.stages ? '▼' : '▶'}</span>
                                </div>
                                {expandedGroups.stages && (
                                    <div className="settings-content">
                                        <div className="field">
                                            <label>{T.preHandoverPct}</label>
                                            <input 
                                                type="range" 
                                                min="50" 
                                                max="100" 
                                                step="1"
                                                value={preHandoverPct}
                                                onChange={(e) => {
                                                    setPreHandoverPct(parseInt(e.target.value));
                                                    setHasUnsavedChanges(true);
                                                }}
                                            />
                                            <span>{preHandoverPct}%</span>
                                        </div>
                                        
                                        <div className="hr" />
                                        
                                        <table className="stages-table">
                                            <thead>
                                                <tr>
                                                    <th>{T.stage}</th>
                                                    <th>{T.percentage}</th>
                                                    <th>{T.month}</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {stages.map(stage => (
                                                    <tr key={stage.id}>
                                                        <td>{stage.id}</td>
                                                        <td>
                                                            <input 
                                                                type="range" 
                                                                min="0" 
                                                                max="100" 
                                                                step="1"
                                                                value={stage.pct}
                                                                onChange={(e) => updateStage(stage.id, 'pct', parseInt(e.target.value))}
                                                            />
                                                            <span>{stage.pct}%</span>
                                                        </td>
                                                        <td>
                                                            <input 
                                                                type="number" 
                                                                value={stage.month}
                                                                onChange={(e) => updateStage(stage.id, 'month', parseInt(e.target.value))}
                                                                min="1"
                                                            />
                                                        </td>
                                                        <td>
                                                            <button 
                                                                className="btn danger compact" 
                                                                onClick={() => deleteStage(stage.id)}
                                                            >
                                                                {T.remove}
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        
                                        <button className="btn" onClick={addStage}>
                                            + {T.add}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>

                                                {/* Блок расчета и кэшфлоу */}
                        <div className="card">
                            <h2>�� {T.overview}</h2>
                            
                            {/* ИСПРАВЛЕНО: убран лишний таб "Этапы" */}
                            <div className="smart-tabs">
                                <button className="smart-tab active">
                                    📈 {T.overview}
                                    <span className="badge">{lines.length}</span>
                                </button>
                            </div>
                            
                            {/* Блок KPI */}
                            <div className="kpi-grid">
                                <KPIBlock 
                                    label={T.totalCost} 
                                    value={project.totalValue} 
                                    currency="USD" 
                                />
                                <KPIBlock 
                                    label={T.baseCost} 
                                    value={project.totalBase} 
                                    currency="USD" 
                                />
                                <KPIBlock 
                                    label={T.stagesBeforeKeys} 
                                    value={project.totalPre} 
                                    currency="USD" 
                                />
                                <KPIBlock 
                                    label={T.discount} 
                                    value={project.totalDiscount} 
                                    currency="USD" 
                                />
                            </div>
                            
                            {/* ИСПРАВЛЕНО: таблица расчета позиций */}
                            <h3>{T.calculationPositions}</h3>
                            <table className="calc-table">
                                <thead>
                                    <tr>
                                        <th>{T.projectName}</th>
                                        <th>{T.villaName}</th>
                                        <th>Кол-во</th>
                                        <th>{T.area}</th>
                                        <th>{T.pricePerSqm}</th>
                                        <th>{T.baseCost}</th>
                                        <th>{T.preHandover}</th>
                                        <th>{T.discount}</th>
                                        {!isClient && <th>{T.interest}</th>}
                                        <th>{T.lineTotal}</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {linesData.map(line => (
                                        <tr key={line.id}>
                                            <td className="project-name-display">{line.projectName}</td>
                                            <td className="villa-name-display">{line.villaName}</td>
                                            <td>
                                                <input 
                                                    type="number" 
                                                    value={line.qty}
                                                    onChange={(e) => updateLine(line.id, 'qty', parseInt(e.target.value) || 1)}
                                                    min="1"
                                                    style={{ width: '60px' }}
                                                />
                                            </td>
                                            <td className="area-display">{line.area} м²</td>
                                            <td className="ppsm-display">${line.pricePerSqm}</td>
                                            <td className="base-strong">${line.basePrice}</td>
                                            <td>
                                                <input 
                                                    type="range" 
                                                    min="50" 
                                                    max="100" 
                                                    step="1"
                                                    value={line.prePct}
                                                    onChange={(e) => updateLine(line.id, 'prePct', parseInt(e.target.value))}
                                                />
                                                <span>{line.prePct}%</span>
                                            </td>
                                            <td>
                                                <input 
                                                    type="range" 
                                                    min="0" 
                                                    max="100" 
                                                    step="1"
                                                    value={line.discount}
                                                    onChange={(e) => updateLine(line.id, 'discount', parseInt(e.target.value))}
                                                />
                                                <span>{line.discount}%</span>
                                            </td>
                                            {!isClient && (
                                                <td>
                                                    <input 
                                                        type="number" 
                                                        value={line.interest || 0}
                                                        onChange={(e) => updateLine(line.id, 'interest', parseFloat(e.target.value) || 0)}
                                                        step="0.1"
                                                        style={{ width: '80px' }}
                                                    />
                                                </td>
                                            )}
                                            <td className="line-total">${line.total}</td>
                                            <td>
                                                <button 
                                                    className="btn danger compact" 
                                                    onClick={() => deleteLine(line.id)}
                                                >
                                                    {T.delete}
                                                </button>
                                                <button 
                                                    className="btn secondary compact" 
                                                    onClick={() => duplicateLine(line.id)}
                                                >
                                                    {T.edit}
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            
                            <div className="btn-row">
                                <button className="btn success" onClick={addLine}>
                                    + Добавить позицию
                                </button>
                                <button className="btn" onClick={() => setShowAddFromCatalogModal(true)}>
                                    📋 {T.addFromCatalog}
                                </button>
                            </div>
                            
                            {/* ИСПРАВЛЕНО: таблица кэшфлоу без ограничений высоты */}
                            <h3>{T.monthlyCashflow}</h3>
                            <table className="cashflow-table">
                                <thead>
                                    <tr>
                                        <th>Месяц</th>
                                        <th>Тип</th>
                                        <th>Сумма</th>
                                        <th>Описание</th>
                                        <th>Дата</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {project.cashflow.map((item, index) => (
                                        <tr key={index}>
                                            <td>{item.month}</td>
                                            <td>{item.type}</td>
                                            <td>${fmtMoney(item.amount)}</td>
                                            <td>{item.description}</td>
                                            <td>{item.realDate}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            
                            <div className="btn-row">
                                <button className="btn" onClick={exportPDF}>
                                    📄 {T.saveToPDF}
                                </button>
                                <button className="btn secondary" onClick={exportCSV}>
                                    📊 {T.exportCSV}
                                </button>
                                <button className="btn secondary" onClick={exportXLSX}>
                                    📈 {T.exportXLSX}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {/* ИСПРАВЛЕНО: каталог вынесен в отдельный блок */}
                    <div className="full-width-block">
                        <h2>🏗️ {T.catalogProjectsVillas}</h2>
                        
                        <div className="btn-row">
                            <button className="btn" onClick={() => setShowAddProjectModal(true)}>
                                ➕ {T.addProject}
                            </button>
                            <button className="btn" onClick={() => setShowAddVillaModal(true)}>
                                🏠 {T.addVilla}
                            </button>
                            <button className="btn secondary" onClick={() => document.getElementById('import-json').click()}>
                                📥 {T.importJSON}
                            </button>
                            <button className="btn secondary" onClick={exportJSON}>
                                📤 {T.exportJSON}
                            </button>
                        </div>
                        
                        <input 
                            type="file" 
                            id="import-json" 
                            accept=".json" 
                            onChange={importJSON} 
                            style={{ display: 'none' }}
                        />
                        
                        {/* Таблица проектов */}
                        {projects.length > 0 && (
                            <div>
                                <h3>Проекты</h3>
                                <table className="catalog-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>{T.projectName}</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {projects.map(project => (
                                            <tr key={project.id}>
                                                <td>{project.id}</td>
                                                <td>{project.name}</td>
                                                <td>
                                                    <button className="btn danger compact">
                                                        {T.delete}
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        {/* Таблица вилл */}
                        {villas.length > 0 && (
                            <div>
                                <h3>Виллы</h3>
                                <table className="catalog-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>{T.villaName}</th>
                                            <th>{T.area}</th>
                                            <th>{T.pricePerSqm}</th>
                                            <th>{T.baseCost}</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {villas.map(villa => (
                                            <tr key={villa.id}>
                                                <td>{villa.id}</td>
                                                <td>{villa.name}</td>
                                                <td>{villa.area} м²</td>
                                                <td>${villa.pricePerSqm}</td>
                                                <td>${villa.basePrice}</td>
                                                <td>
                                                    <button className="btn danger compact">
                                                        {T.delete}
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        <div className="btn-row">
                            <button className="btn outline" onClick={() => share('editor')}>
                                🔗 {T.shareEditor}
                            </button>
                            <button className="btn outline" onClick={() => share('client')}>
                                👥 {T.shareClient}
                            </button>
                        </div>
                    </div>

                                        {/* ИСПРАВЛЕНО: модальное окно добавления проекта */}
                    {showAddProjectModal && (
                        <div className="modal-overlay" onClick={() => setShowAddProjectModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{T.addProject}</h3>
                                    <button className="btn icon" onClick={() => setShowAddProjectModal(false)}>✕</button>
                                </div>
                                <div className="modal-body">
                                    <div className="field">
                                        <label>{T.projectName}:</label>
                                        <input 
                                            type="text" 
                                            value={newProject.name}
                                            onChange={(e) => setNewProject({ ...newProject, name: e.target.value })}
                                            placeholder="Введите название проекта"
                                        />
                                    </div>
                                    <div className="btn-group">
                                        <button className="btn secondary" onClick={() => setShowAddProjectModal(false)}>
                                            {T.cancel}
                                        </button>
                                        <button className="btn success" onClick={addProject}>
                                            {T.add}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* ИСПРАВЛЕНО: модальное окно добавления виллы */}
                    {showAddVillaModal && (
                        <div className="modal-overlay" onClick={() => setShowAddVillaModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{T.addVilla}</h3>
                                    <button className="btn icon" onClick={() => setShowAddVillaModal(false)}>✕</button>
                                </div>
                                <div className="modal-body">
                                    <div className="field">
                                        <label>{T.villaName}:</label>
                                        <input 
                                            type="text" 
                                            value={newVilla.name}
                                            onChange={(e) => setNewVilla({ ...newVilla, name: e.target.value })}
                                            placeholder="Введите название виллы"
                                        />
                                    </div>
                                    <div className="field">
                                        <label>{T.area}:</label>
                                        <input 
                                            type="number" 
                                            value={newVilla.area}
                                            onChange={(e) => setNewVilla({ ...newVilla, area: e.target.value })}
                                            placeholder="Введите площадь"
                                            min="0"
                                            step="0.01"
                                        />
                                    </div>
                                    <div className="field">
                                        <label>{T.pricePerSqm}:</label>
                                        <input 
                                            type="number" 
                                            value={newVilla.pricePerSqm}
                                            onChange={(e) => setNewVilla({ ...newVilla, pricePerSqm: e.target.value })}
                                            placeholder="Введите цену за м²"
                                            min="0"
                                            step="0.01"
                                        />
                                    </div>
                                    <div className="field">
                                        <label>{T.basePrice}:</label>
                                        <input 
                                            type="number" 
                                            value={newVilla.basePrice}
                                            onChange={(e) => setNewVilla({ ...newVilla, basePrice: e.target.value })}
                                            placeholder="Введите базовую цену"
                                            min="0"
                                            step="0.01"
                                        />
                                    </div>
                                    <div className="btn-group">
                                        <button className="btn secondary" onClick={() => setShowAddVillaModal(false)}>
                                            {T.cancel}
                                        </button>
                                        <button className="btn success" onClick={addVilla}>
                                            {T.add}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* ИСПРАВЛЕНО: модальное окно добавления из каталога */}
                    {showAddFromCatalogModal && (
                        <div className="modal-overlay" onClick={() => setShowAddFromCatalogModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{T.addFromCatalog}</h3>
                                    <button className="btn icon" onClick={() => setShowAddFromCatalogModal(false)}>✕</button>
                                </div>
                                <div className="modal-body">
                                    {villas.length > 0 ? (
                                        <div>
                                            <p>Выберите виллу для добавления:</p>
                                            <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                                                {villas.map(villa => (
                                                    <div 
                                                        key={villa.id} 
                                                        style={{ 
                                                            padding: '12px', 
                                                            border: '1px solid var(--border)', 
                                                            borderRadius: 'var(--radius)', 
                                                            marginBottom: '8px',
                                                            cursor: 'pointer'
                                                        }}
                                                        onClick={() => {
                                                            const newLine = {
                                                                id: generateId(),
                                                                projectId: projects.length > 0 ? projects[0].id : null,
                                                                projectName: projects.length > 0 ? projects[0].name : 'Проект',
                                                                villaId: villa.id,
                                                                villaName: villa.name,
                                                                qty: 1,
                                                                area: villa.area,
                                                                pricePerSqm: villa.pricePerSqm,
                                                                basePrice: villa.basePrice,
                                                                prePct: 50,
                                                                discount: 0,
                                                                month: 1
                                                            };
                                                            setLines(prev => [...prev, newLine]);
                                                            setHasUnsavedChanges(true);
                                                            setShowAddFromCatalogModal(false);
                                                        }}
                                                    >
                                                        <strong>{villa.name}</strong><br />
                                                        Площадь: {villa.area} м² | Цена: ${villa.pricePerSqm}/м² | Базовая цена: ${villa.basePrice}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <p>В каталоге нет вилл. Сначала добавьте виллу.</p>
                                    )}
                                    <div className="btn-group">
                                        <button className="btn secondary" onClick={() => setShowAddFromCatalogModal(false)}>
                                            {T.close}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // ИСПРАВЛЕНО: правильный рендер React приложения
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
