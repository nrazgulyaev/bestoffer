<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>v7.6</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    *{box-sizing:border-box}
    
    :root{
      /* Современная цветовая палитра */
      --bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      --card: rgba(255,255,255,0.03);
      --card-hover: rgba(255,255,255,0.08);
      --card-active: rgba(255,255,255,0.12);
      --line: rgba(255,255,255,0.08);
      --line-hover: rgba(255,255,255,0.15);
      --muted: #94a3b8;
      --ink: #f8fafc;
      --warn: #ef4444;
      --ok: #10b981;
      --strong: #3b82f6;
      --good: #059669;
      --accent: #8b5cf6;
      
      /* Отступы и размеры */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;
      
      /* Радиусы */
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      
      /* Тени */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      /* Анимации */
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.6;
      min-height:100vh;
    }
    
    .wrap{
      max-width:1400px;
      margin:24px auto;
      padding:0 16px;
    }
    
    h1{
      margin:0 0 12px;
      font-size:22px;
      font-weight:600;
      color:var(--ink);
    }
    
    .grid{
      display:grid;
      grid-template-columns:420px 1fr;
      gap:var(--spacing-lg);
    }
    
    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }
    }
    
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:var(--spacing-lg);
      backdrop-filter:blur(10px);
      transition:var(--transition);
      min-height:200px;
    }
    
    .card:hover{
      background:var(--card-hover);
      border-color:var(--line-hover);
      transform:translateY(-2px);
      box-shadow:var(--shadow-lg);
    }
    
    .row{
      display:flex;
      gap:var(--spacing-md);
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:var(--spacing-md);
    }
    
    .field{
      display:grid;
      gap:var(--spacing-sm);
      margin-bottom:var(--spacing-md);
      flex:1;
      min-width:0;
    }
    
    .field-compact{
      flex:0 0 auto;
      min-width:120px;
    }
    
    .field-wide{
      flex:2;
      min-width:200px;
    }
    
    label{
      color:var(--muted);
      font-size:13px;
      font-weight:500;
    }
    
    input[type="text"],input[type="number"],input[type="range"],select,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:var(--radius-sm);
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.05);
      color:var(--ink);
      font-size:14px;
      transition:var(--transition);
    }
    
    input[type="text"]:focus,input[type="number"]:focus,select:focus,textarea:focus{
      outline:none;
      border-color:var(--strong);
      background:rgba(255,255,255,0.08);
      box-shadow:0 0 0 3px rgba(59,130,246,0.1);
    }
    
    input[type="range"]{
      padding:0;
      height:32px;
      background:transparent;
    }
    
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2);
      font-size:12px;
      color:var(--ink);
      text-align:center;
      min-width:40px;
    }
    
    .badge{
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2);
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      color:var(--ink);
    }
    
    .muted{
      color:var(--muted);
    }
    
    .hr{
      height:1px;
      background:var(--line);
      border:0;
      margin:var(--spacing-md) 0;
    }
    
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.1);
      color:var(--ink);
      padding:10px 16px;
      border-radius:var(--radius-sm);
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:var(--transition);
      text-align:center;
      min-width:120px;
      height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    
    .btn:hover{
      background:rgba(255,255,255,0.15);
      border-color:rgba(255,255,255,0.3);
      transform:translateY(-1px);
      box-shadow:var(--shadow);
    }
    
    .btn:active{
      transform:translateY(0);
    }
    
    .btn.warn{
      background:rgba(239,68,68,0.2);
      border-color:rgba(239,68,68,0.4);
      color:#fca5a5;
    }
    
    .btn.warn:hover{
      background:rgba(239,68,68,0.3);
      border-color:rgba(239,68,68,0.6);
    }
    
    .btn.ok{
      background:rgba(16,185,129,0.2);
      border-color:rgba(16,185,129,0.4);
      color:#6ee7b7;
    }
    
    .btn.ok:hover{
      background:rgba(16,185,129,0.3);
      border-color:rgba(16,185,129,0.6);
    }
    
    .btn.primary{
      background:rgba(59,130,246,0.2);
      border-color:rgba(59,130,246,0.4);
      color:#93c5fd;
    }
    
    .btn.primary:hover{
      background:rgba(59,130,246,0.3);
      border-color:rgba(59,130,246,0.6);
    }
    
    .btn.success{
      background:rgba(16,185,129,0.2);
      border-color:rgba(16,185,129,0.4);
      color:#6ee7b7;
    }
    
    .btn.success:hover{
      background:rgba(16,185,129,0.3);
      border-color:rgba(16,185,129,0.6);
    }
    
    .btn.icon{
      padding:8px;
      border-radius:var(--radius-sm);
      min-width:44px;
      width:44px;
    }
    
    table{
      width:100%;
      border-collapse:collapse;
    }
    
    th,td{
      padding:12px 8px;
      border-bottom:1px solid rgba(255,255,255,0.1);
      text-align:right;
      font-variant-numeric:tabular-nums;
      vertical-align:middle;
    }
    
    th:first-child,td:first-child{
      text-align:left;
    }
    
    th{
      background:rgba(255,255,255,0.05);
      font-weight:600;
      color:var(--ink);
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .scroll{
      overflow:auto;
      max-height:50vh;
      border-radius:var(--radius-sm);
    }
    
    .kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:var(--spacing-md);
      margin:var(--spacing-md) 0;
    }
    
    .kpi{
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:var(--radius-sm);
      padding:var(--spacing-md);
      text-align:center;
      transition:var(--transition);
    }
    
    .kpi:hover{
      background:rgba(255,255,255,0.08);
      transform:translateY(-2px);
    }
    
    .kpi .v{
      font-size:18px;
      font-weight:700;
      color:var(--ink);
      margin-bottom:4px;
    }
    
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-left:8px;
    }
    
    .hint.warn{
      color:var(--warn);
    }
    
    .tabs{
      display:flex;
      gap:var(--spacing-sm);
      margin-bottom:var(--spacing-md);
      border-bottom:1px solid var(--line);
      padding-bottom:var(--spacing-sm);
    }
    
    .tab{
      padding:10px 16px;
      border-radius:var(--radius-sm);
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      color:var(--muted);
      transition:var(--transition);
      min-width:100px;
      text-align:center;
    }
    
    .tab:hover{
      color:var(--ink);
      background:rgba(255,255,255,0.05);
    }
    
    .tab.active{
      background:rgba(59,130,246,0.2);
      border-color:rgba(59,130,246,0.4);
      color:#93c5fd;
    }

        /* calc table - исправляем ширину колонок */
    .calc-scroll{
      overflow:auto;
      max-height:32vh;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:var(--radius);
      background:rgba(255,255,255,0.02);
      margin-top:var(--spacing-md);
    }
    
    @media (min-width: 768px) {
      .calc-scroll {
        max-height: 40vh;
      }
    }
    
    .calc-table{
      min-width:600px;
    }
    
    @media (min-width: 1024px) {
      .calc-table {
        min-width: 800px;
      }
    }
    
    @media (min-width: 1200px) {
      .calc-table {
        min-width: 1000px;
      }
    }
    
    .calc-table th{
      position:sticky;
      top:0;
      background:rgba(255,255,255,0.05);
      z-index:1;
      backdrop-filter:blur(10px);
    }
    
    /* Оптимизируем ширину колонок */
    .col-project{min-width:120px;max-width:150px}
    .col-villa{min-width:150px;max-width:200px}
    .col-qty{min-width:60px;max-width:80px}
    .col-area{min-width:70px;max-width:90px}
    .col-ppsm{min-width:90px;max-width:110px}
    .col-base{min-width:120px;max-width:150px}
    .col-disc{min-width:80px;max-width:100px}
    .col-pre{min-width:100px;max-width:120px}
    .col-post{min-width:100px;max-width:120px}
    .col-total{min-width:120px;max-width:150px}
    .col-actions{min-width:80px;max-width:100px}
    
    /* Каталог проектов - улучшаем отображение */
    .catalog-item{
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:var(--radius-sm);
      padding:var(--spacing-md);
      margin-bottom:var(--spacing-sm);
      transition:var(--transition);
    }
    
    .catalog-item:hover{
      background:rgba(255,255,255,0.08);
      border-color:rgba(255,255,255,0.2);
    }
    
    .catalog-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:var(--spacing-md);
      padding-bottom:var(--spacing-sm);
      border-bottom:1px solid rgba(255,255,255,0.1);
    }
    
    .catalog-title{
      font-size:16px;
      font-weight:600;
      color:var(--ink);
      margin:0;
    }
    
    .catalog-villas{
      display:grid;
      gap:var(--spacing-sm);
    }
    
    .villa-item{
      display:grid;
      grid-template-columns:1fr auto auto auto;
      gap:var(--spacing-sm);
      align-items:center;
      padding:var(--spacing-sm);
      background:rgba(255,255,255,0.03);
      border-radius:var(--radius-sm);
      border:1px solid rgba(255,255,255,0.05);
    }
    
    .villa-name{
      font-weight:500;
      color:var(--ink);
    }
    
    .villa-area{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      min-width:50px;
    }
    
    .villa-ppsm{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      min-width:70px;
    }
    
    .villa-base{
      text-align:right;
      color:var(--ink);
      font-weight:600;
      min-width:100px;
    }
    
    /* Модальные окна */
    .modal-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.8);
      backdrop-filter:blur(8px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:var(--spacing-md);
    }
    
    .modal-content{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:var(--spacing-xl);
      max-width:600px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:var(--shadow-xl);
      backdrop-filter:blur(20px);
    }
    
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:var(--spacing-lg);
      padding-bottom:var(--spacing-md);
      border-bottom:1px solid var(--line);
    }
    
    .modal-title{
      font-size:20px;
      font-weight:600;
      color:var(--ink);
      margin:0;
    }
    
    .modal-close{
      background:none;
      border:none;
      color:var(--muted);
      font-size:24px;
      cursor:pointer;
      padding:4px;
      border-radius:var(--radius-sm);
      transition:var(--transition);
    }
    
    .modal-close:hover{
      color:var(--ink);
      background:rgba(255,255,255,0.1);
    }
    
    .modal-body{
      margin-bottom:var(--spacing-lg);
    }
    
    .form-section{
      margin-bottom:var(--spacing-lg);
    }
    
    .form-section-title{
      font-size:16px;
      font-weight:600;
      color:var(--ink);
      margin-bottom:var(--spacing-md);
      padding-bottom:var(--spacing-sm);
      border-bottom:1px solid rgba(255,255,255,0.1);
    }
    
    .form-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:var(--spacing-md);
      margin-bottom:var(--spacing-md);
    }
    
    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    .form-group{
      display:grid;
      gap:var(--spacing-sm);
    }
    
    .form-actions{
      display:flex;
      gap:var(--spacing-md);
      justify-content:flex-end;
      padding-top:var(--spacing-md);
      border-top:1px solid var(--line);
    }
    
    /* Адаптивные стили для мобильных устройств */
    @media (max-width: 767px) {
      .row {
        flex-direction: column;
        align-items: stretch;
        gap: var(--spacing-sm);
      }
      
      .field {
        margin-bottom: var(--spacing-sm);
      }
      
      .btn {
        width: 100%;
        margin-bottom: var(--spacing-sm);
        padding: 12px 16px;
        font-size: 14px;
        min-width: auto;
      }
      
      .btn.icon {
        width: auto;
        margin-bottom: 0;
        min-width: 44px;
      }
      
      .tabs {
        flex-direction: column;
        gap: var(--spacing-xs);
      }
      
      .tab {
        min-width: auto;
        padding: 10px 12px;
      }
      
      .kpis {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-sm);
      }
      
      .grid {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }
      
      .card {
        padding: var(--spacing-md);
      }
      
      .modal-content {
        padding: var(--spacing-lg);
        margin: var(--spacing-sm);
      }
    }
    
    /* Анимации и переходы */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    
    /* Улучшенные hover эффекты */
    .card:hover .card-content {
      transform: translateY(-2px);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Специальные стили для таблиц */
    .table-container {
      background: rgba(255,255,255,0.02);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.1);
      overflow: hidden;
    }
    
    .table-header {
      background: rgba(255,255,255,0.05);
      padding: var(--spacing-md);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .table-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--ink);
      margin: 0;
    }
    
    .table-actions {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }
    
    /* Стили для этапов */
    .stages-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .stages-table th,
    .stages-table td {
      padding: var(--spacing-sm);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: left;
    }
    
    .stages-table th {
      background: rgba(255,255,255,0.05);
      font-weight: 600;
      color: var(--ink);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stage-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,0.05);
      color: var(--ink);
      font-size: 13px;
    }
    
    .stage-percent {
      width: 60px;
      text-align: center;
    }
    
    .stage-month {
      width: 50px;
      text-align: center;
    }
    
    .stage-actions {
      width: 60px;
      text-align: center;
    }
    
    /* Стили для кэшфлоу */
    .cashflow-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .cashflow-table th,
    .cashflow-table td {
      padding: var(--spacing-sm);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: left;
    }
    
    .cashflow-table th {
      background: rgba(255,255,255,0.05);
      font-weight: 600;
      color: var(--ink);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .cashflow-month {
      width: 80px;
      text-align: center;
    }
    
    .cashflow-desc {
      flex: 1;
    }
    
    .cashflow-amount {
      width: 120px;
      text-align: right;
    }
    
    .cashflow-balance {
      width: 120px;
      text-align: right;
    }
    
    /* Специальные стили для заголовка расчета */
    .calculation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--line);
    }
    
    .calculation-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--ink);
    }
    
    /* Стили для каталога проектов */
    .catalog-projects {
      display: grid;
      gap: var(--spacing-md);
    }
    
    /* Стили для поиска и фильтрации */
    .search-filter {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      align-items: center;
    }
    
    .search-input {
      flex: 1;
      max-width: 300px;
    }
    
    .filter-select {
      min-width: 150px;
    }
  </style>
</head>

  <body>
  <div class="wrap">
    <h1 id="app-title">Arconique / Калькулятор рассрочки для любимых клиентов — v7.6</h1>
    <div id="boot-diagnostics" style="position:fixed;left:10px;top:10px;z-index:99999;background:#1b2336;color:#fff;border:1px solid #334;padding:8px 10px;border-radius:8px;font:12px/1.4 system-ui;max-width:80vw;display:none"></div>
    <div id="root"></div>
  </div>

  <!-- libs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <!-- boot diagnostics: ловим CDN/JSX ошибки и запускаем компиляцию -->
  <script>
    (function(){
      const box = document.createElement('div');
      box.id = 'boot-diagnostics';
      box.style.cssText = 'position:fixed;left:10px;top:10px;z-index:99999;background:#1b2336;color:#fff;border:1px solid #334;padding:8px 10px;border-radius:8px;font:12px/1.4 system-ui;max-width:80vw;display:none';
      document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box));
      const log = (msg)=>{ box.style.display='block'; box.innerHTML += (box.innerHTML?'<br>':'') + msg; };

      window.addEventListener('error', e => log('JS error: ' + (e?.message||e)));
      window.addEventListener('unhandledrejection', e => log('Promise error: ' + (e?.reason?.message||e?.reason||e)));

      let tries = 0;
      const tick = () => {
        const okReact = !!(window.React && window.ReactDOM);
        const okBabel = !!window.Babel;
        const okLZ = !!window.LZString;

        if (!okReact) log('React не загрузился (CDN заблокирован?)');
        if (!okBabel) log('Babel не загрузился — JSX не скомпилируется');
        if (!okLZ) log('LZString не загрузился — «Поделиться» может не работать');

        if (okReact && okBabel) {
          try { window.Babel.transformScriptTags(); } catch(e){ log('Babel.transformScriptTags() error: '+e.message); }
          return;
        }
        tries++;
        if (tries < 30) setTimeout(tick, 200);
        else log('Истёк таймаут ожидания библиотек — проверь блокировщики/фаервол/CDN');
      };
      setTimeout(tick, 0);
    })();
  </script>

  <!-- А ВОТ ТУТ — ТВОЙ СКРИПТ С JSX -->
  <script type="text/babel" data-presets="env,react">
    const {useEffect,useMemo,useRef,useState} = React;

    // Автоматическая генерация ID
    let nextId = 1;
    const generateId = () => `id_${nextId++}`;

    // Функция для безопасного SHA-256
    async function sha256Hex(str){
      try{
        if (!crypto.subtle) {
          console.warn('crypto.subtle not available, using fallback');
          return '';
        }
        const buf = new TextEncoder().encode(str);
        const digest = await crypto.subtle.digest('SHA-256', buf);
        return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(e){ 
        console.warn('SHA-256 failed:', e);
        return ''; 
      }
    }

    // Функция для форматирования денег
    const fmtMoney=(usd,currency='USD')=>{
      if(currency==='USD') return '$'+usd.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0});
      if(currency==='IDR') return 'Rp '+usd.toLocaleString('id-ID',{minimumFractionDigits:0,maximumFractionDigits:0});
      if(currency==='EUR') return '€'+usd.toLocaleString('de-DE',{minimumFractionDigits:0,maximumFractionDigits:0});
      return usd.toLocaleString();
    };

    // Функция для ограничения значений
    const clamp=(val,min,max)=>Math.max(min,Math.min(max,val));

    // Переводы
    const T={
      ru:{
        lang:'Язык интерфейса',
        currencyDisplay:'Валюта отображения',
        handoverMonth:'Месяц получения ключей',
        globalTerm:'Сроки post-handover',
        monthlyRate:'Месячная ставка %',
        stagesTitle:'Этапы ДО ключей',
        stage:'Этап',
        percent:'Процент',
        month:'Месяц',
        addStage:'+ Этап',
        removeStage:'Удалить',
        villasTitle:'Расчёт (позиции)',
        addFromCatalog:'Добавить из каталога',
        project:'Проект',
        villa:'Вилла',
        qty:'Кол-во',
        area:'Площадь м²',
        ppsm:'Цена за м²',
        base:'База (USD)',
        discount:'Скидка %',
        prePct:'Предоплата %',
        postPct:'Постоплата %',
        total:'Итого по строке',
        addProject:'Добавить проект',
        importJSON:'Импорт JSON',
        exportJSON:'Экспорт JSON',
        shareEditor:'Поделиться (редактор)',
        shareClient:'Поделиться (клиент)',
        exportXLSX:'Сохранить в XLSX',
        exportPDF:'Сохранить в PDF',
        cashMonth:'Месяц',
        cashDesc:'Описание',
        cashTotal:'Сумма',
        cashBalance:'Баланс',
        projectName:'Название проекта',
        villaName:'Название виллы',
        villaArea:'Площадь (м²)',
        villaPpsm:'Цена за м²',
        save:'Сохранить',
        cancel:'Отмена',
        close:'Закрыть',
        edit:'Редактировать',
        delete:'Удалить',
        search:'Поиск...',
        filter:'Фильтр',
        sortBy:'Сортировка по',
        area:'Площадь',
        name:'Название',
        price:'Цена'
      },
      en:{
        lang:'Interface Language',
        currencyDisplay:'Display Currency',
        handoverMonth:'Handover Month',
        globalTerm:'Post-handover Terms',
        monthlyRate:'Monthly Rate %',
        stagesTitle:'Pre-handover Stages',
        stage:'Stage',
        percent:'Percent',
        month:'Month',
        addStage:'+ Stage',
        removeStage:'Remove',
        villasTitle:'Calculation (Positions)',
        addFromCatalog:'Add from Catalog',
        project:'Project',
        villa:'Villa',
        qty:'Qty',
        area:'Area m²',
        ppsm:'Price per m²',
        base:'Base (USD)',
        discount:'Discount %',
        prePct:'Prepayment %',
        postPct:'Postpayment %',
        total:'Line Total',
        addProject:'Add Project',
        importJSON:'Import JSON',
        exportJSON:'Export JSON',
        shareEditor:'Share (Editor)',
        shareClient:'Share (Client)',
        exportXLSX:'Save as XLSX',
        exportPDF:'Save as PDF',
        cashMonth:'Month',
        cashDesc:'Description',
        cashTotal:'Amount',
        cashBalance:'Balance',
        projectName:'Project Name',
        villaName:'Villa Name',
        villaArea:'Area (m²)',
        villaPpsm:'Price per m²',
        save:'Save',
        cancel:'Cancel',
        close:'Close',
        edit:'Edit',
        delete:'Delete',
        search:'Search...',
        filter:'Filter',
        sortBy:'Sort by',
        area:'Area',
        name:'Name',
        price:'Price'
      }
    };

    // Каталог проектов и вилл
    const catalog={
      enso:{
        id:'enso',
        name:'Enso',
        villas:{
          'enso-1br':{id:'enso-1br',name:'Enso 1BR',area:75,ppsm:2500,baseUSD:187500},
          'enso-2br':{id:'enso-2br',name:'Enso 2BR',area:100,ppsm:2500,baseUSD:250000},
          'enso-3br':{id:'enso-3br',name:'Enso 3BR',area:125,ppsm:2500,baseUSD:312500}
        }
      },
      azure:{
        id:'azure',
        name:'Azure',
        villas:{
          'azure-2br':{id:'azure-2br',name:'Azure 2BR',area:110,ppsm:2800,baseUSD:308000},
          'azure-3br':{id:'azure-3br',name:'Azure 3BR',area:140,ppsm:2800,baseUSD:392000}
        }
      }
    };

    // Функции экспорта
    function exportXLSX(){
      const wb=XLSX.utils.book_new();
      const ws=XLSX.utils.json_to_sheet([]);
      XLSX.utils.book_append_sheet(wb,ws,'Расчет');
      XLSX.writeFile(wb,'arconique-calc.xlsx');
    }

    function exportPDF(){
      // Создаем красивый PDF с помощью jsPDF
      const { jsPDF } = window.jspdf;
      if (!jsPDF) {
        alert('PDF экспорт недоступен. Установите jsPDF библиотеку.');
        return;
      }
      
      const doc = new jsPDF();
      doc.setFontSize(20);
      doc.text('Arconique - Расчет рассрочки', 20, 20);
      
      // Добавляем данные расчета
      doc.setFontSize(12);
      doc.text('Данные расчета будут добавлены здесь', 20, 40);
      
      doc.save('arconique-calc.pdf');
    }

    // Функция поделиться
    function share(type){
      const data=JSON.stringify({type,lines:window.lines,stages:window.stages,stagesSumPct:window.stagesSumPct,handoverMonth:window.handoverMonth,months:window.months,monthlyRatePct:window.monthlyRatePct});
      const compressed=LZString.compressToEncodedURIComponent(data);
      const url=window.location.origin+window.location.pathname+'?data='+compressed;
      
      if(navigator.share){
        navigator.share({title:'Arconique Calc',url});
      }else{
        navigator.clipboard.writeText(url).then(()=>alert('Ссылка скопирована в буфер обмена'));
      }
    }

        /* ---------- Components ---------- */
    function App(){
      const [lang,setLang]=useState('ru'); const t=T[lang];
      const [tab,setTab]=useState('calc'); // 'calc'|'catalog'
      const [isClient,setIsClient]=useState(true);

      const [currency,setCurrency]=useState('USD');
      const [idrPerUsd,setIdrPerUsd]=useState(16500);
      const [eurPerUsd,setEurPerUsd]=useState(0.92);
      const toCurrency=usd=>currency==='USD'?usd:(currency==='IDR'?usd*idrPerUsd:usd*eurPerUsd);

      const [handoverMonth,setHandoverMonth]=useState(12);
      const [months,setMonths]=useState(12);
      const [monthlyRatePct,setMonthlyRatePct]=useState(8.33);

      const [stages,setStages]=useState([
        {id:1,label:'Фундамент',percent:20,month:2},
        {id:2,label:'Стены',percent:30,month:4},
        {id:3,label:'Крыша',percent:25,month:6},
        {id:4,label:'Отделка',percent:25,month:8}
      ]);

      const [lines,setLines]=useState([
        {id:1,projectId:'enso',villaId:'enso-2br',qty:1,prePct:70,ownTerms:false,months:null,monthlyRatePct:null,firstPostUSD:0,discountPct:0,
         snapshot:{name:'Enso 2BR',area:100,ppsm:2500,baseUSD:250000}}
      ]);

      // Состояния для модальных окон
      const [showAddProjectModal, setShowAddProjectModal] = useState(false);
      const [showAddVillaModal, setShowAddVillaModal] = useState(false);
      const [editingProject, setEditingProject] = useState(null);
      const [newProjectForm, setNewProjectForm] = useState({
        projectId: '',
        projectName: '',
        villas: []
      });
      const [newVillaForm, setNewVillaForm] = useState({
        villaId: '',
        villaName: '',
        area: 0,
        ppsm: 0
      });

      // Состояние для модального окна добавления из каталога
      const [modalOpen, setModalOpen] = useState(false);

      // Вычисляем сумму процентов этапов
      const stagesSumPct=useMemo(()=>stages.reduce((s,x)=>s+x.percent,0),[stages]);

      // Вычисляем данные по строкам
      const linesData=useMemo(()=>lines.map(line=>{
        const villa=catalog[line.projectId]?.villas[line.villaId];
        if(!villa) return null;

        const base=villa.baseUSD*(1-line.discountPct/100);
        const preTotalOne=base*line.prePct/100;
        const firstPostUSD=base*(100-line.prePct)/100;

        const preSchedule=stages.map(s=>({
          month:s.month,
          amountUSD:preTotalOne*s.percent/stagesSumPct
        }));

        const vMonths=line.ownTerms?line.months:months;
        const rate=line.ownTerms?line.monthlyRatePct/100:monthlyRatePct/100;

        const postRows=[];
        let remaining=firstPostUSD;
        for(let i=1;i<=vMonths;i++){
          const interest=remaining*rate;
          const principal=firstPostUSD/vMonths;
          const payment=principal+interest;
          remaining-=principal;
          postRows.push({month:i,principalUSD:principal,interestUSD:interest,paymentUSD:payment});
        }

        const postRowsQ=postRows.map(r=>({...r,principalUSD:r.principalUSD*line.qty,interestUSD:r.interestUSD*line.qty,paymentUSD:r.paymentUSD*line.qty}));
        const preTotal=preTotalOne*line.qty;
        const firstPostQ=firstPostUSD*line.qty;
        const baseQ=base*line.qty;
        const lineTotal=preTotal+firstPostQ;

        return {line,qty,baseOne:base,base:baseQ,preSchedule:preSchedule,preTotal,firstPostUSD:firstPostQ,postRows:postRowsQ,lineTotal,vMonths,rate,discountPct:line.discountPct};
      }),[lines,stages,stagesSumPct,handoverMonth,months,monthlyRatePct,lang]);

      const project=useMemo(()=>{
        const totals={
          baseUSD:linesData.reduce((s,x)=>s+x.base,0),
          preUSD: linesData.reduce((s,x)=>s+x.preTotal,0),
          firstPostUSD: linesData.reduce((s,x)=>s+x.firstPostUSD,0),
          lineTotal: linesData.reduce((s,x)=>s+x.lineTotal,0)
        };

        const cashflow=[];
        let balance=0;
        
        // Предоплата по этапам
        stages.forEach(s=>{
          const month=s.month;
          const amount=linesData.reduce((sum,ld)=>sum+ld.preSchedule.find(ps=>ps.month===month)?.amountUSD||0,0);
          balance+=amount;
          cashflow.push({month,amountUSD:amount,balanceUSD:balance,items:[`${s.label} (${s.percent}%)`]});
        });

        // Постоплата
        const maxPostMonth=Math.max(...linesData.map(ld=>ld.vMonths));
        for(let month=1;month<=maxPostMonth;month++){
          const amount=linesData.reduce((sum,ld)=>{
            const postRow=ld.postRows.find(pr=>pr.month===month);
            return sum+(postRow?.paymentUSD||0);
          },0);
          balance+=amount;
          cashflow.push({month:handoverMonth+month,amountUSD:amount,balanceUSD:balance,items:[`Постоплата месяц ${month}`]});
        }

        return {totals,cashflow};
      },[linesData,stages,handoverMonth]);

      // Функции для работы с проектами
      const addProject = () => {
        const projectId = generateId();
        const newProject = {
          id: projectId,
          name: newProjectForm.projectName,
          villas: {}
        };
        
        // Добавляем проект в каталог
        catalog[projectId] = newProject;
        
        setNewProjectForm({
          projectId: '',
          projectName: '',
          villas: []
        });
        setShowAddProjectModal(false);
      };

      const addVilla = () => {
        const villaId = generateId();
        const newVilla = {
          id: villaId,
          name: newVillaForm.villaName,
          area: newVillaForm.area,
          ppsm: newVillaForm.ppsm,
          baseUSD: newVillaForm.area * newVillaForm.ppsm
        };
        
        // Добавляем виллу в проект
        if (editingProject) {
          if (!catalog[editingProject.id]) {
            catalog[editingProject.id] = { id: editingProject.id, name: editingProject.name, villas: {} };
          }
          catalog[editingProject.id].villas[villaId] = newVilla;
        }
        
        setNewVillaForm({
          villaId: '',
          villaName: '',
          area: 0,
          ppsm: 0
        });
        setShowAddVillaModal(false);
      };

      // Функции для работы с этапами
      const addStage = () => {
        const newStage = {
          id: generateId(),
          label: `Этап ${stages.length + 1}`,
          percent: 0,
          month: stages.length + 1
        };
        setStages([...stages, newStage]);
      };

      const removeStage = (id) => {
        setStages(stages.filter(s => s.id !== id));
      };

      const updateStage = (id, field, value) => {
        setStages(stages.map(s => s.id === id ? { ...s, [field]: value } : s));
      };

      // Функции для работы со строками
      const addLine = () => {
        const newLine = {
          id: generateId(),
          projectId: Object.keys(catalog)[0],
          villaId: Object.keys(catalog[Object.keys(catalog)[0]]?.villas || {})[0],
          qty: 1,
          prePct: 70,
          ownTerms: false,
          months: null,
          monthlyRatePct: null,
          firstPostUSD: 0,
          discountPct: 0,
          snapshot: { name: '', area: 0, ppsm: 0, baseUSD: 0 }
        };
        setLines([...lines, newLine]);
      };

      const removeLine = (id) => {
        setLines(lines.filter(l => l.id !== id));
      };

      const updateLine = (id, updates) => {
        setLines(lines.map(l => l.id === id ? { ...l, ...updates } : l));
      };

      // Обновляем snapshot при изменении проекта/виллы
      useEffect(() => {
        setLines(lines.map(line => {
          const villa = catalog[line.projectId]?.villas[line.villaId];
          if (villa) {
            return {
              ...line,
              snapshot: {
                name: villa.name,
                area: villa.area,
                ppsm: villa.ppsm,
                baseUSD: villa.baseUSD
              }
            };
          }
          return line;
        }));
      }, [catalog]);

      return (
        <div className="app">
          <div className="tabs">
            <div className={`tab ${tab==='calc'?'active':''}`} onClick={()=>setTab('calc')}>{t.villasTitle}</div>
            <div className={`tab ${tab==='catalog'?'active':''}`} onClick={()=>setTab('catalog')}>Каталог проектов и вилл (редактор)</div>
          </div>

          {tab==='calc'?(
            <div className="grid">
              <div className="card">
                <h3>Настройки расчета</h3>
                
                {/* Компактное расположение полей в одну строку */}
                <div className="row">
                  <div className="field-compact">
                    <label>{t.lang}</label>
                    <select value={lang} onChange={e=>setLang(e.target.value)}>
                      <option value="ru">Русский</option>
                      <option value="en">English</option>
                    </select>
                  </div>
                  <div className="field-compact">
                    <label>{t.currencyDisplay}</label>
                    <select value={currency} onChange={e=>setCurrency(e.target.value)}>
                      <option>USD</option>
                      <option>IDR</option>
                      <option>EUR</option>
                    </select>
                  </div>
                </div>

                {/* Компактное расположение полей в одну строку */}
                <div className="row">
                  <div className="field-compact">
                    <label>{t.handoverMonth}</label>
                    <input type="number" min="1" step="1" value={handoverMonth} onChange={e=>setHandoverMonth(clamp(parseInt(e.target.value||0,10),1,120))}/>
                  </div>
                  {!isClient ? (
                    <div className="field-compact">
                      <label>{t.globalTerm}</label>
                      <input type="range" min="6" max="24" step="1" value={months} onChange={e=>setMonths(parseInt(e.target.value,10))}/>
                      <div className="pill">{months} мес</div>
                    </div>
                  ) : null}
                </div>

                <div className="field">
                  <label>{t.monthlyRate}</label>
                  <input type="range" min="0" max="20" step="0.1" value={monthlyRatePct} onChange={e=>setMonthlyRatePct(parseFloat(e.target.value))}/>
                  <div className="pill">{monthlyRatePct}%</div>
                </div>

                <div className="hr"></div>

                <div className="table-container">
                  <div className="table-header">
                    <h4 className="table-title">{t.stagesTitle}</h4>
                    <div className="table-actions">
                      <button className="btn success" onClick={addStage}>+ {t.addStage}</button>
                    </div>
                  </div>
                  
                  <div className="scroll" style={{maxHeight:'26vh'}}>
                    <table className="stages-table">
                      <thead>
                        <tr>
                          <th>{t.stage}</th>
                          <th className="stage-percent">{t.percent}</th>
                          <th className="stage-month">{t.month}</th>
                          <th className="stage-actions"></th>
                        </tr>
                      </thead>
                      <tbody>
                        {stages.map(s=>(
                          <tr key={s.id}>
                            <td>
                              <input 
                                type="text" 
                                className="stage-input"
                                value={s.label} 
                                onChange={e=>updateStage(s.id,'label',e.target.value)}
                              />
                            </td>
                            <td>
                              <input 
                                type="number" 
                                className="stage-input stage-percent"
                                min="0" 
                                max="100" 
                                step="1" 
                                value={s.percent} 
                                onChange={e=>updateStage(s.id,'percent',parseInt(e.target.value)||0)}
                              />
                            </td>
                            <td>
                              <input 
                                type="number" 
                                className="stage-input stage-month"
                                min="1" 
                                step="1" 
                                value={s.month} 
                                onChange={e=>updateStage(s.id,'month',parseInt(e.target.value)||1)}
                              />
                            </td>
                            <td>
                              <button className="btn warn icon" onClick={()=>removeStage(s.id)}>×</button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  
                  {stagesSumPct!==100 && (
                    <div className="hint warn">Сумма этапов: {stagesSumPct}% (должно быть 100%)</div>
                  )}
                </div>
              </div>

              <div className="card">
                <div className="calculation-header">
                  <h3>{t.villasTitle}</h3>
                  {!isClient && (
                    <button className="btn success" onClick={()=>setModalOpen(true)}>{t.addFromCatalog}</button>
                  )}
                </div>

                <div className="calc-scroll">
                  <table className="calc-table">
                    <thead>
                      <tr>
                        <th className="col-project">{t.project}</th>
                        <th className="col-villa">{t.villa}</th>
                        <th className="col-qty">{t.qty}</th>
                        <th className="col-area">{t.area}</th>
                        <th className="col-ppsm">{t.ppsm}</th>
                        <th className="col-base">{t.base}</th>
                        <th className="col-disc">{t.discount}</th>
                        <th className="col-pre">{t.prePct}</th>
                        <th className="col-post">{t.postPct}</th>
                        <th className="col-total">{t.total}</th>
                        <th className="col-actions"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {linesData.map(ld=>ld?(
                        <tr key={ld.line.id}>
                          <td className="col-project">
                            <select 
                              value={ld.line.projectId} 
                              onChange={e=>updateLine(ld.line.id,{projectId:e.target.value})}
                              style={{width:'100%',minWidth:'100px'}}
                            >
                              {Object.values(catalog).map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                          </td>
                          <td className="col-villa">
                            <select 
                              value={ld.line.villaId} 
                              onChange={e=>updateLine(ld.line.id,{villaId:e.target.value})}
                              style={{width:'100%',minWidth:'120px'}}
                            >
                              {catalog[ld.line.projectId]?.villas?Object.values(catalog[ld.line.projectId].villas).map(v=><option key={v.id} value={v.id}>{v.name}</option>):null}
                            </select>
                          </td>
                          <td className="col-qty">
                            <input 
                              type="number" 
                              min="1" 
                              step="1" 
                              value={ld.qty} 
                              onChange={e=>updateLine(ld.line.id,{qty:parseInt(e.target.value,10)})}
                              style={{width:'100%',minWidth:'50px'}}
                            />
                          </td>
                          <td className="col-area">
                            <div className="pill">{ld.line.snapshot.area}</div>
                          </td>
                          <td className="col-ppsm">
                            <div className="pill">{ld.line.snapshot.ppsm}</div>
                          </td>
                          <td className="col-base">
                            <div className="pill">{fmtMoney(ld.baseOne)}</div>
                          </td>
                          <td className="col-disc">
                            <input 
                              type="range" 
                              min="0" 
                              max="50" 
                              step="1" 
                              value={ld.line.discountPct||0} 
                              onChange={e=>updateLine(ld.line.id,{discountPct:parseInt(e.target.value,10)})}
                              style={{width:'100%',minWidth:'60px'}}
                            />
                            <div className="pill">{ld.line.discountPct||0}%</div>
                          </td>
                          <td className="col-pre">
                            <input 
                              type="range" 
                              min="0" 
                              max="100" 
                              step="1" 
                              value={ld.line.prePct||0} 
                              onChange={e=>updateLine(ld.line.id,{prePct:parseInt(e.target.value,10)})}
                              style={{width:'100%',minWidth:'80px'}}
                            />
                            <div className="pill">{ld.line.prePct||0}%</div>
                          </td>
                          <td className="col-post">
                            <div className="pill">{100-(ld.line.prePct||0)}%</div>
                          </td>
                          <td className="col-total">
                            <div className="pill">{fmtMoney(ld.lineTotal)}</div>
                          </td>
                          <td className="col-actions">
                            <button className="btn warn icon" onClick={()=>removeLine(ld.line.id)}>×</button>
                          </td>
                        </tr>
                      ):null)}
                    </tbody>
                  </table>
                </div>

                <div className="row" style={{justifyContent:'space-between',alignItems:'center',marginTop:'var(--spacing-md)'}}>
                  <button className="btn success" onClick={addLine}>+ Добавить позицию</button>
                  
                  <div className="row" style={{gap:'var(--spacing-sm)'}}>
                    <button className="btn primary" onClick={()=>share('editor')}>{t.shareEditor}</button>
                    <button className="btn" onClick={()=>share('client')}>{t.shareClient}</button>
                  </div>
                </div>

                <div className="hr"></div>

                <div className="kpis">
                  <div className="kpi">
                    <div className="v">{fmtMoney(project.totals.baseUSD,currency)}</div>
                    <div className="muted">База</div>
                  </div>
                  <div className="kpi">
                    <div className="v">{fmtMoney(project.totals.preUSD,currency)}</div>
                    <div className="muted">Предоплата</div>
                  </div>
                  <div className="kpi">
                    <div className="v">{fmtMoney(project.totals.firstPostUSD,currency)}</div>
                    <div className="muted">Постоплата</div>
                  </div>
                  <div className="kpi">
                    <div className="v">{fmtMoney(project.totals.lineTotal,currency)}</div>
                    <div className="muted">Итого</div>
                  </div>
                </div>

                <div className="hr"></div>

                <div className="table-container">
                  <div className="table-header">
                    <h4 className="table-title">Сводный кэшфлоу по месяцам</h4>
                    <div className="table-actions">
                      <button className="btn" onClick={exportXLSX}>{t.exportXLSX}</button>
                      <button className="btn" onClick={exportPDF}>{t.exportPDF}</button>
                    </div>
                  </div>

                  <div className="scroll">
                    <table className="cashflow-table">
                      <thead>
                        <tr>
                          <th className="cashflow-month">{t.cashMonth}</th>
                          <th className="cashflow-desc">{t.cashDesc}</th>
                          <th className="cashflow-amount">{t.cashTotal}</th>
                          <th className="cashflow-balance">{t.cashBalance}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {project.cashflow.map(c=>(
                          <tr key={c.month}>
                            <td className="cashflow-month">{c.month}</td>
                            <td className="cashflow-desc">{(c.items||[]).join(' + ')}</td>
                            <td className="cashflow-amount">{fmtMoney(toCurrency(c.amountUSD),currency)}</td>
                            <td className="cashflow-balance">{fmtMoney(toCurrency(c.balanceUSD),currency)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          ):(
            <div className="card">
              <div className="catalog-header">
                <h3 className="catalog-title">Каталог проектов и вилл</h3>
                <div className="row" style={{gap:'var(--spacing-md)'}}>
                  <button className="btn success" onClick={()=>setShowAddProjectModal(true)}>{t.addProject}</button>
                  <button className="btn" onClick={()=>{}}>{t.importJSON}</button>
                  <button className="btn" onClick={()=>{}}>{t.exportJSON}</button>
                </div>
              </div>

              <div className="catalog-projects">
                {Object.values(catalog).map(project=>(
                  <div key={project.id} className="catalog-item">
                    <div className="catalog-header">
                      <h4 className="catalog-title">{project.name}</h4>
                      <div className="row" style={{gap:'var(--spacing-sm)'}}>
                        <button className="btn icon" onClick={()=>{setEditingProject(project);setShowAddVillaModal(true)}}>+</button>
                        <button className="btn warn icon" onClick={()=>{}}>×</button>
                      </div>
                    </div>
                    
                    <div className="catalog-villas">
                      {Object.values(project.villas).map(villa=>(
                        <div key={villa.id} className="villa-item">
                          <div className="villa-name">{villa.name}</div>
                          <div className="villa-area">{villa.area}</div>
                          <div className="villa-ppsm">{villa.ppsm}</div>
                          <div className="villa-base">{fmtMoney(villa.baseUSD)}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Модальное окно добавления проекта */}
          {showAddProjectModal && (
            <div className="modal-overlay" onClick={()=>setShowAddProjectModal(false)}>
              <div className="modal-content" onClick={e=>e.stopPropagation()}>
                <div className="modal-header">
                  <h3 className="modal-title">{t.addProject}</h3>
                  <button className="modal-close" onClick={()=>setShowAddProjectModal(false)}>×</button>
                </div>
                <div className="modal-body">
                  <div className="form-section">
                    <div className="form-group">
                      <label>{t.projectName}</label>
                      <input 
                        type="text" 
                        placeholder="Название проекта"
                        value={newProjectForm.projectName}
                        onChange={e => setNewProjectForm(prev => ({ ...prev, projectName: e.target.value }))}
                      />
                    </div>
                  </div>
                </div>
                <div className="form-actions">
                  <button className="btn" onClick={()=>setShowAddProjectModal(false)}>{t.cancel}</button>
                  <button className="btn success" onClick={addProject}>{t.save}</button>
                </div>
              </div>
            </div>
          )}

          {/* Модальное окно добавления виллы */}
          {showAddVillaModal && (
            <div className="modal-overlay" onClick={()=>setShowAddVillaModal(false)}>
              <div className="modal-content" onClick={e=>e.stopPropagation()}>
                <div className="modal-header">
                  <h3 className="modal-title">Добавить виллу</h3>
                  <button className="modal-close" onClick={()=>setShowAddVillaModal(false)}>×</button>
                </div>
                <div className="modal-body">
                  <div className="form-section">
                    <div className="form-row">
                      <div className="form-group">
                        <label>{t.villaName}</label>
                        <input 
                          type="text" 
                          placeholder="Название виллы"
                          value={newVillaForm.villaName}
                          onChange={e => setNewVillaForm(prev => ({ ...prev, villaName: e.target.value }))}
                        />
                      </div>
                      <div className="form-group">
                        <label>{t.villaArea}</label>
                        <input 
                          type="number" 
                          min="0" 
                          step="1" 
                          placeholder="100"
                          value={newVillaForm.area}
                          onChange={e => setNewVillaForm(prev => ({ ...prev, area: parseFloat(e.target.value) || 0 }))}
                        />
                      </div>
                    </div>
                    <div className="form-group">
                      <label>{t.villaPpsm}</label>
                      <input 
                        type="number" 
                        min="0" 
                        step="1" 
                        placeholder="2500"
                        value={newVillaForm.ppsm}
                        onChange={e => setNewVillaForm(prev => ({ ...prev, ppsm: parseFloat(e.target.value) || 0 }))}
                      />
                    </div>
                  </div>
                </div>
                <div className="form-actions">
                  <button className="btn" onClick={()=>setShowAddVillaModal(false)}>{t.cancel}</button>
                  <button className="btn success" onClick={addVilla}>{t.save}</button>
                </div>
              </div>
            </div>
          )}

          {/* Модальное окно добавления из каталога */}
          {modalOpen && (
            <div className="modal-overlay" onClick={()=>setModalOpen(false)}>
              <div className="modal-content" onClick={e=>e.stopPropagation()}>
                <div className="modal-header">
                  <h3 className="modal-title">Добавить из каталога</h3>
                  <button className="modal-close" onClick={()=>setModalOpen(false)}>×</button>
                </div>
                <div className="modal-body">
                  <div className="form-section">
                    <div className="form-group">
                      <label>Проект</label>
                      <select 
                        value={newProjectForm.projectId}
                        onChange={e => setNewProjectForm(prev => ({ ...prev, projectId: e.target.value }))}
                      >
                        <option value="">Выберите проект</option>
                        {Object.values(catalog).map(project => (
                          <option key={project.id} value={project.id}>{project.name}</option>
                        ))}
                      </select>
                    </div>
                    {newProjectForm.projectId && (
                      <div className="form-group">
                        <label>Вилла</label>
                        <select 
                          value={newProjectForm.villaId}
                          onChange={e => setNewProjectForm(prev => ({ ...prev, villaId: e.target.value }))}
                        >
                          <option value="">Выберите виллу</option>
                          {catalog[newProjectForm.projectId]?.villas && Object.values(catalog[newProjectForm.projectId].villas).map(villa => (
                            <option key={villa.id} value={villa.id}>{villa.name}</option>
                          ))}
                        </select>
                      </div>
                    )}
                    {newProjectForm.villaId && (
                      <div className="form-group">
                        <label>Количество</label>
                        <input 
                          type="number" 
                          min="1" 
                          step="1" 
                          value={newProjectForm.qty || 1}
                          onChange={e => setNewProjectForm(prev => ({ ...prev, qty: parseInt(e.target.value) || 1 }))}
                        />
                      </div>
                    )}
                  </div>
                </div>
                <div className="form-actions">
                  <button className="btn" onClick={()=>setModalOpen(false)}>{t.cancel}</button>
                  <button 
                    className="btn success" 
                    onClick={()=>{
                      if(newProjectForm.projectId && newProjectForm.villaId){
                        const villa = catalog[newProjectForm.projectId].villas[newProjectForm.villaId];
                        const newLine = {
                          id: generateId(),
                          projectId: newProjectForm.projectId,
                          villaId: newProjectForm.villaId,
                          qty: newProjectForm.qty || 1,
                          prePct: 70,
                          ownTerms: false,
                          months: null,
                          monthlyRatePct: null,
                          firstPostUSD: 0,
                          discountPct: 0,
                          snapshot: {
                            name: villa.name,
                            area: villa.area,
                            ppsm: villa.ppsm,
                            baseUSD: villa.baseUSD
                          }
                        };
                        setLines([...lines, newLine]);
                        setModalOpen(false);
                        setNewProjectForm({projectId: '', projectName: '', villas: []});
                      }
                    }}
                    disabled={!newProjectForm.projectId || !newProjectForm.villaId}
                  >
                    {t.addProject}
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Рендерим приложение
    ReactDOM.render(<App/>,document.getElementById('root'));
  </script>
</body>
</html>
