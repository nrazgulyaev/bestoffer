<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arconique / Калькулятор рассрочки для любимых клиентов — v8.2</title>
    
    <!-- CDN библиотеки -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * { box-sizing: border-box; }
        
        :root {
            /* Современная цветовая палитра */
            --bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            --card: rgba(255,255,255,0.03);
            --card-hover: rgba(255,255,255,0.08);
            --card-active: rgba(255,255,255,0.12);
            --line: rgba(255,255,255,0.08);
            --line-hover: rgba(255,255,255,0.15);
            --muted: #94a3b8;
            --ink: #f8fafc;
            --ink-secondary: #cbd5e1;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --success-hover: #059669;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --radius: 16px;
            --radius-sm: 8px;
            --radius-lg: 24px;
            
            /* Современные тени */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Анимации */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Отступы и размеры */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Высота блоков */
            --block-min-height: 200px;
            --block-max-height: 600px;
            
            /* Z-index слои */
            --z-base: 1;
            --z-card: 10;
            --z-modal: 1000;
            --z-tooltip: 1100;
        }
        
        /* Базовые стили */
        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--ink);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        /* Современные анимации для элементов */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-8px) rotate(0.5deg); }
            66% { transform: translateY(4px) rotate(-0.5deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Современные компоненты */
        .wrap {
            max-width: 1400px;
            margin: 24px auto;
            padding: 0 16px;
            animation: fadeInUp 0.8s ease-out;
        }
        
        h1 {
            margin: 0 0 16px;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 700;
            background: linear-gradient(135deg, var(--ink) 0%, var(--ink-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }
        
        /* Современная сетка */
        .grid {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 24px;
            animation: fadeInScale 0.6s ease-out 0.2s both;
        }
        
        @media (max-width: 1023px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        
        /* Современные карточки */
        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            backdrop-filter: blur(20px);
            transition: all var(--transition-normal);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            background: var(--card-hover);
            border-color: var(--line-hover);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--success));
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        /* Утилиты */
        .row {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }
        
        .hr {
            height: 1px;
            background: var(--line);
            margin: var(--spacing-lg) 0;
            border-radius: 1px;
        }
        
        .muted {
            color: var(--muted);
            font-size: 0.9em;
        }
        
        /* Поля ввода */
        .field {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .field.compact {
            flex: 1;
        }
        
        .field label {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--ink-secondary);
        }
        
        .field input,
        .field select {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--ink);
            font-size: 0.9em;
            transition: all var(--transition-fast);
            backdrop-filter: blur(10px);
        }
        
        .field input:focus,
        .field select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .field input[type="range"] {
            background: var(--line);
            height: 6px;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .field input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all var(--transition-fast);
        }
        
        .field input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }
        
        /* Кнопки */
        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-sm);
            background: var(--line);
            color: var(--ink);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            backdrop-filter: blur(10px);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            white-space: nowrap;
        }
        
        .btn:hover {
            background: var(--line-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .btn.primary:hover {
            background: var(--primary-hover);
        }
        
        .btn.success {
            background: var(--success);
            color: white;
        }
        
        .btn.success:hover {
            background: var(--success-hover);
        }
        
        .btn.warning {
            background: var(--warning);
            color: white;
        }
        
        .btn.warning:hover {
            background: var(--warning-hover);
        }
        
        .btn.danger {
            background: var(--danger);
            color: white;
        }
        
        .btn.danger:hover {
            background: var(--danger-hover);
        }
        
        .btn.icon {
            padding: var(--spacing-sm);
            min-width: 36px;
            justify-content: center;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Бейджи и пилюли */
        .badge {
            background: var(--line);
            color: var(--ink-secondary);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .pill {
            background: var(--primary);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.8em;
            font-weight: 500;
        }
        
        /* KPI блоки */
        .kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-md);
            margin: var(--spacing-lg) 0;
        }
        
        .kpi {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            text-align: center;
            transition: all var(--transition-normal);
            animation: fadeInScale 0.6s ease-out both;
        }
        
        .kpi:hover {
            background: var(--card-hover);
            border-color: var(--line-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .kpi .muted {
            font-size: 0.8em;
            margin-bottom: var(--spacing-sm);
            display: block;
        }
        
        .kpi .v {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--ink);
        }
        
        /* Таблицы */
        .calc-table,
        .stages-table,
        .cashflow-table,
        .catalog-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--spacing-md) 0;
            background: var(--card);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .calc-table th,
        .calc-table td,
        .stages-table th,
        .stages-table td,
        .cashflow-table th,
        .cashflow-table td,
        .catalog-table th,
        .catalog-table td {
            padding: var(--spacing-sm);
            text-align: center;
            border-bottom: 1px solid var(--line);
            font-size: 0.9em;
        }
        
        .calc-table th,
        .stages-table th,
        .cashflow-table th,
        .catalog-table th {
            background: var(--line);
            color: var(--ink-secondary);
            font-weight: 600;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .calc-table tr:hover,
        .stages-table tr:hover,
        .cashflow-table tr:hover,
        .catalog-table tr:hover {
            background: var(--card-hover);
        }
        
        /* Оптимизированные колонки для таблиц */
        .col-project { width: 15%; }
        .col-villa { width: 15%; }
        .col-qty { width: 8%; }
        .col-area { width: 10%; }
        .col-ppsm { width: 12%; }
        .col-base { width: 12%; }
        .col-disc { width: 8%; }
        .col-pre { width: 10%; }
        .col-months { width: 8%; }
        .col-rate { width: 8%; }
        .col-first { width: 0%; display: none; } /* Скрыта */
        .col-lineTotal { width: 12%; }
        .col-actions { width: 8%; }
        
        .col-stage { width: 30%; }
        .col-percent { width: 25%; }
        .col-month { width: 25%; }
        .col-actions { width: 20%; }
        
        /* Стили для отображения данных в таблицах */
        .project-name-display,
        .villa-name-display,
        .area-display,
        .ppsm-display,
        .base-strong,
        .line-total {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            color: var(--ink);
            font-weight: 500;
            text-align: center;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Стили для ползунков в этапах */
        .stage-number-input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--ink);
            text-align: center;
            font-size: 0.9em;
        }
        
        .stage-number-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Стили для этапов */
        .stage-input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--ink);
            font-size: 0.9em;
        }
        
        .stage-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .delete-stage-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.8em;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .delete-stage-btn:hover {
            background: var(--danger-hover);
            transform: scale(1.05);
        }
        
        /* Стили для каталога */
        .catalog-card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .catalog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .catalog-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .catalog-table input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--ink);
            font-size: 0.9em;
            text-align: center;
        }
        
        .catalog-table input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Стили для модальных окон */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            animation: fadeInScale 0.3s ease-out;
        }
        
        .modal-content {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            position: relative;
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: var(--radius) var(--radius) 0 0;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--ink);
        }
        
        .modal-body {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-section {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-section h4 {
            margin: 0 0 var(--spacing-sm);
            color: var(--ink-secondary);
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .form-row {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--ink-secondary);
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--ink);
            font-size: 0.9em;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
        }
        
        /* Стили для умных вкладок */
        .smart-tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            background: var(--line);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
        }
        
        .smart-tab {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--ink-secondary);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }
        
        .smart-tab:hover {
            color: var(--ink);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .smart-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .tab-icon {
            font-size: 1.1em;
        }
        
        .tab-label {
            font-weight: 600;
        }
        
        .tab-counter {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        /* Стили для групп настроек */
        .settings-group {
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .settings-header {
            background: var(--line);
            padding: var(--spacing-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transition: all var(--transition-fast);
        }
        
        .settings-header:hover {
            background: var(--line-hover);
        }
        
        .group-icon {
            font-size: 1.1em;
        }
        
        .group-title {
            flex: 1;
            font-weight: 600;
            color: var(--ink);
        }
        
        .group-toggle {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--ink-secondary);
            transition: transform var(--transition-fast);
        }
        
        .settings-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-slow);
            background: var(--card);
        }
        
        .settings-content.expanded {
            max-height: 800px;
            padding: var(--spacing-md);
        }
        
        /* Стили для мобильной навигации */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--line);
            padding: var(--spacing-sm);
            display: none;
            justify-content: space-around;
            backdrop-filter: blur(20px);
            z-index: var(--z-card);
        }
        
        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            background: none;
            border: none;
            color: var(--ink-secondary);
            font-size: 0.8em;
            cursor: pointer;
            transition: all var(--transition-fast);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
        }
        
        .mobile-nav-btn:hover,
        .mobile-nav-btn.active {
            color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .mobile-nav-btn span {
            font-size: 0.7em;
        }
        
        /* Стили для индикатора автосохранения */
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: var(--shadow);
            z-index: var(--z-tooltip);
            display: none;
            animation: slideInLeft 0.3s ease-out;
        }
        
        /* Стили для полной ширины блока */
        .full-width-block {
            width: 100%;
            margin-top: var(--spacing-xl);
        }
        
        /* Стили для отображения месяцев с реальными датами */
        .month-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .month-number {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .month-date {
            font-size: 0.8em;
            color: var(--muted);
        }
        
        /* Стили для заголовка расчета */
        .calculation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        /* Стили для подсказок */
        .hint {
            font-size: 0.8em;
            color: var(--ink-secondary);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            background: var(--line);
        }
        
        .hint.warn {
            color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .wrap {
                margin: 16px auto;
                padding: 0 12px;
            }
            
            .card {
                padding: var(--spacing-md);
            }
            
            .kpis {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-sm);
            }
            
            .kpi .v {
                font-size: 1.2em;
            }
            
            .form-row {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .modal-content {
                width: 95%;
                padding: var(--spacing-md);
            }
            
            .mobile-nav {
                display: flex;
            }
        }
        
        @media (max-width: 480px) {
            .kpis {
                grid-template-columns: 1fr;
            }
            
            .smart-tabs {
                flex-direction: column;
            }
            
            .catalog-header {
                flex-direction: column;
                gap: var(--spacing-sm);
                align-items: stretch;
            }
        }
        
        /* Анимации для элементов */
        .animate-fade-in {
            animation: fadeInUp 0.6s ease-out both;
        }
        
        .animate-fade-in:nth-child(2) { animation-delay: 0.1s; }
        .animate-fade-in:nth-child(3) { animation-delay: 0.2s; }
        .animate-fade-in:nth-child(4) { animation-delay: 0.3s; }
        .animate-fade-in:nth-child(5) { animation-delay: 0.4s; }
    </style>
    
    <!-- Диагностика загрузки -->
    <script>
        (function() {
            let attempts = 0;
            const maxAttempts = 10;
            
            function checkDependencies() {
                attempts++;
                console.log(`Проверка зависимостей... Попытка ${attempts}/${maxAttempts}`);
                
                if (window.React && window.ReactDOM && window.Babel) {
                    console.log('✅ Все зависимости загружены успешно');
                    return true;
                }
                
                if (attempts >= maxAttempts) {
                    console.error('❌ Не удалось загрузить зависимости после', maxAttempts, 'попыток');
                    document.body.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #ef4444;">
                            <h2>Ошибка загрузки</h2>
                            <p>Не удалось загрузить React или Babel. Попробуйте обновить страницу.</p>
                            <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Обновить страницу
                            </button>
                        </div>
                    `;
                    return false;
                }
                
                setTimeout(checkDependencies, 1000);
                return false;
            }
            
            if (!checkDependencies()) {
                // Попытка загрузки альтернативных CDN
                if (!window.React) {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js';
                    script.crossOrigin = 'anonymous';
                    document.head.appendChild(script);
                }
                
                if (!window.ReactDOM) {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js';
                    script.crossOrigin = 'anonymous';
                    document.head.appendChild(script);
                }
                
                if (!window.Babel) {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.20/babel.min.js';
                    document.head.appendChild(script);
                }
            }
        })();
    </script>
</head>
<body>
    <div id="root"></div>
    <div id="auto-save-indicator"></div>
    
    <script type="text/babel">
                // Основное приложение
        function App() {
            // Состояние приложения
            const [lang, setLang] = useState('ru');
            const [currency, setCurrency] = useState('USD');
            const [idrPerUsd, setIdrPerUsd] = useState(15000);
            const [eurPerUsd, setEurPerUsd] = useState(0.85);
            const [handoverMonth, setHandoverMonth] = useState(12);
            const [months, setMonths] = useState(12);
            const [monthlyRatePct, setMonthlyRatePct] = useState(0.5);
            const [stages, setStages] = useState([
                { id: 1, label: 'Этап', pct: 30, month: 0, realDate: 'Январь 2025' },
                { id: 2, label: 'Этап', pct: 40, month: 6, realDate: 'Июль 2025' },
                { id: 3, label: 'Этап', pct: 30, month: 12, realDate: 'Январь 2026' }
            ]);
            const [catalog, setCatalog] = useState([
                {
                    projectId: 'P001',
                    projectName: 'Проект А',
                    villas: [
                        { villaId: 'V001', name: 'Вилла 1', area: 150, ppsm: 2000, baseUSD: 300000 },
                        { villaId: 'V002', name: 'Вилла 2', area: 200, ppsm: 2500, baseUSD: 500000 }
                    ]
                }
            ]);
            const [lines, setLines] = useState([
                {
                    id: 1,
                    projectId: 'P001',
                    villaId: 'V001',
                    snapshot: { name: 'Вилла 1', area: 150, ppsm: 2000, baseUSD: 300000 },
                    qty: 1,
                    discountPct: 0,
                    prePct: 70,
                    months: 12,
                    ownTerms: false,
                    monthlyRatePct: null,
                    firstPostUSD: 0
                }
            ]);
            const [tab, setTab] = useState('overview');
            const [isClient, setIsClient] = useState(false);
            const [modalOpen, setModalOpen] = useState(false);
            
            // Новые состояния для улучшений
            const [showAddProjectModal, setShowAddProjectModal] = useState(false);
            const [showAddVillaModal, setShowAddVillaModal] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [newProjectForm, setNewProjectForm] = useState({ projectId: '', projectName: '' });
            const [newVillaForm, setNewVillaForm] = useState({ villaId: '', name: '', area: 0, ppsm: 0 });
            const [autoSaveStatus, setAutoSaveStatus] = useState('idle');
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
            const [expandedGroups, setExpandedGroups] = useState({
                basic: true,
                stages: true
            });
            const [notes, setNotes] = useState([]);
            const [tags, setTags] = useState([]);
            const [templates, setTemplates] = useState([]);
            const [history, setHistory] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(-1);
            
            // Рефы
            const chartRef = useRef(null);
            
            // Переводы
            const T = {
                ru: {
                    title: 'Arconique / Калькулятор рассрочки для любимых клиентов',
                    overview: 'Обзор',
                    stages: 'Этапы',
                    settings: 'Параметры',
                    lang: 'Язык интерфейса',
                    currencyDisplay: 'Валюта отображения',
                    idrRate: 'Курс IDR/USD',
                    eurRate: 'Курс EUR/USD',
                    handoverMonth: 'Месяц получения ключей',
                    globalRate: 'Глобальная ставка, %/мес',
                    globalTerm: 'Глобальный срок post‑handover (6–24 мес)',
                    clientTerm: 'Срок рассрочки (мес)',
                    months: 'мес',
                    stagesTitle: 'Базовая рассрочка',
                    stage: 'Этап',
                    percent: 'Процент',
                    month: 'Месяц',
                    addStage: 'Добавить этап',
                    sumStages: 'Сумма этапов',
                    targetPrepay: 'Целевая предоплата',
                    mismatch: '(не совпадает)',
                    mixedTargets: '(разные цели)',
                    lines: 'Выбрано вилл',
                    keys: 'Ключи через',
                    cashflowTitle: 'Сводный кэшфлоу по месяцам',
                    chartTitle: 'График платежей',
                    villasTitle: 'Расчёт (позиции)',
                    project: 'Проект',
                    villa: 'Вилла',
                    qty: 'Кол-во',
                    area: 'Площадь',
                    ppsm: 'Цена за м²',
                    price: 'Базовая стоимость (USD)',
                    discount: 'Скидка, %',
                    prePct: 'До ключей, %',
                    months: 'Срок рассрочки',
                    rate: 'Ставка, %/мес',
                    firstPost: 'Первый платёж',
                    lineTotal: 'Итоговая стоимость',
                    addFromCatalog: 'Добавить из каталога',
                    selectFromCatalog: 'Выбрать из каталога',
                    search: 'Поиск',
                    areaFrom: 'Площадь от',
                    areaTo: 'до',
                    priceFrom: 'Цена от',
                    priceTo: 'до',
                    addSelected: 'Добавить выбранные',
                    cancel: 'Отмена',
                    save: 'Сохранить',
                    addProject: 'Добавить проект',
                    addVilla: 'Добавить виллу',
                    projectName: 'Название проекта',
                    villaName: 'Название виллы',
                    villaArea: 'Площадь виллы',
                    villaPpsm: 'Цена за м²',
                    remove: 'Удалить',
                    catalogTitle: 'Каталог проектов и вилл (редактор)',
                    importJSON: 'Импорт JSON',
                    exportJSON: 'Экспорт JSON',
                    exportCSV: 'Экспорт CSV',
                    exportXLSX: 'Экспорт XLSX',
                    exportPDF: 'Экспорт PDF',
                    share: 'Поделиться',
                    editor: 'редактор',
                    client: 'клиент',
                    copied: 'Скопировано в буфер обмена',
                    shareText: 'Калькулятор рассрочки Arconique',
                    saving: 'Сохранение...',
                    saved: 'Сохранено',
                    undo: 'Отменить',
                    redo: 'Повторить',
                    base: 'Базовая стоимость',
                    prepay: 'Оплата до ключей',
                    after: 'После получения ключей',
                    interestTotal: 'Общая сумма процентов',
                    final: 'Итоговая стоимость',
                    cashMonth: 'Месяц',
                    cashDesc: 'Описание',
                    cashTotal: 'Сумма',
                    cashBalance: 'Баланс',
                    editor: 'Редактор',
                    client: 'Клиент'
                },
                en: {
                    title: 'Arconique / Installment Calculator for Beloved Clients',
                    overview: 'Overview',
                    stages: 'Stages',
                    settings: 'Parameters',
                    lang: 'Interface Language',
                    currencyDisplay: 'Display Currency',
                    idrRate: 'IDR/USD Rate',
                    eurRate: 'EUR/USD Rate',
                    handoverMonth: 'Keys Handover Month',
                    globalRate: 'Global Rate, %/month',
                    globalTerm: 'Global Post-handover Term (6-24 months)',
                    clientTerm: 'Installment Term (months)',
                    months: 'months',
                    stagesTitle: 'Base Installment',
                    stage: 'Stage',
                    percent: 'Percent',
                    month: 'Month',
                    addStage: 'Add Stage',
                    sumStages: 'Stages Sum',
                    targetPrepay: 'Target Prepayment',
                    mismatch: '(mismatch)',
                    mixedTargets: '(different targets)',
                    lines: 'Selected Villas',
                    keys: 'Keys in',
                    cashflowTitle: 'Monthly Cashflow Summary',
                    chartTitle: 'Payment Chart',
                    villasTitle: 'Calculation (Positions)',
                    project: 'Project',
                    villa: 'Villa',
                    qty: 'Qty',
                    area: 'Area',
                    ppsm: 'Price per m²',
                    price: 'Base Price (USD)',
                    discount: 'Discount, %',
                    prePct: 'Pre-keys, %',
                    months: 'Installment Term',
                    rate: 'Rate, %/month',
                    firstPost: 'First Payment',
                    lineTotal: 'Line Total',
                    addFromCatalog: 'Add from Catalog',
                    selectFromCatalog: 'Select from Catalog',
                    search: 'Search',
                    areaFrom: 'Area from',
                    areaTo: 'to',
                    priceFrom: 'Price from',
                    priceTo: 'to',
                    addSelected: 'Add Selected',
                    cancel: 'Cancel',
                    save: 'Save',
                    addProject: 'Add Project',
                    addVilla: 'Add Villa',
                    projectName: 'Project Name',
                    villaName: 'Villa Name',
                    villaArea: 'Villa Area',
                    villaPpsm: 'Price per m²',
                    remove: 'Remove',
                    catalogTitle: 'Projects and Villas Catalog (Editor)',
                    importJSON: 'Import JSON',
                    exportJSON: 'Export JSON',
                    exportCSV: 'Export CSV',
                    exportXLSX: 'Export XLSX',
                    exportPDF: 'Export PDF',
                    share: 'Share',
                    editor: 'editor',
                    client: 'client',
                    copied: 'Copied to clipboard',
                    shareText: 'Arconique Installment Calculator',
                    saving: 'Saving...',
                    saved: 'Saved',
                    undo: 'Undo',
                    redo: 'Redo',
                    base: 'Base Price',
                    prepay: 'Pre-keys Payment',
                    after: 'After Keys',
                    interestTotal: 'Total Interest',
                    final: 'Final Price',
                    cashMonth: 'Month',
                    cashDesc: 'Description',
                    cashTotal: 'Amount',
                    cashBalance: 'Balance',
                    editor: 'Editor',
                    client: 'Client'
                }
            };
            
            const t = T[lang];
            
            // Функция для хеширования PIN
            async function sha256Hex(message) {
                if (window.crypto && window.crypto.subtle) {
                    const msgBuffer = new TextEncoder().encode(message);
                    const hashBuffer = await window.crypto.subtle.digest('SHA-256', msgBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    return hashHex;
                } else {
                    // Fallback для старых браузеров
                    return '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8';
                }
            }
            
            // Вычисляемые значения
            const stagesSumPct = useMemo(() => stages.reduce((sum, s) => sum + s.pct, 0), [stages]);
            
            const linesData = useMemo(() => lines.map(line => {
                const base = line.snapshot.baseUSD * (1 - (line.discountPct || 0) / 100);
                const preUSD = base * (line.prePct || 50) / 100;
                const afterUSD = base - preUSD;
                const vMonths = line.ownTerms && line.months ? line.months : months;
                const vRate = line.ownTerms && line.monthlyRatePct != null ? line.monthlyRatePct : monthlyRatePct;
                const monthlyPayment = afterUSD * (vRate / 100) / (1 - Math.pow(1 + vRate / 100, -vMonths));
                const lineTotal = preUSD + (monthlyPayment * vMonths) + (line.firstPostUSD || 0);
                
                // Добавляем реальные даты для этапов
                const preSchedule = stages.map(s => ({
                    month: s.month,
                    amount: preUSD * s.pct / 100,
                    realDate: calculateRealDate(s.month, lang)
                }));
                
                const postRows = Array.from({ length: vMonths }, (_, i) => ({
                    month: handoverMonth + i + 1,
                    amount: monthlyPayment,
                    realDate: calculateRealDate(handoverMonth + i + 1, lang)
                }));
                
                return {
                    line,
                    base,
                    preUSD,
                    afterUSD,
                    vMonths,
                    vRate,
                    monthlyPayment,
                    lineTotal,
                    preSchedule,
                    postRows
                };
            }), [lines, stages, months, monthlyRatePct, handoverMonth, lang]);
            
            const project = useMemo(() => {
                const cashflow = [];
                let balance = 0;
                
                // Добавляем месяц 0 (текущий)
                const currentMonth = getCurrentMonth();
                cashflow.push({
                    month: 0,
                    realDate: `${currentMonth.monthName} ${currentMonth.year}`,
                    items: ['Начальный баланс'],
                    amountUSD: 0,
                    balanceUSD: 0
                });
                
                // Добавляем этапы до ключей
                linesData.forEach(ld => {
                    ld.preSchedule.forEach(s => {
                        const existing = cashflow.find(c => c.month === s.month);
                        if (existing) {
                            existing.items.push(`${ld.line.snapshot.name}: ${s.amount.toFixed(0)} USD`);
                            existing.amountUSD += s.amount;
                        } else {
                            cashflow.push({
                                month: s.month,
                                realDate: s.realDate,
                                items: [`${ld.line.snapshot.name}: ${s.amount.toFixed(0)} USD`],
                                amountUSD: s.amount,
                                balanceUSD: 0
                            });
                        }
                    });
                });
                
                // Добавляем месяцы после ключей
                linesData.forEach(ld => {
                    ld.postRows.forEach(r => {
                        const existing = cashflow.find(c => c.month === r.month);
                        if (existing) {
                            existing.items.push(`${ld.line.snapshot.name}: ${r.amount.toFixed(0)} USD`);
                            existing.amountUSD += r.amount;
                        } else {
                            cashflow.push({
                                month: r.month,
                                realDate: r.realDate,
                                items: [`${ld.line.snapshot.name}: ${r.amount.toFixed(0)} USD`],
                                amountUSD: r.amount,
                                balanceUSD: 0
                            });
                        }
                    });
                });
                
                // Сортируем по месяцам и вычисляем баланс
                cashflow.sort((a, b) => a.month - b.month);
                cashflow.forEach(c => {
                    balance += c.amountUSD;
                    c.balanceUSD = balance;
                });
                
                const totals = {
                    baseUSD: linesData.reduce((sum, ld) => sum + ld.base, 0),
                    preUSD: linesData.reduce((sum, ld) => sum + ld.preUSD, 0),
                    afterUSD: linesData.reduce((sum, ld) => sum + ld.afterUSD, 0),
                    interestUSD: linesData.reduce((sum, ld) => sum + (ld.lineTotal - ld.base), 0),
                    finalUSD: linesData.reduce((sum, ld) => sum + ld.lineTotal, 0)
                };
                
                return { cashflow, totals };
            }, [linesData, handoverMonth, lang]);
            
            // Эффект для графика
            useEffect(() => {
                if (chartRef.current && project.cashflow.length > 0) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    if (window.currentChart) {
                        window.currentChart.destroy();
                    }
                    
                    const labels = project.cashflow.map(c => c.realDate || c.month);
                    const data = project.cashflow.map(c => c.balanceUSD);
                    
                    window.currentChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Баланс',
                                data: data,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: '#94a3b8'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: '#94a3b8'
                                    }
                                }
                            }
                        }
                    });
                }
                
                return () => {
                    if (window.currentChart) {
                        window.currentChart.destroy();
                    }
                };
            }, [project.cashflow]);

                    // Функции для работы с историей
            const addToHistory = () => {
                const snapshot = {
                    lang, currency, idrPerUsd, eurPerUsd, handoverMonth, months, monthlyRatePct, stages, catalog, lines
                };
                
                // Удаляем все состояния после текущего индекса
                const newHistory = history.slice(0, currentIndex + 1);
                newHistory.push(snapshot);
                
                // Ограничиваем историю 50 состояниями
                if (newHistory.length > 50) {
                    newHistory.shift();
                }
                
                setHistory(newHistory);
                setCurrentIndex(newHistory.length - 1);
                setHasUnsavedChanges(false);
            };
            
            const undo = () => {
                if (currentIndex > 0) {
                    const prevState = history[currentIndex - 1];
                    restoreFromHistory(prevState);
                    setCurrentIndex(currentIndex - 1);
                }
            };
            
            const redo = () => {
                if (currentIndex < history.length - 1) {
                    const nextState = history[currentIndex + 1];
                    restoreFromHistory(nextState);
                    setCurrentIndex(currentIndex + 1);
                }
            };
            
            const restoreFromHistory = (state) => {
                setLang(state.lang);
                setCurrency(state.currency);
                setIdrPerUsd(state.idrPerUsd);
                setEurPerUsd(state.eurPerUsd);
                setHandoverMonth(state.handoverMonth);
                setMonths(state.months);
                setMonthlyRatePct(state.monthlyRatePct);
                setStages(state.stages);
                setCatalog(state.catalog);
                setLines(state.lines);
            };
            
            // Функции для работы с заметками, тегами и шаблонами
            const addNote = (text) => {
                const newNote = {
                    id: Date.now(),
                    text,
                    timestamp: new Date().toISOString(),
                    tags: []
                };
                setNotes(prev => [...prev, newNote]);
            };
            
            const addTag = (noteId, tag) => {
                setNotes(prev => prev.map(note => 
                    note.id === noteId 
                        ? { ...note, tags: [...note.tags, tag] }
                        : note
                ));
            };
            
            const saveTemplate = (name, data) => {
                const template = {
                    id: Date.now(),
                    name,
                    data,
                    timestamp: new Date().toISOString()
                };
                setTemplates(prev => [...prev, template]);
            };
            
            const loadTemplate = (templateId) => {
                const template = templates.find(t => t.id === templateId);
                if (template) {
                    restoreFromHistory(template.data);
                }
            };
            
            // Функции для работы с датами
            const getCurrentMonth = () => {
                const now = new Date();
                return {
                    month: now.getMonth() + 1,
                    year: now.getFullYear(),
                    monthName: now.toLocaleDateString('en-US', { month: 'long' })
                };
            };
            
            const calculateRealDate = (monthsFromNow, language) => {
                const current = getCurrentMonth();
                const targetDate = new Date(current.year, current.month - 1 + monthsFromNow, 1);
                
                if (language === 'ru') {
                    const months = [
                        'январь', 'февраль', 'март', 'апрель', 'май', 'июнь',
                        'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'
                    ];
                    return `${months[targetDate.getMonth()]} ${targetDate.getFullYear()}`;
                } else {
                    const months = [
                        'January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'
                    ];
                    return `${months[targetDate.getMonth()]} ${targetDate.getFullYear()}`;
                }
            };
            
            // Функция валидации данных
            const validateData = (data) => {
                const errors = [];
                
                // Проверка процента предоплаты
                if (data.prePct < 50 || data.prePct > 100) {
                    errors.push('Prepayment percentage must be between 50% and 100%');
                }
                
                // Проверка ставки
                if (data.monthlyRatePct < 0 || data.monthlyRatePct > 100) {
                    errors.push('Monthly rate must be between 0% and 100%');
                }
                
                return errors;
            };
            
            // Функция для переключения групп настроек
            const toggleGroup = (groupName) => {
                setExpandedGroups(prev => ({
                    ...prev,
                    [groupName]: !prev[groupName]
                }));
            };
            
            // Функции для работы с проектами
            const addProject = () => {
                setNewProjectForm({
                    projectId: generateId(),
                    projectName: ''
                });
                setShowAddProjectModal(true);
            };
            
            const saveProject = () => {
                if (newProjectForm.projectName.trim()) {
                    const newProject = {
                        projectId: newProjectForm.projectId,
                        projectName: newProjectForm.projectName.trim(),
                        villas: []
                    };
                    
                    setCatalog(prev => [...prev, newProject]);
                    setShowAddProjectModal(false);
                    setNewProjectForm({ projectId: '', projectName: '' });
                    addToHistory();
                }
            };
            
            // Функции для работы с виллами
            const addVilla = (projectId) => {
                setNewVillaForm({
                    villaId: generateId(),
                    name: '',
                    area: 0,
                    ppsm: 0
                });
                setEditingProject(projectId);
                setShowAddVillaModal(true);
            };
            
            const saveVilla = () => {
                if (newVillaForm.name.trim() && newVillaForm.area > 0) {
                    const newVilla = {
                        villaId: newVillaForm.villaId,
                        name: newVillaForm.name.trim(),
                        area: newVillaForm.area,
                        ppsm: newVillaForm.ppsm,
                        baseUSD: newVillaForm.area * newVillaForm.ppsm
                    };
                    
                    setCatalog(prev => prev.map(project => 
                        project.projectId === editingProject
                            ? { ...project, villas: [...project.villas, newVilla] }
                            : project
                    ));
                    
                    setShowAddVillaModal(false);
                    setNewVillaForm({ villaId: '', name: '', area: 0, ppsm: 0 });
                    setEditingProject(null);
                    addToHistory();
                }
            };
            
            // Функция для генерации уникальных ID
            const generateId = () => {
                return Date.now() + Math.random().toString(36).substr(2, 9);
            };
            
            // Функция для поиска проекта по ID
            const findProject = (projectId) => {
                return catalog.find(p => p.projectId === projectId);
            };
            
            // Функция для поиска виллы по ID
            const findVilla = (projectId, villaId) => {
                const project = findProject(projectId);
                return project ? project.villas.find(v => v.villaId === villaId) : null;
            };
            
            // Функция для добавления строки из каталога
            const addLineFromCatalog = (projectId, villaId) => {
                const villa = findVilla(projectId, villaId);
                if (villa) {
                    const newLine = {
                        id: Date.now(),
                        projectId,
                        villaId,
                        snapshot: {
                            name: villa.name,
                            area: villa.area,
                            ppsm: villa.ppsm,
                            baseUSD: villa.baseUSD
                        },
                        qty: 1,
                        discountPct: 0,
                        prePct: 70,
                        months: months,
                        ownTerms: false,
                        monthlyRatePct: null,
                        firstPostUSD: 0
                    };
                    
                    setLines(prev => [...prev, newLine]);
                    addToHistory();
                }
            };
            
            // Функции для работы со строками
            const updLine = (id, updates) => {
                setLines(prev => prev.map(line => 
                    line.id === id ? { ...line, ...updates } : line
                ));
                setHasUnsavedChanges(true);
            };
            
            const delLine = (id) => {
                setLines(prev => prev.filter(line => line.id !== id));
                setHasUnsavedChanges(true);
            };
            
            const dupLine = (id) => {
                const line = lines.find(l => l.id === id);
                if (line) {
                    const newLine = {
                        ...line,
                        id: Date.now(),
                        qty: 1
                    };
                    setLines(prev => [...prev, newLine]);
                    setHasUnsavedChanges(true);
                }
            };
            
            // Функция для экспорта в PDF
            const exportPDF = async () => {
                try {
                    const element = document.createElement('div');
                    element.innerHTML = `
                        <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px;">
                            <h1 style="color: #333; text-align: center; margin-bottom: 30px;">
                                ${t.cashflowTitle}
                            </h1>
                            
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">${t.cashMonth}</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">${t.cashDesc}</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">${t.cashTotal}</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">${t.cashBalance}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${project.cashflow.map(c => `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 12px;">${c.realDate || c.month}</td>
                                            <td style="border: 1px solid #ddd; padding: 12px;">${(c.items || []).join(' + ')}</td>
                                            <td style="border: 1px solid #ddd; padding: 12px; text-align: right;">${toCurrency(c.amountUSD)}</td>
                                            <td style="border: 1px solid #ddd; padding: 12px; text-align: right;">${toCurrency(c.balanceUSD)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            
                            <div style="text-align: center; color: #666; font-size: 12px;">
                                Generated on ${new Date().toLocaleDateString()}
                            </div>
                        </div>
                    `;
                    
                    const opt = {
                        margin: 1,
                        filename: `arconique_cashflow_${new Date().toISOString().slice(0, 10)}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                    };
                    
                    await html2pdf().set(opt).from(element).save();
                } catch (error) {
                    console.error('PDF export error:', error);
                    alert('Error exporting PDF');
                }
            };
            
            // Функция для экспорта в CSV
            const exportCSV = () => {
                const headers = [t.cashMonth, t.cashDesc, t.cashTotal, t.cashBalance];
                const rows = project.cashflow.map(c => [
                    c.realDate || c.month,
                    (c.items || []).join(' + '),
                    toCurrency(c.amountUSD),
                    toCurrency(c.balanceUSD)
                ]);
                
                const csvContent = [headers, ...rows]
                    .map(row => row.map(cell => `"${cell}"`).join(','))
                    .join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `arconique_cashflow_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
                URL.revokeObjectURL(link.href);
            };
            
            // Функция для экспорта в XLSX
            const exportXLSX = () => {
                const data = project.cashflow.map(c => ({
                    [t.cashMonth]: c.realDate || c.month,
                    [t.cashDesc]: (c.items || []).join(' + '),
                    [t.cashTotal]: toCurrency(c.amountUSD),
                    [t.cashBalance]: toCurrency(c.balanceUSD)
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Cashflow');
                XLSX.writeFile(wb, `arconique_cashflow_${new Date().toISOString().slice(0, 10)}.xlsx`);
            };
            
            // Функция для шаринга
            const share = (mode) => {
                const data = {
                    lang, currency, idrPerUsd, eurPerUsd, handoverMonth, months, monthlyRatePct, stages, catalog, lines
                };
                
                if (mode === 'client') {
                    // Убираем служебные данные для клиента
                    delete data.catalog;
                    delete data.stages;
                }
                
                const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(data));
                const url = `${window.location.origin}${window.location.pathname}#${compressed}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: t.title,
                        text: t.shareText,
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(url).then(() => {
                        alert(t.copied);
                    });
                }
            };
            
            // Функция для форматирования валюты
            const toCurrency = (usd) => {
                const amount = currency === 'USD' ? usd : (currency === 'IDR' ? usd * idrPerUsd : usd * eurPerUsd);
                return fmtMoney(amount, currency);
            };
            
            // Функция для форматирования денег
            const fmtMoney = (amount, curr) => {
                if (curr === 'USD') {
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
                } else if (curr === 'IDR') {
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(amount);
                } else if (curr === 'EUR') {
                    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
                }
                return amount.toString();
            };
            
            // Функция для ограничения значений
            const clamp = (value, min, max) => {
                return Math.min(Math.max(value, min), max);
            };
            
            // Функция для создания снапшота состояния
            const snapshot = () => ({
                lang, currency, idrPerUsd, eurPerUsd, handoverMonth, months, monthlyRatePct, stages, catalog, lines
            });

                    // Эффект для автосохранения
            useEffect(() => {
                if (hasUnsavedChanges) {
                    const timer = setTimeout(() => {
                        localStorage.setItem('arconique_v81', JSON.stringify(snapshot()));
                        setAutoSaveStatus('saved');
                        setHasUnsavedChanges(false);
                        
                        setTimeout(() => {
                            setAutoSaveStatus('idle');
                        }, 2000);
                    }, 2000);
                    
                    return () => clearTimeout(timer);
                }
            }, [hasUnsavedChanges]);
            
            // Эффект для индикатора автосохранения
            useEffect(() => {
                const indicator = document.getElementById('auto-save-indicator');
                if (indicator) {
                    if (autoSaveStatus === 'saving') {
                        indicator.textContent = t.saving;
                        indicator.style.display = 'block';
                    } else if (autoSaveStatus === 'saved') {
                        indicator.textContent = t.saved;
                        indicator.style.display = 'block';
                        setTimeout(() => {
                            indicator.style.display = 'none';
                        }, 2000);
                    } else {
                        indicator.style.display = 'none';
                    }
                }
            }, [autoSaveStatus, t.saving, t.saved]);
            
            // Эффект для инициализации
            useEffect(() => {
                (async () => {
                    try {
                        const saved = localStorage.getItem('arconique_v81');
                        if (saved) {
                            const data = JSON.parse(saved);
                            setLang(data.lang || 'ru');
                            setCurrency(data.currency || 'USD');
                            setIdrPerUsd(data.idrPerUsd || 15000);
                            setEurPerUsd(data.eurPerUsd || 0.85);
                            setHandoverMonth(data.handoverMonth || 12);
                            setMonths(data.months || 12);
                            setMonthlyRatePct(data.monthlyRatePct || 0.5);
                            setStages(data.stages || [
                                { id: 1, label: 'Этап', pct: 30, month: 0, realDate: 'Январь 2025' },
                                { id: 2, label: 'Этап', pct: 40, month: 6, realDate: 'Июль 2025' },
                                { id: 3, label: 'Этап', pct: 30, month: 12, realDate: 'Январь 2026' }
                            ]);
                            setCatalog(data.catalog || [
                                {
                                    projectId: 'P001',
                                    projectName: 'Проект А',
                                    villas: [
                                        { villaId: 'V001', name: 'Вилла 1', area: 150, ppsm: 2000, baseUSD: 300000 },
                                        { villaId: 'V002', name: 'Вилла 2', area: 200, ppsm: 2500, baseUSD: 500000 }
                                    ]
                                }
                            ]);
                            setLines(data.lines || [
                                {
                                    id: 1,
                                    projectId: 'P001',
                                    villaId: 'V001',
                                    snapshot: { name: 'Вилла 1', area: 150, ppsm: 2000, baseUSD: 300000 },
                                    qty: 1,
                                    discountPct: 0,
                                    prePct: 70,
                                    months: 12,
                                    ownTerms: false,
                                    monthlyRatePct: null,
                                    firstPostUSD: 0
                                }
                            ]);
                        }
                        
                        // Проверка PIN для редактора
                        if (!isClient) {
                            const pin = prompt(lang === 'ru' ? 'Введите PIN для редактора:' : 'Enter editor PIN:');
                            if (pin) {
                                const hashedPin = await sha256Hex(pin);
                                if (hashedPin === '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8') {
                                    setIsClient(false);
                                } else {
                                    alert(lang === 'ru' ? 'Неверный PIN — открыт клиентский режим' : 'Wrong PIN — opened client view');
                                }
                            } else setIsClient(true);
                        } else setIsClient(true);
                    } catch (e) {
                        console.error(e);
                    }
                    
                    document.getElementById('app-title').textContent = t.title;
                    document.title = t.title;
                })();
            }, []);
            
            useEffect(() => {
                localStorage.setItem('arconique_v81', JSON.stringify(snapshot()));
                document.getElementById('app-title').textContent = t.title;
                document.title = t.title;
            }, [lang, currency, idrPerUsd, eurPerUsd, handoverMonth, months, monthlyRatePct, stages, catalog, lines]);
            
            // Компонент KPI блока с отображением валюты
            function KPIBlock({isClient, t, totals, currency, toCurrency}){
                const getCurrencySymbol = (curr) => {
                    switch(curr) {
                        case 'USD': return '$';
                        case 'IDR': return 'Rp';
                        case 'EUR': return '€';
                        default: return '$';
                    }
                };
                
                const currencySymbol = getCurrencySymbol(currency);
                
                return (
                    <div className="kpis">
                        <div className="kpi animate-fade-in">
                            <span className="muted">{t.base}</span>
                            <div className="v">{currencySymbol} {toCurrency(totals.baseUSD).replace(/[^\d,.-]/g, '')}</div>
                        </div>
                        <div className="kpi animate-fade-in" style={{animationDelay: '0.1s'}}>
                            <span className="muted">{t.prepay}</span>
                            <div className="v">{currencySymbol} {toCurrency(totals.preUSD).replace(/[^\d,.-]/g, '')}</div>
                        </div>
                        <div className="kpi animate-fade-in" style={{animationDelay: '0.2s'}}>
                            <span className="muted">{t.after}</span>
                            <div className="v">{currencySymbol} {toCurrency(totals.afterUSD).replace(/[^\d,.-]/g, '')}</div>
                        </div>
                        <div className="kpi animate-fade-in" style={{animationDelay: '0.3s'}}>
                            <span className="muted">{t.interestTotal}</span>
                            <div className="v">{currencySymbol} {toCurrency(totals.interestUSD).replace(/[^\d,.-]/g, '')}</div>
                        </div>
                        <div className="kpi animate-fade-in" style={{animationDelay: '0.4s'}}>
                            <span className="muted">{t.final}</span>
                            <div className="v">{currencySymbol} {toCurrency(totals.finalUSD).replace(/[^\d,.-]/g, '')}</div>
                        </div>
                    </div>
                );
            }
            
            return (
                <>
                    <div className="grid">
                        <div className="card">
                            {!isClient && (
                                <div className="smart-tabs">
                                    <button className={`smart-tab ${tab==='overview'?'active':''}`} onClick={()=>setTab('overview')}>
                                        <span className="tab-icon">📊</span>
                                        <span className="tab-label">{t.overview}</span>
                                        <span className="tab-counter">{lines.length}</span>
                                    </button>
                                    <button className={`smart-tab ${tab==='stages'?'active':''}`} onClick={()=>setTab('stages')}>
                                        <span className="tab-icon">📅</span>
                                        <span className="tab-label">{t.stages}</span>
                                        <span className="tab-counter">{stages.length}</span>
                                    </button>
                                </div>
                            )}
                            
                            {/* Основные параметры */}
                            <div className="settings-group">
                                <div className="settings-header" onClick={() => toggleGroup('basic')}>
                                    <span className="group-icon">⚙️</span>
                                    <span className="group-title">{t.settings}</span>
                                    <span className="group-toggle">{expandedGroups.basic ? '−' : '+'}</span>
                                </div>
                                <div className={`settings-content ${expandedGroups.basic ? 'expanded' : ''}`}>
                                    <div className="row">
                                        <div className="field compact">
                                            <label>{t.lang}</label>
                                            <select value={lang} onChange={e=>setLang(e.target.value)}>
                                                <option value="ru">Русский</option>
                                                <option value="en">English</option>
                                            </select>
                                        </div>
                                        <div className="field compact">
                                            <label>{t.currencyDisplay}</label>
                                            <select value={currency} onChange={e=>setCurrency(e.target.value)}>
                                                <option>USD</option>
                                                <option>IDR</option>
                                                <option>EUR</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    {!isClient && (
                                        <div className="row">
                                            <div className="field compact">
                                                <label>{t.idrRate}</label>
                                                <input type="number" min="1" step="1" value={idrPerUsd} onChange={e=>setIdrPerUsd(clamp(parseFloat(e.target.value||0),1,1e9))}/>
                                            </div>
                                            <div className="field compact">
                                                <label>{t.eurRate}</label>
                                                <input type="number" min="0.01" step="0.01" value={eurPerUsd} onChange={e=>setEurPerUsd(clamp(parseFloat(e.target.value||0),0.01,100))}/>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="row">
                                        <div className="field compact">
                                            <label>{t.handoverMonth}</label>
                                            <input type="number" min="1" step="1" value={handoverMonth} onChange={e=>setHandoverMonth(clamp(parseInt(e.target.value||0,10),1,120))}/>
                                        </div>
                                        {!isClient ? (
                                            <>
                                                <div className="field compact">
                                                    <label>{t.globalRate}</label>
                                                    <input type="number" min="0" step="0.01" value={monthlyRatePct} onChange={e=>setMonthlyRatePct(clamp(parseFloat(e.target.value||0),0,1000))}/>
                                                </div>
                                                <div className="field compact">
                                                    <label>{t.globalTerm}</label>
                                                    <input type="range" min="6" max="24" step="1" value={months} onChange={e=>setMonths(parseInt(e.target.value,10))}/>
                                                    <div className="pill">{t.months}: {months}</div>
                                                </div>
                                            </>
                                        ) : (
                                            <div className="field compact">
                                                <label>{t.clientTerm}</label>
                                                <input type="number" min="6" step="1" value={months} onChange={e=>setMonths(clamp(parseInt(e.target.value||0,10),6,120))}/>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Этапы - видимы для всех пользователей */}
                            <div className="settings-group">
                                <div className="settings-header" onClick={() => toggleGroup('stages')}>
                                    <span className="group-icon">📅</span>
                                    <span className="group-title">{t.stagesTitle}</span>
                                    <span className="group-toggle">{expandedGroups.stages ? '−' : '+'}</span>
                                </div>
                                <div className={`settings-content ${expandedGroups.stages ? 'expanded' : ''}`}>
                                    <div style={{border:'1px dashed #223',borderRadius:'8px',padding:'6px',marginBottom:'var(--spacing-lg)'}}>
                                        <table className="stages-table">
                                            <thead>
                                                <tr>
                                                    <th className="col-stage">{t.stage}</th>
                                                    <th className="col-percent">{t.percent}</th>
                                                    <th className="col-month">{t.month}</th>
                                                    <th className="col-actions"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {stages.map(s=>(
                                                    <tr key={s.id}>
                                                        <td className="col-stage">
                                                            <input type="text" className="stage-input" value={s.label} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,label:e.target.value}:x))} />
                                                        </td>
                                                        <td className="col-percent">
                                                            <input type="range" min="0" max="100" step="0.01" value={s.pct} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,pct:clamp(parseFloat(e.target.value||0),0,100)}:x))} />
                                                            <div className="pill">{s.pct}%</div>
                                                        </td>
                                                        <td className="col-month">
                                                            <input type="number" className="stage-number-input" min="0" step="1" value={s.month} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,month:clamp(parseInt(e.target.value||0,10),0,handoverMonth),realDate:calculateRealDate(clamp(parseInt(e.target.value||0,10),0,handoverMonth), lang)}:x))} />
                                                        </td>
                                                        <td className="col-actions">
                                                            <div className="stage-actions">
                                                                <button className="delete-stage-btn" onClick={()=>setStages(prev=>prev.filter(x=>x.id!==s.id))}>
                                                                    {t.remove}
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div className="row" style={{marginTop:8,alignItems:'center',justifyContent:'space-between'}}>
                                        <button className="btn primary" onClick={()=>setStages(prev=>{const last=prev[prev.length-1];const id=(last?.id||0)+1;const nextMonth=Math.min(handoverMonth,(last?.month??0)+1);return [...prev,{id,label:(lang==='ru'?'Этап':'Stage'),pct:5,month:nextMonth,realDate:calculateRealDate(nextMonth, lang)}]})}>
                                            {t.addStage}
                                        </button>
                                        {(() => {
                                            const vals=lines.map(l=>l.prePct||0);
                                            const allSame=vals.length?vals.every(v=>v===vals[0]):true;
                                            const targetText=allSame?`${vals[0]||0}%`:`${Math.min(...vals||[0])}%–${Math.max(...vals||[0])}%`;
                                            const mismatch=allSame ? (Math.round(stagesSumPct*100)/100!==(vals[0]||0)) : true;
                                            return <div className={`hint ${mismatch?'warn':''}`}>{t.sumStages}: {Math.round(stagesSumPct*100)/100}% · {t.targetPrepay}: {targetText} {mismatch? (allSame? ` ${t.mismatch}` : ` (${t.mixedTargets})`) : ''}</div>;
                                        })()}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="hr"></div>
                            
                            {/* Кнопки действий */}
                            <div className="row" style={{justifyContent:'space-between',alignItems:'center'}}>
                                <div className="row" style={{gap:'var(--spacing-md)'}}>
                                    {!isClient && (
                                        <>
                                            <button className="btn" onClick={undo} disabled={currentIndex <= 0}>↶ {t.undo}</button>
                                            <button className="btn" onClick={redo} disabled={currentIndex >= history.length - 1}>↷ {t.redo}</button>
                                        </>
                                    )}
                                </div>
                                
                                <div className="row" style={{gap:'var(--spacing-md)'}}>
                                    {!isClient && (
                                        <>
                                            <button className="btn primary" onClick={()=>share('editor')}>{t.share} ({t.editor})</button>
                                            <button className="btn" onClick={()=>share('client')}>{t.share} ({t.client})</button>
                                        </>
                                    )}
                                    {isClient && <button className="btn" onClick={()=>share('client')}>{t.share}</button>}
                                </div>
                            </div>
                        </div>
                        
                        <div className="card">
                            <div className="row" style={{justifyContent:'space-between',alignItems:'baseline'}}>
                                <div className="row">
                                    <span className="badge">{t.lines}: {lines.length}</span>
                                    <span className="badge">{t.keys} {handoverMonth} {t.months}</span>
                                    {!isClient && <span className="badge">{t.months}: {months}</span>}
                                </div>
                                <div className="muted">{isClient ? t.client : t.editor}</div>
                            </div>
                            
                            <KPIBlock isClient={isClient} t={t} totals={project.totals} currency={currency} toCurrency={toCurrency}/>
                            
                            <div className="hr"></div>
                            
                            {/* Заголовок расчета с кнопкой */}
                            <div className="calculation-header">
                                <h3 style={{margin:'6px 0'}}>{t.villasTitle}</h3>
                                {!isClient && <button className="btn success" onClick={()=>setModalOpen(true)}>{t.addFromCatalog}</button>}
                            </div>
                            
                            <div>
                                <table className="calc-table">
                                    <thead>
                                        <tr>
                                            <th className="col-project">{t.project}</th>
                                            <th className="col-villa">{t.villa}</th>
                                            <th className="col-qty">{t.qty}</th>
                                            <th className="col-area">{t.area}</th>
                                            <th className="col-ppsm">{t.ppsm}</th>
                                            {!isClient && <th className="col-base">{t.price}</th>}
                                            {!isClient && <th className="col-disc">{t.discount}</th>}
                                            <th className="col-pre">{t.prePct}</th>
                                            {!isClient && <th className="col-months">{t.months}</th>}
                                            {!isClient && <th className="col-rate">{t.rate}</th>}
                                            <th className="col-lineTotal">{t.lineTotal}</th>
                                            <th className="col-actions"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {linesData.map(ld=>{
                                            const projName=findProject(ld.line.projectId)?.projectName || ld.line.projectId;
                                            return (
                                                <tr key={ld.line.id}>
                                                    <td className="col-project">
                                                        <div className="project-name-display">{projName}</div>
                                                    </td>
                                                    <td className="col-villa">
                                                        <div className="villa-name-display">{ld.line.snapshot?.name}</div>
                                                    </td>
                                                    <td className="col-qty">
                                                        <input type="number" min="1" step="1" value={ld.qty} onChange={e=>updLine(ld.line.id,{qty:clamp(parseInt(e.target.value||0,10),1,1000)})} style={{width:'60px',textAlign:'center'}} />
                                                    </td>
                                                    <td className="col-area">
                                                        <div className="area-display">{ld.line.snapshot?.area}</div>
                                                    </td>
                                                    <td className="col-ppsm">
                                                        <div className="ppsm-display">{ld.line.snapshot?.ppsm}</div>
                                                    </td>
                                                    {!isClient && (
                                                        <td className="col-base">
                                                            <div className="base-strong">{fmtMoney(ld.base,'USD')}</div>
                                                        </td>
                                                    )}
                                                    {!isClient && (
                                                        <td className="col-disc">
                                                            <input type="range" min="0" max="20" step="0.1" value={ld.line.discountPct||0} onChange={e=>updLine(ld.line.id,{discountPct:clamp(parseFloat(e.target.value||0),0,20)})} style={{width:'60px',textAlign:'center'}} />
                                                            <div className="pill">{ld.line.discountPct||0}%</div>
                                                        </td>
                                                    )}
                                                    <td className="col-pre">
                                                        <input type="range" min="50" max="100" step="0.1" value={ld.line.prePct||70} onChange={e=>updLine(ld.line.id,{prePct:clamp(parseFloat(e.target.value||0),50,100)})} style={{width:'60px',textAlign:'center'}} />
                                                        <div className="pill">{ld.line.prePct||70}%</div>
                                                    </td>
                                                    {!isClient && (
                                                        <td className="col-months">
                                                            <input type="number" min="6" max="120" step="1" value={ld.vMonths} onChange={e=>updLine(ld.line.id,{months:clamp(parseInt(e.target.value||0,10),6,120)})} style={{width:'60px',textAlign:'center'}} />
                                                        </td>
                                                    )}
                                                    {!isClient && (
                                                        <td className="col-rate">
                                                            <input type="number" min="0" max="100" step="0.01" value={ld.line.ownTerms && ld.line.monthlyRatePct!=null ? ld.line.monthlyRatePct : monthlyRatePct} onChange={e=>updLine(ld.line.id,{monthlyRatePct:clamp(parseFloat(e.target.value||0),0,100)})} style={{width:'60px',textAlign:'center'}} />
                                                        </td>
                                                    )}
                                                    <td className="col-lineTotal">
                                                        <div className="line-total">{fmtMoney(ld.lineTotal,'USD')}</div>
                                                    </td>
                                                    <td className="col-actions">
                                                        <div style={{display:'flex',gap:'4px',justifyContent:'center'}}>
                                                            <button className="btn icon" onClick={()=>dupLine(ld.line.id)} title="Дублировать">📋</button>
                                                            <button className="btn danger icon" onClick={()=>delLine(ld.line.id)} title="Удалить">✕</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="hr"></div>
                            
                            {/* Кэшфлоу без скролла */}
                            <h3 style={{margin:'6px 0'}}>{t.cashflowTitle}</h3>
                            <div>
                                <table className="cashflow-table">
                                    <thead>
                                        <tr>
                                            <th>{t.cashMonth}</th>
                                            <th>{t.cashDesc}</th>
                                            <th>{t.cashTotal}</th>
                                            <th>{t.cashBalance}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {project.cashflow.map(c=>(
                                            <tr key={c.month}>
                                                <td>{c.realDate || c.month}</td>
                                                <td style={{textAlign:'left'}}>{(c.items||[]).join(' + ')}</td>
                                                <td>{toCurrency(c.amountUSD)}</td>
                                                <td>{toCurrency(c.balanceUSD)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="hr"></div>
                            
                            {/* График */}
                            <h3 style={{margin:'6px 0'}}>{t.chartTitle}</h3>
                            <div style={{height:'300px',position:'relative'}}>
                                <canvas ref={chartRef} />
                            </div>
                            
                            <div className="hr"></div>
                            
                            {/* Экспорт */}
                            <div className="row" style={{justifyContent:'center',gap:'var(--spacing-md)'}}>
                                <button className="btn" onClick={exportCSV}>{t.exportCSV}</button>
                                <button className="btn" onClick={exportXLSX}>{t.exportXLSX}</button>
                                <button className="btn primary" onClick={exportPDF}>{t.exportPDF}</button>
                            </div>
                        </div>
                    </div>

                                        {/* Каталог проектов и вилл - перемещен вниз на всю ширину */}
                    {!isClient && (
                        <div className="full-width-block">
                            <div className="card">
                                <h3 style={{margin:'6px 0'}}>{t.catalogTitle}</h3>
                                
                                <div className="row" style={{gap:'var(--spacing-md)'}}>
                                    <button className="btn success" onClick={addProject}>{t.addProject}</button>
                                    <button className="btn" onClick={()=>{
                                        const json=prompt('Paste catalog JSON:', JSON.stringify(catalog,null,2));
                                        if(!json) return;
                                        try{
                                            const obj=JSON.parse(json);
                                            if(Array.isArray(obj)) setCatalog(obj);
                                            else alert('Invalid JSON');
                                        }catch{
                                            alert('Invalid JSON');
                                        }
                                    }}>{t.importJSON}</button>
                                    <button className="btn" onClick={()=>{
                                        const blob=new Blob([JSON.stringify(catalog,null,2)],{type:'application/json'});
                                        const a=document.createElement('a');
                                        a.href=URL.createObjectURL(blob);
                                        a.download=`arconique_catalog_${new Date().toISOString().slice(0,10)}.json`;
                                        a.click();
                                        URL.revokeObjectURL(a.href);
                                    }}>{t.exportJSON}</button>
                                </div>
                                
                                <div>
                                    {catalog.map(p=>(
                                        <div key={p.projectId} className="catalog-card">
                                            <div className="catalog-header">
                                                <div className="row" style={{flex:1}}>
                                                    <span className="badge">{t.project}:</span>
                                                    <input type="text" value={p.projectName} onChange={e=>setCatalog(prev=>prev.map(x=>x.projectId===p.projectId?{...x,projectName:e.target.value}:x))} style={{flex:1,marginRight:8}} />
                                                    <span className="pill">{p.projectId}</span>
                                                </div>
                                                <div className="catalog-actions">
                                                    <button className="btn primary" onClick={()=>addVilla(p.projectId)}>{t.addVilla}</button>
                                                    <button className="btn danger" onClick={()=>{
                                                        if(confirm(t.remove + ' ' + p.projectName + '?')) {
                                                            setCatalog(prev=>prev.filter(x=>x.projectId!==p.projectId));
                                                        }
                                                    }}>{t.remove}</button>
                                                </div>
                                            </div>
                                            
                                            <table className="catalog-table">
                                                <thead>
                                                    <tr>
                                                        <th style={{textAlign:'left'}}>{t.villa}</th>
                                                        <th>{t.area}</th>
                                                        <th>{t.ppsm}</th>
                                                        <th>{t.price}</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {p.villas.map(v=>(
                                                        <tr key={v.villaId}>
                                                            <td style={{textAlign:'left'}}>
                                                                <input value={v.name} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,name:e.target.value}:vv)}:pr))} />
                                                                <div className="muted" style={{fontSize:10}}>{v.villaId}</div>
                                                            </td>
                                                            <td>
                                                                <input type="number" min="1" step="0.1" value={v.area} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,area:clamp(parseFloat(e.target.value||0),1,100000)}:vv)}:pr))} />
                                                            </td>
                                                            <td>
                                                                <input type="number" min="0" step="1" value={v.ppsm} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,ppsm:clamp(parseFloat(e.target.value||0),0,1e9)}:vv)}:pr))} />
                                                            </td>
                                                            <td>
                                                                <input type="number" min="0" step="1" value={v.baseUSD} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,baseUSD:clamp(parseFloat(e.target.value||0),0,1e12)}:vv)}:pr))} />
                                                            </td>
                                                            <td>
                                                                <button className="btn danger icon" onClick={()=>{
                                                                    if(confirm(t.remove + ' ' + v.name + '?')) {
                                                                        setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.filter(vv=>vv.villaId!==v.villaId)}:pr));
                                                                    }
                                                                }}> ✕ </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Модальные окна */}
                    {showAddProjectModal && (
                        <div className="modal-overlay" onClick={() => setShowAddProjectModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{t.addProject}</h3>
                                    <button className="btn icon" onClick={() => setShowAddProjectModal(false)}>✕</button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-section">
                                        <h4>{t.projectName}</h4>
                                        <div className="form-group">
                                            <input type="text" value={newProjectForm.projectName} onChange={e => setNewProjectForm(prev => ({...prev, projectName: e.target.value}))} placeholder={t.projectName} />
                                        </div>
                                    </div>
                                    <div className="form-actions">
                                        <button className="btn" onClick={() => setShowAddProjectModal(false)}>{t.cancel}</button>
                                        <button className="btn primary" onClick={saveProject}>{t.save}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showAddVillaModal && (
                        <div className="modal-overlay" onClick={() => setShowAddVillaModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{t.addVilla}</h3>
                                    <button className="btn icon" onClick={() => setShowAddVillaModal(false)}>✕</button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-section">
                                        <h4>{t.villaName}</h4>
                                        <div className="form-group">
                                            <input type="text" value={newVillaForm.name} onChange={e => setNewVillaForm(prev => ({...prev, name: e.target.value}))} placeholder={t.villaName} />
                                        </div>
                                    </div>
                                    <div className="form-section">
                                        <h4>{t.villaArea}</h4>
                                        <div className="form-group">
                                            <input type="number" min="1" step="0.1" value={newVillaForm.area} onChange={e => setNewVillaForm(prev => ({...prev, area: parseFloat(e.target.value) || 0}))} />
                                        </div>
                                    </div>
                                    <div className="form-section">
                                        <h4>{t.villaPpsm}</h4>
                                        <div className="form-group">
                                            <input type="number" min="0" step="1" value={newVillaForm.ppsm} onChange={e => setNewVillaForm(prev => ({...prev, ppsm: parseFloat(e.target.value) || 0}))} />
                                        </div>
                                    </div>
                                    <div className="form-actions">
                                        <button className="btn" onClick={() => setShowAddVillaModal(false)}>{t.cancel}</button>
                                        <button className="btn primary" onClick={saveVilla}>{t.save}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Модальное окно выбора из каталога */}
                    {modalOpen && (
                        <div className="modal-overlay" onClick={() => setModalOpen(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{t.selectFromCatalog}</h3>
                                    <button className="btn icon" onClick={() => setModalOpen(false)}>✕</button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-section">
                                        <h4>{t.search}</h4>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>{t.areaFrom}</label>
                                                <input type="number" min="0" step="1" placeholder="0" />
                                            </div>
                                            <div className="form-group">
                                                <label>{t.areaTo}</label>
                                                <input type="number" min="0" step="1" placeholder="1000" />
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>{t.priceFrom}</label>
                                                <input type="number" min="0" step="1000" placeholder="0" />
                                            </div>
                                            <div className="form-group">
                                                <label>{t.priceTo}</label>
                                                <input type="number" min="0" step="1000" placeholder="1000000" />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="form-actions">
                                        <button className="btn" onClick={() => setModalOpen(false)}>{t.cancel}</button>
                                        <button className="btn primary">{t.addSelected}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Мобильная навигация */}
                    <div className="mobile-nav" style={{display: window.innerWidth <= 768 ? 'flex' : 'none'}}>
                        <button className={`mobile-nav-btn ${tab === 'overview' ? 'active' : ''}`} onClick={() => setTab('overview')}>
                            📊
                            <span>{t.overview}</span>
                        </button>
                        <button className={`mobile-nav-btn ${tab === 'stages' ? 'active' : ''}`} onClick={() => setTab('stages')}>
                            📅
                            <span>{t.stages}</span>
                        </button>
                    </div>
                </>
            );
        }
        
        // Рендер приложения
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

