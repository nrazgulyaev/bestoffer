<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arconique / Калькулятор рассрочки для любимых клиентов — v7.6</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    *{box-sizing:border-box}
    
    :root{
      /* Современная цветовая палитра */
      --bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      --card: rgba(255,255,255,0.05);
      --card-hover: rgba(255,255,255,0.08);
      --line: rgba(255,255,255,0.1);
      --muted: #94a3b8;
      --ink: #f1f5f9;
      --warn: #ef4444;
      --ok: #10b981;
      --strong: #3b82f6;
      --good: #059669;
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      --success: #22c55e;
      --warning: #f59e0b;
      --info: #06b6d4;
      
      /* Тени и эффекты */
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,0.25);
      
      /* Скругления */
      --radius-sm: 6px;
      --radius: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;
      --radius-2xl: 28px;
      
      /* Брейкпоинты */
      --mobile: 480px;
      --tablet: 768px;
      --laptop: 1024px;
      --desktop: 1200px;
      
      /* Отступы */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 20px;
      --space-2xl: 24px;
      --space-3xl: 32px;
    }
    
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      min-height:100vh;
      line-height:1.6;
    }
    
    .wrap{
      max-width:1400px;
      margin:12px auto;
      padding:0 12px;
    }
    
    @media (min-width: 768px) {
      .wrap {
        margin: 24px auto;
        padding: 0 20px;
      }
    }
    
    h1{
      margin:0 0 16px;
      font-size:18px;
      font-weight:700;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      text-align:center;
    }
    
    @media (min-width: 768px) {
      h1 {
        font-size: 24px;
        margin-bottom: 20px;
      }
    }
    
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
    }
    
    @media (min-width: 1024px) {
      .grid {
        grid-template-columns: 400px 1fr;
        gap: 20px;
      }
    }
    
    @media (min-width: 1200px) {
      .grid {
        grid-template-columns: 420px 1fr;
        gap: 24px;
      }
    }
    
    .card{
      background:var(--card);
      backdrop-filter:blur(20px);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:16px;
      transition:all 0.3s ease;
      box-shadow:var(--shadow-lg);
    }
    
    @media (min-width: 768px) {
      .card {
        padding: 20px;
      }
    }
    
    .card:hover{
      background:var(--card-hover);
      transform:translateY(-2px);
      box-shadow:var(--shadow-xl);
    }
    
    .row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    
    @media (min-width: 768px) {
      .row {
        gap: 16px;
      }
    }
    
    .field{
      display:grid;
      gap:6px;
      margin-bottom:12px;
      width:100%;
    }
    
    @media (min-width: 768px) {
      .field {
        margin-bottom: 16px;
      }
    }
    
    label{
      color:var(--muted);
      font-size:12px;
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    @media (min-width: 768px) {
      label {
        font-size: 13px;
      }
    }
    
    input[type="text"],input[type="number"],input[type="range"],select,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:var(--radius);
      border:2px solid transparent;
      background:rgba(255,255,255,0.05);
      color:var(--ink);
      font-size:13px;
      transition:all 0.3s ease;
      backdrop-filter:blur(10px);
    }
    
    @media (min-width: 768px) {
      input[type="text"],input[type="number"],input[type="range"],select,textarea {
        padding: 12px 14px;
        font-size: 14px;
      }
    }
    
    input[type="text"]:focus,input[type="number"]:focus,select:focus,textarea:focus{
      outline:none;
      border-color:var(--accent);
      background:rgba(255,255,255,0.08);
      box-shadow:0 0 0 4px rgba(139,92,246,0.1);
    }
    
    input[type="range"]{
      padding:0;
      height:6px;
      background:rgba(255,255,255,0.1);
      border-radius:3px;
      outline:none;
    }
    
    input[type="range"]::-webkit-slider-thumb{
      appearance:none;
      width:18px;
      height:18px;
      background:var(--accent);
      border-radius:50%;
      cursor:pointer;
      box-shadow:var(--shadow);
      transition:all 0.3s ease;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover{
      transform:scale(1.2);
      box-shadow:var(--shadow-lg);
    }
    
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(139,92,246,0.1);
      border:1px solid rgba(139,92,246,0.2);
      font-size:11px;
      font-weight:600;
      color:var(--accent-light);
      text-align:center;
    }
    
    @media (min-width: 768px) {
      .pill {
        padding: 8px 14px;
        font-size: 12px;
      }
    }
    
    .badge{
      background:rgba(59,130,246,0.1);
      border:1px solid rgba(59,130,246,0.2);
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      color:var(--strong);
    }
    
    @media (min-width: 768px) {
      .badge {
        padding: 6px 10px;
        font-size: 12px;
      }
    }
    
    .muted{color:var(--muted)}
    
    .hr{
      height:1px;
      background:linear-gradient(90deg, transparent, var(--line), transparent);
      border:0;
      margin:16px 0;
    }
    
    @media (min-width: 768px) {
      .hr {
        margin: 20px 0;
      }
    }
    
    .btn{
      appearance:none;
      border:none;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white;
      padding:8px 16px;
      border-radius:var(--radius);
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      transition:all 0.3s ease;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      white-space:nowrap;
    }
    
    @media (min-width: 768px) {
      .btn {
        padding: 10px 20px;
        font-size: 13px;
      }
    }
    
    .btn::before{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition:left 0.5s ease;
    }
    
    .btn:hover::before{
      left:100%;
    }
    
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow-lg);
    }
    
    .btn.warn{
      background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .btn.ok{
      background:linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .btn.icon{
      padding:6px;
      border-radius:var(--radius-sm);
      min-width:32px;
    }
    
    @media (min-width: 768px) {
      .btn.icon {
        padding: 8px;
        min-width: 36px;
      }
    }
    
    table{
      width:100%;
      border-collapse:collapse;
      background:rgba(255,255,255,0.02);
      border-radius:var(--radius);
      overflow:hidden;
      font-size:12px;
    }
    
    @media (min-width: 768px) {
      table {
        font-size: 13px;
      }
    }
    
    th,td{
      padding:8px 6px;
      border-bottom:1px solid rgba(255,255,255,0.05);
      text-align:right;
      font-variant-numeric:tabular-nums;
      vertical-align:middle;
    }
    
    @media (min-width: 768px) {
      th,td {
        padding: 12px 8px;
      }
    }
    
    th:first-child,td:first-child{text-align:left}
    
    th{
      background:rgba(255,255,255,0.05);
      font-weight:600;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:var(--muted);
    }
    
    @media (min-width: 768px) {
      th {
        font-size: 12px;
      }
    }
    
    .scroll{
      overflow:auto;
      max-height:35vh;
      border-radius:var(--radius);
    }
    
    @media (min-width: 768px) {
      .scroll {
        max-height: 45vh;
      }
    }
    
    .kpis{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin:12px 0;
    }
    
    @media (min-width: 768px) {
      .kpis {
        grid-template-columns: repeat(5,1fr);
        gap: 14px;
        margin: 16px 0;
      }
    }
    
    @media (min-width: 480px) and (max-width: 767px) {
      .kpis {
        grid-template-columns: repeat(3,1fr);
      }
    }
    
    .kpi{
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.05);
      border-radius:var(--radius);
      padding:12px;
      text-align:center;
      transition:all 0.3s ease;
    }
    
    @media (min-width: 768px) {
      .kpi {
        padding: 16px;
      }
    }
    
    .kpi:hover{
      background:rgba(255,255,255,0.05);
      transform:translateY(-2px);
    }
    
    .kpi .v{
      font-size:16px;
      font-weight:700;
      color:var(--accent-light);
      margin-top:4px;
    }
    
    @media (min-width: 768px) {
      .kpi .v {
        font-size: 20px;
        margin-top: 6px;
      }
    }
    
    .hint{
      font-size:11px;
      color:var(--muted);
      margin-left:6px;
      padding:3px 6px;
      border-radius:var(--radius-sm);
      background:rgba(255,255,255,0.05);
    }
    
    @media (min-width: 768px) {
      .hint {
        font-size: 12px;
        margin-left: 8px;
        padding: 4px 8px;
      }
    }
    
    .hint.warn{
      color:var(--warn);
      background:rgba(239,68,68,0.1);
    }
    
    .tabs{
      display:flex;
      gap:4px;
      margin-bottom:12px;
      background:rgba(255,255,255,0.03);
      padding:3px;
      border-radius:var(--radius);
      overflow-x:auto;
    }
    
    @media (min-width: 768px) {
      .tabs {
        gap: 6px;
        margin-bottom: 16px;
        padding: 4px;
      }
    }
    
    .tab{
      padding:8px 14px;
      border-radius:var(--radius);
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:500;
      transition:all 0.3s ease;
      flex:1;
      text-align:center;
      white-space:nowrap;
      min-width:70px;
    }
    
    @media (min-width: 768px) {
      .tab {
        padding: 10px 18px;
        min-width: 90px;
      }
    }
    
    .tab.active{
      background:var(--accent);
      color:white;
      box-shadow:var(--shadow);
    }
    
    .tab:hover:not(.active){
      background:rgba(255,255,255,0.05);
      color:var(--ink);
    }

        /* calc table - исправляем ширину колонок */
    .calc-scroll{
      overflow:auto;
      max-height:32vh;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:var(--radius);
      background:rgba(255,255,255,0.02);
    }
    
    @media (min-width: 768px) {
      .calc-scroll {
        max-height: 40vh;
      }
    }
    
    .calc-table{
      min-width:600px;
    }
    
    @media (min-width: 1024px) {
      .calc-table {
        min-width: 800px;
      }
    }
    
    @media (min-width: 1200px) {
      .calc-table {
        min-width: 1000px;
      }
    }
    
    .calc-table th{
      position:sticky;
      top:0;
      background:rgba(255,255,255,0.05);
      z-index:1;
      backdrop-filter:blur(10px);
    }
    
    /* Оптимизируем ширину колонок */
    .col-project{min-width:80px;max-width:120px}.col-villa{min-width:100px;max-width:150px}.col-qty{min-width:50px;max-width:70px}
    .col-area{min-width:50px;max-width:70px}.col-ppsm{min-width:60px;max-width:80px}.col-base{min-width:80px;max-width:100px}
    .col-disc{min-width:50px;max-width:70px}.col-pre{min-width:60px;max-width:80px}.col-months{min-width:50px;max-width:70px}
    .col-rate{min-width:60px;max-width:80px}.col-first{min-width:70px;max-width:90px}.col-lineTotal{min-width:80px;max-width:100px}
    .col-actions{min-width:50px;max-width:70px}
    
    @media (min-width: 1024px) {
      .col-project{min-width:100px;max-width:140px}.col-villa{min-width:120px;max-width:180px}.col-qty{min-width:60px;max-width:80px}
      .col-area{min-width:60px;max-width:80px}.col-ppsm{min-width:70px;max-width:90px}.col-base{min-width:100px;max-width:120px}
      .col-disc{min-width:60px;max-width:80px}.col-pre{min-width:70px;max-width:90px}.col-months{min-width:60px;max-width:80px}
      .col-rate{min-width:70px;max-width:90px}.col-first{min-width:80px;max-width:100px}.col-lineTotal{min-width:100px;max-width:120px}
      .col-actions{min-width:60px;max-width:80px}
    }
    
    @media (min-width: 1200px) {
      .col-project{min-width:120px;max-width:160px}.col-villa{min-width:140px;max-width:200px}.col-qty{min-width:70px;max-width:90px}
      .col-area{min-width:70px;max-width:90px}.col-ppsm{min-width:80px;max-width:100px}.col-base{min-width:120px;max-width:140px}
      .col-disc{min-width:70px;max-width:90px}.col-pre{min-width:80px;max-width:100px}.col-months{min-width:70px;max-width:90px}
      .col-rate{min-width:80px;max-width:100px}.col-first{min-width:90px;max-width:110px}.col-lineTotal{min-width:120px;max-width:140px}
      .col-actions{min-width:70px;max-width:90px}
    }
    
    .base-strong{
      font-weight:700;
      font-size:13px;
      color:var(--strong);
    }
    
    @media (min-width: 768px) {
      .base-strong {
        font-size: 14px;
      }
    }
    
    .line-strong{
      font-weight:700;
      font-size:13px;
      color:var(--good);
    }
    
    @media (min-width: 768px) {
      .line-strong {
        font-size: 14px;
      }
    }
    
    /* modal - исправляем ширину и отступы */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      backdrop-filter:blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
      animation:fadeIn 0.3s ease;
      padding:12px;
    }
    
    @media (min-width: 768px) {
      .modal {
        padding: 20px;
      }
    }
    
    @keyframes fadeIn{
      from{opacity:0} to{opacity:1}
    }
    
    .modal .panel{
      background:var(--card);
      backdrop-filter:blur(20px);
      border:1px solid var(--line);
      border-radius:var(--radius-xl);
      width:100%;
      max-width:1200px;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      box-shadow:var(--shadow-2xl);
      animation:slideUp 0.3s ease;
    }
    
    @media (min-width: 768px) {
      .modal .panel {
        max-height: 85vh;
      }
    }
    
    @keyframes slideUp{
      from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1}
    }
    
    .modal .head{
      padding:16px 20px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    
    @media (min-width: 768px) {
      .modal .head {
        padding: 20px 24px;
        gap: 16px;
      }
    }
    
    .modal .body{
      display:grid;
      grid-template-columns:1fr;
      min-height:45vh;
    }
    
    @media (min-width: 768px) {
      .modal .body {
        grid-template-columns: 300px 1fr;
        min-height: 55vh;
      }
    }
    
    .modal .side{
      border-right:none;
      border-bottom:1px solid var(--line);
      overflow:auto;
      background:rgba(255,255,255,0.02);
      max-height:200px;
      padding:12px;
    }
    
    @media (min-width: 768px) {
      .modal .side {
        border-right: 1px solid var(--line);
        border-bottom: none;
        max-height: none;
        padding: 16px;
      }
    }
    
    .modal .content{
      overflow:auto;
      padding:16px;
    }
    
    @media (min-width: 768px) {
      .modal .content {
        padding: 20px;
      }
    }
    
    .side .proj{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.05);
      cursor:pointer;
      transition:all 0.3s ease;
      border-radius:var(--radius-sm);
      margin-bottom:4px;
    }
    
    @media (min-width: 768px) {
      .side .proj {
        padding: 12px 16px;
        margin-bottom: 6px;
      }
    }
    
    .side .proj:hover{
      background:rgba(255,255,255,0.05);
    }
    
    .side .proj.active{
      background:var(--accent);
      color:white;
    }
    
    .filters{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
      margin-bottom:16px;
    }
    
    @media (min-width: 480px) {
      .filters {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
    }
    
    @media (min-width: 768px) {
      .filters {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }
    }
    
    .modal table{
      min-width:500px;
      font-size:11px;
    }
    
    @media (min-width: 768px) {
      .modal table {
        min-width: 700px;
        font-size: 13px;
      }
    }
    
    .modal .foot{
      padding:16px 20px;
      border-top:1px solid var(--line);
      display:flex;
      gap:12px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    
    @media (min-width: 768px) {
      .modal .foot {
        padding: 20px 24px;
        gap: 16px;
      }
    }
    
    /* Улучшенные стили для форм */
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    @media (min-width: 480px) {
      .form-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
    }
    
    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--ink);
      font-size: 12px;
    }
    
    @media (min-width: 768px) {
      .form-label {
        font-size: 13px;
        margin-bottom: 8px;
      }
    }
    
    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid transparent;
      border-radius: var(--radius);
      background: rgba(255,255,255,0.05);
      color: var(--ink);
      font-size: 13px;
      transition: all 0.3s ease;
    }
    
    @media (min-width: 768px) {
      .form-input {
        padding: 12px 14px;
        font-size: 14px;
      }
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.08);
      box-shadow: 0 0 0 4px rgba(139,92,246,0.1);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-select {
      cursor: pointer;
    }
    
    .form-select option {
      background: var(--card);
      color: var(--ink);
    }
    
    /* Специальные стили для каталога */
    .catalog-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }
    
    .catalog-card:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.12);
    }
    
    .catalog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .catalog-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent-light);
      margin: 0;
    }
    
    .catalog-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .catalog-table {
      width: 100%;
      font-size: 11px;
    }
    
    @media (min-width: 768px) {
      .catalog-table {
        font-size: 12px;
      }
    }
    
    .catalog-table th,
    .catalog-table td {
      padding: 6px 4px;
      text-align: left;
    }
    
    @media (min-width: 768px) {
      .catalog-table th,
      .catalog-table td {
        padding: 8px 6px;
      }
    }
    
    .catalog-table input {
      width: 100%;
      padding: 4px 6px;
      font-size: 11px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--ink);
      border-radius: var(--radius-sm);
      transition: all 0.3s ease;
    }
    
    @media (min-width: 768px) {
      .catalog-table input {
        padding: 6px 8px;
        font-size: 12px;
      }
    }
    
    .catalog-table input:focus {
      border-color: var(--accent);
      background: rgba(255,255,255,0.05);
    }
    
    .catalog-table input:disabled {
      background: rgba(255,255,255,0.02);
      color: var(--muted);
    }

        /* Адаптивные стили для мобильных устройств */
    @media (max-width: 767px) {
      .row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .field {
        margin-bottom: 10px;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 6px;
        padding: 10px 16px;
        font-size: 13px;
      }
      
      .btn.icon {
        width: auto;
        margin-bottom: 0;
        min-width: 36px;
      }
      
      .tabs {
        flex-direction: column;
        gap: 2px;
      }
      
      .tab {
        min-width: auto;
        padding: 8px 12px;
      }
      
      .kpis {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      
      .calc-scroll {
        max-height: 25vh;
      }
      
      .scroll {
        max-height: 25vh;
      }
      
      .modal .panel {
        margin: 8px;
        max-height: calc(100vh - 16px);
        border-radius: var(--radius-lg);
      }
      
      .modal .body {
        min-height: 35vh;
      }
      
      .modal .side {
        max-height: 120px;
        padding: 8px;
      }
      
      .modal .content {
        padding: 12px;
      }
      
      .modal .head {
        padding: 12px 16px;
      }
      
      .modal .foot {
        padding: 12px 16px;
        gap: 8px;
      }
      
      .catalog-card {
        padding: 12px;
        margin-bottom: 8px;
      }
      
      .catalog-header {
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
      }
      
      .catalog-actions {
        justify-content: center;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .form-group {
        margin-bottom: 12px;
      }
      
      .form-input {
        padding: 8px 10px;
        font-size: 12px;
      }
      
      .form-label {
        font-size: 11px;
        margin-bottom: 4px;
      }
    }
    
    /* Стили для планшетов */
    @media (min-width: 768px) and (max-width: 1023px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 18px;
      }
      
      .card {
        padding: 18px;
      }
      
      .calc-scroll {
        max-height: 35vh;
      }
      
      .kpis {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
      
      .modal .body {
        grid-template-columns: 250px 1fr;
        min-height: 50vh;
      }
      
      .modal .side {
        padding: 14px;
      }
      
      .modal .content {
        padding: 18px;
      }
      
      .form-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
      }
    }
    
    /* Стили для ноутбуков */
    @media (min-width: 1024px) and (max-width: 1199px) {
      .grid {
        grid-template-columns: 380px 1fr;
        gap: 18px;
      }
      
      .wrap {
        max-width: 1200px;
      }
      
      .calc-table {
        min-width: 900px;
      }
      
      .modal .body {
        grid-template-columns: 280px 1fr;
        min-height: 60vh;
      }
    }
    
    /* Стили для больших экранов */
    @media (min-width: 1200px) {
      .wrap {
        max-width: 1400px;
      }
      
      .grid {
        grid-template-columns: 420px 1fr;
        gap: 24px;
      }
      
      .calc-table {
        min-width: 1000px;
      }
      
      .modal .body {
        grid-template-columns: 320px 1fr;
        min-height: 65vh;
      }
      
      .modal .panel {
        max-width: 1300px;
      }
    }
    
    /* Улучшенные анимации */
    .card, .btn, .kpi, .tab {
      animation: fadeInUp 0.6s ease forwards;
      opacity: 0;
      transform: translateY(20px);
    }
    
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Задержка анимации для разных элементов */
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .kpi:nth-child(1) { animation-delay: 0.3s; }
    .kpi:nth-child(2) { animation-delay: 0.4s; }
    .kpi:nth-child(3) { animation-delay: 0.5s; }
    .kpi:nth-child(4) { animation-delay: 0.6s; }
    .kpi:nth-child(5) { animation-delay: 0.7s; }
    
    /* Дополнительные анимации */
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-xl);
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-2xl);
    }
    
    .kpi:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-xl);
    }
    
    /* Анимация для таблиц */
    .calc-table tbody tr {
      transition: all 0.3s ease;
    }
    
    .calc-table tbody tr:hover {
      background: rgba(255,255,255,0.03);
    }
    
    /* Анимация для модальных окон */
    .modal .panel {
      animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    @keyframes modalSlideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* Анимация для форм */
    .form-input:focus {
      transform: translateY(-1px);
    }
    
    /* Анимация для кнопок */
    .btn:active {
      transform: translateY(0);
      transition: transform 0.1s ease;
    }
    
    /* Улучшенные стили для скроллбаров */
    .scroll::-webkit-scrollbar,
    .calc-scroll::-webkit-scrollbar,
    .modal .content::-webkit-scrollbar,
    .modal .side::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    .scroll::-webkit-scrollbar-track,
    .calc-scroll::-webkit-scrollbar-track,
    .modal .content::-webkit-scrollbar-track,
    .modal .side::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 3px;
    }
    
    .scroll::-webkit-scrollbar-thumb,
    .calc-scroll::-webkit-scrollbar-thumb,
    .modal .content::-webkit-scrollbar-thumb,
    .modal .side::-webkit-scrollbar-thumb {
      background: rgba(139,92,246,0.3);
      border-radius: 3px;
      transition: background 0.3s ease;
    }
    
    .scroll::-webkit-scrollbar-thumb:hover,
    .calc-scroll::-webkit-scrollbar-thumb:hover,
    .modal .content::-webkit-scrollbar-thumb:hover,
    .modal .side::-webkit-scrollbar-thumb:hover {
      background: rgba(139,92,246,0.5);
    }
    
    /* Улучшенные стили для состояний загрузки */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    /* Улучшенные стили для фокуса */
    .btn:focus,
    .tab:focus,
    .form-input:focus,
    .form-select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(139,92,246,0.2);
    }
    
    /* Улучшенные стили для отключенных элементов */
    .btn:disabled,
    .tab:disabled,
    .form-input:disabled,
    .form-select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    /* Улучшенные стили для ошибок */
    .error {
      border-color: var(--warn) !important;
      background: rgba(239,68,68,0.05) !important;
    }
    
    .error-message {
      color: var(--warn);
      font-size: 11px;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Улучшенные стили для успеха */
    .success {
      border-color: var(--success) !important;
      background: rgba(34,197,94,0.05) !important;
    }
    
    .success-message {
      color: var(--success);
      font-size: 11px;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Улучшенные стили для предупреждений */
    .warning {
      border-color: var(--warning) !important;
      background: rgba(245,158,11,0.05) !important;
    }
    
    .warning-message {
      color: var(--warning);
      font-size: 11px;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Улучшенные стили для информационных сообщений */
    .info {
      border-color: var(--info) !important;
      background: rgba(6,182,212,0.05) !important;
    }
    
    .info-message {
      color: var(--info);
      font-size: 11px;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Улучшенные стили для печати */
    @media print{
      body{background:#fff;color:#000}
      .wrap{max-width:none;margin:0;padding:0}
      .grid{display:block}
      .card{border:0;border-radius:0}
      .hr{margin:12px 0}
      .tabs,.row button,.field select,.field input{display:none !important}
      canvas{break-inside:avoid}
      .modal{display:none !important}
      .btn{display:none !important}
    }
    
    /* Дополнительные утилитарные классы */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    
    .w-full { width: 100%; }
    .h-full { height: 100%; }
    
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .flex-row { flex-direction: row; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    
    .gap-1 { gap: var(--space-xs); }
    .gap-2 { gap: var(--space-sm); }
    .gap-3 { gap: var(--space-md); }
    .gap-4 { gap: var(--space-lg); }
    .gap-5 { gap: var(--space-xl); }
    .gap-6 { gap: var(--space-2xl); }
    
    .p-1 { padding: var(--space-xs); }
    .p-2 { padding: var(--space-sm); }
    .p-3 { padding: var(--space-md); }
    .p-4 { padding: var(--space-lg); }
    .p-5 { padding: var(--space-xl); }
    .p-6 { padding: var(--space-2xl); }
    
    .m-1 { margin: var(--space-xs); }
    .m-2 { margin: var(--space-sm); }
    .m-3 { margin: var(--space-md); }
    .m-4 { margin: var(--space-lg); }
    .m-5 { margin: var(--space-xl); }
    .m-6 { margin: var(--space-2xl); }
    
    .rounded { border-radius: var(--radius); }
    .rounded-lg { border-radius: var(--radius-lg); }
    .rounded-xl { border-radius: var(--radius-xl); }
    
    .shadow { box-shadow: var(--shadow); }
    .shadow-lg { box-shadow: var(--shadow-lg); }
    .shadow-xl { box-shadow: var(--shadow-xl); }
    
    .transition { transition: all 0.3s ease; }
    .duration-300 { transition-duration: 0.3s; }
    .duration-500 { transition-duration: 0.5s; }
    
    .hover\:scale-105:hover { transform: scale(1.05); }
    .hover\:scale-110:hover { transform: scale(1.1); }
    .hover\:scale-95:hover { transform: scale(0.95); }
    
    .hover\:rotate-1:hover { transform: rotate(1deg); }
    .hover\:rotate-2:hover { transform: rotate(2deg); }
    .hover\:-rotate-1:hover { transform: rotate(-1deg); }
    .hover\:-rotate-2:hover { transform: rotate(-2deg); }


   </style>
</head>
<body>
  <div class="wrap">
    <h1 id="app-title">Arconique / Калькулятор рассрочки для любимых клиентов — v7.6</h1>
    <div id="boot-diagnostics" style="position:fixed;left:10px;top:10px;z-index:99999;background:#1b2336;color:#fff;border:1px solid #334;padding:8px 10px;border-radius:8px;font:12px/1.4 system-ui;max-width:80vw;display:none"></div>
    <div id="root"></div>
  </div>

  <!-- libs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <!-- boot diagnostics: ловим CDN/JSX ошибки и запускаем компиляцию -->
  <script>
    (function(){
      const box=document.getElementById('boot-diagnostics');
      const log=(msg)=>{ box.style.display='block'; box.innerHTML+=(box.innerHTML?'<br>':'')+msg; };
      window.addEventListener('error',e=>log('JS error: '+(e?.message||e)));
      window.addEventListener('unhandledrejection',e=>log('Promise error: '+(e?.reason?.message||e?.reason||e)));

      let tries=0;
      function tick(){
        const okReact=!!(window.React&&window.ReactDOM);
        const okBabel=!!window.Babel;
        if(!okReact) log('React не загрузился (CDN?)');
        if(!okBabel) log('Babel не загрузился — JSX не скомпилируется');
        if(okReact&&okBabel){
          try{ window.Babel.transformScriptTags(); }
          catch(e){ log('Babel.transformScriptTags() error: '+e.message); }
          return;
        }
        if(++tries<30) setTimeout(tick,200);
        else log('Таймаут ожидания библиотек — проверь блокировщики/фаервол/CDN');
      }
      setTimeout(tick,0);
    })();
  </script>

  <!-- v7.6 (stable) -->
  <script type="text/babel" data-presets="env,react">

        const {useEffect,useMemo,useRef,useState} = React;

    /* ---------- PIN / security ---------- */
    const PIN_CODE = '334346';
    const PIN_SALT = 'enso-v7.4-salt-1';
    const PIN_HASH_HEX = 'c0b37fd5b1ebc835af06c260b9ceb435285f79ecffd7f0a68be695db347d2aa6'; // sha256('334346|enso-v7.4-salt-1')

    async function sha256Hex(str){
      try{
        // Проверяем доступность crypto.subtle
        if (!crypto.subtle) {
          console.warn('crypto.subtle not available, using fallback');
          return '';
        }
        const buf = new TextEncoder().encode(str);
        const digest = await crypto.subtle.digest('SHA-256', buf);
        return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(e){ 
        console.warn('SHA-256 failed:', e);
        return ''; 
      }
    }
    async function verifyPinFlow(){
      const pin = prompt('Enter PIN');
      if(pin==null) return false;
      const hex = await sha256Hex(`${pin}|${PIN_SALT}`);
      if(hex && hex === PIN_HASH_HEX) return true;
      return pin === PIN_CODE; // fallback
    }

    /* ---------- i18n ---------- */
    const T = {
      ru: {
        title:'Arconique / Калькулятор рассрочки для любимых клиентов — v7.6',
        editor:'Редактор', client:'Клиент',
        lang:'Язык интерфейса', currencyDisplay:'Валюта отображения',
        idrRate:'IDR за 1 USD', eurRate:'EUR за 1 USD',
        handoverMonth:'Месяц получения ключей',
        globalTerm:'Глобальный срок post‑handover (6–24 мес)',
        globalRate:'Глобальная ставка, %/мес',
        clientTerm:'Срок post‑handover (мес)',
        stagesTitle:'Этапы ДО ключей',
        stage:'Этап', percent:'%', month:'Месяц',
        addStage:'Добавить этап', delete:'Удалить',
        villasTitle:'Расчёт (позиции)',
        project:'Проект', villa:'Вилла', qty:'Кол-во',
        area:'м²', ppsm:'$ / м²', price:'База (USD)',
        discount:'Скидка, %', prePct:'До ключей, %',
        months:'Срок, мес', rate:'Ставка, %/мес',
        firstPost:'Первый платёж', lineTotal:'Итог по строке',
        addFromCatalog:'Добавить из каталога',
        cashflowTitle:'Сводный кэшфлоу по месяцам',
        cashMonth:'Месяц', cashDesc:'Описание',
        cashTotal:'Сумма к оплате', cashBalance:'Остаток долга',
        totals:'Итоги', base:'База', prepay:'Оплата до ключей',
        after:'Остаток после ключей', interestTotal:'Проценты (post)',
        final:'Итоговая цена',
        lines:'Позиций', keys:'Ключи: мес.',
        chartTitle:'Платежи по месяцам',
        sumStages:'Сумма этапов', targetPrepay:'Целевой % до ключей',
        mismatch:'— отличается от целевого', mixedTargets:'разные цели у строк',
        shareCopied:'Ссылка скопирована',
        exportCSV:'Экспорт CSV', exportXLSX:'Экспорт Excel', exportPDF:'Сохранить в PDF',
        tabCalc:'Расчёт', tabCatalog:'Каталог',
        catalogTitle:'Каталог проектов и вилл (редактор)',
        addProject:'Добавить проект', addVilla:'Добавить виллу',
        importJSON:'Импорт JSON', exportJSON:'Экспорт JSON',
        selectFromCatalog:'Выбор из каталога',
        search:'Поиск', areaFrom:'м² от', areaTo:'м² до',
        priceFrom:'Цена от', priceTo:'Цена до',
        sort:'Сортировать', byPrice:'по цене', byArea:'по площади', byName:'по названию',
        addSelected:'Добавить выбранные', cancel:'Отмена',
        qtyShort:'Кол-во', baseUSD:'База (USD)',
        // Новые поля для улучшенного каталога
        projectId:'ID проекта', projectName:'Название проекта',
        villaId:'ID виллы', villaName:'Название виллы',
        villaArea:'Площадь (м²)', villaPpsm:'Цена за м² ($)',
        villaBasePrice:'Базовая цена ($)', save:'Сохранить',
        edit:'Редактировать', remove:'Удалить'
      },
      en: {
        title:'Arconique / Installments Calculator — v7.6',
        editor:'Editor', client:'Client',
        lang:'Language', currencyDisplay:'Display currency',
        idrRate:'IDR per 1 USD', eurRate:'EUR per 1 USD',
        handoverMonth:'Handover month',
        globalTerm:'Global post‑handover term (6–24 mo)',
        globalRate:'Global rate, %/month',
        clientTerm:'Post‑handover term (months)',
        stagesTitle:'Pre‑handover stages',
        stage:'Stage', percent:'%', month:'Month',
        addStage:'Add stage', delete:'Delete',
        villasTitle:'Calculation (lines)',
        project:'Project', villa:'Villa', qty:'Qty',
        area:'sqm', ppsm:'$ / sqm', price:'Base (USD)',
        discount:'Discount, %', prePct:'Pre‑handover, %',
        months:'Term, mo', rate:'Rate, %/mo',
        firstPost:'First payment', lineTotal:'Line total',
        addFromCatalog:'Add from catalog',
        cashflowTitle:'Monthly consolidated cashflow',
        cashMonth:'Month', cashDesc:'Description',
        cashTotal:'Amount due', cashBalance:'Remaining balance',
        totals:'Totals', base:'Base', prepay:'Paid before keys',
        after:'Balance after keys', interestTotal:'Interest (post)',
        final:'Final price',
        lines:'Lines', keys:'Keys: mo.',
        chartTitle:'Payments by month',
        sumStages:'Stages sum', targetPrepay:'Target pre‑handover %',
        mismatch:'— differs from target', mixedTargets:'different line targets',
        shareCopied:'Link copied',
        exportCSV:'Export CSV', exportXLSX:'Export Excel', exportPDF:'Save to PDF',
        tabCalc:'Calculation', tabCatalog:'Catalog',
        catalogTitle:'Projects & Villas Catalog (editor)',
        addProject:'Add project', addVilla:'Add villa',
        importJSON:'Import JSON', exportJSON:'Export JSON',
        selectFromCatalog:'Select from catalog',
        search:'Search', areaFrom:'sqm from', areaTo:'sqm to',
        priceFrom:'Price from', priceTo:'Price to',
        sort:'Sort', byPrice:'by price', byArea:'by area', byName:'by name',
        addSelected:'Add selected', cancel:'Cancel',
        qtyShort:'Qty', baseUSD:'Base (USD)',
        // Новые поля для улучшенного каталога
        projectId:'Project ID', projectName:'Project Name',
        villaId:'Villa ID', villaName:'Villa Name',
        villaArea:'Area (sqm)', villaPpsm:'Price per sqm ($)',
        villaBasePrice:'Base Price ($)', save:'Save',
        edit:'Edit', remove:'Remove'
      }
    };

    const clamp=(v,lo,hi)=>Math.min(hi,Math.max(lo,v));
    const fmtMoney=(n,c='USD')=>new Intl.NumberFormat('en-US',{style:'currency',currency:c,maximumFractionDigits:2}).format(n??0);

    /* ---------- URL state (compressed hash) ---------- */
    const readHash=()=>{const h=location.hash.startsWith('#')?location.hash.slice(1):location.hash;const sp=new URLSearchParams(h);return {s:sp.get('s'),view:sp.get('view')}};
    const encodeState=(state,{view}={})=>{try{const s=LZString.compressToEncodedURIComponent(JSON.stringify(state));const u=new URL(location.href);const sp=new URLSearchParams();sp.set('s',s);if(view)sp.set('view',view);u.hash=sp.toString();return u.toString()}catch{return''}};
    const decodeState=()=>{try{const {s,view}=readHash();if(!s)return null;const json=LZString.decompressFromEncodedURIComponent(s);return {state:JSON.parse(json),view}}catch{return null}};

    /* ---------- demo catalog ---------- */
    const DEFAULT_CATALOG=[
      {projectId:'ahao',projectName:'AHAO Gardens',villas:[
        {villaId:'ahao-2br',name:'2BR Garden Villa',area:100,ppsm:2500,baseUSD:250000},
        {villaId:'ahao-3br',name:'3BR Garden Villa',area:130,ppsm:2450,baseUSD:318500}
      ]},
      {projectId:'enso',projectName:'Enso Villas',villas:[
        {villaId:'enso-2br',name:'Enso 2BR',area:100,ppsm:2500,baseUSD:250000},
        {villaId:'enso-3br',name:'Enso 3BR',area:120,ppsm:2700,baseUSD:324000}
      ]},
      {projectId:'eternal',projectName:'Eternal Villas',villas:[
        {villaId:'eternal-1br',name:'Eternal 1BR Loft',area:80,ppsm:2600,baseUSD:208000},
        {villaId:'eternal-2br',name:'Eternal 2BR',area:110,ppsm:2550,baseUSD:280500}
      ]}
    ];

    /* ---------- Components ---------- */
    function App(){
      const [lang,setLang]=useState('ru'); const t=T[lang];
      const [tab,setTab]=useState('calc'); // 'calc'|'catalog'
      const [isClient,setIsClient]=useState(true);

      const [currency,setCurrency]=useState('USD');
      const [idrPerUsd,setIdrPerUsd]=useState(16500);
      const [eurPerUsd,setEurPerUsd]=useState(0.92);
      const toCurrency=usd=>currency==='USD'?usd:(currency==='IDR'?usd*idrPerUsd:usd*eurPerUsd);

      const [handoverMonth,setHandoverMonth]=useState(12);
      const [months,setMonths]=useState(12);
      const [monthlyRatePct,setMonthlyRatePct]=useState(8.33);

      const [stages,setStages]=useState([
        {id:1,label:'Договор',pct:30,month:0},
        {id:2,label:'50% готовности',pct:30,month:6},
        {id:3,label:'70% готовности',pct:20,month:9},
        {id:4,label:'90% готовности',pct:15,month:11},
        {id:5,label:'Ключи',pct:5,month:12},
      ]);
      const stagesSumPct=useMemo(()=>stages.reduce((s,x)=>s+(+x.pct||0),0),[stages]);

      const [catalog,setCatalog]=useState(DEFAULT_CATALOG);

      const [lines,setLines]=useState([
        {id:1,projectId:'enso',villaId:'enso-2br',qty:1,prePct:70,ownTerms:false,months:null,monthlyRatePct:null,firstPostUSD:0,discountPct:0,
         snapshot:{name:'Enso 2BR',area:100,ppsm:2500,baseUSD:250000}}
      ]);

      const [modalOpen,setModalOpen]=useState(false);
      const [catalogModalOpen,setCatalogModalOpen]=useState(false);

      useEffect(()=>{(async()=>{
        try{
          const fromUrl=decodeState();
          const saved=fromUrl?.state || JSON.parse(localStorage.getItem('arconique_v76')||'null');
          if(saved){
            if(saved.lang) setLang(saved.lang);
            if(saved.currency) setCurrency(saved.currency);
            if(typeof saved.idrPerUsd==='number') setIdrPerUsd(saved.idrPerUsd);
            if(typeof saved.eurPerUsd==='number') setEurPerUsd(saved.eurPerUsd);
            if(typeof saved.handoverMonth==='number') setHandoverMonth(saved.handoverMonth);
            if(typeof saved.months==='number') setMonths(saved.months);
            if(typeof saved.monthlyRatePct==='number') setMonthlyRatePct(saved.monthlyRatePct);
            if(Array.isArray(saved.stages)) setStages(saved.stages);
            if(Array.isArray(saved.catalog)) setCatalog(saved.catalog);
            if(Array.isArray(saved.lines)) setLines(saved.lines);
            if(saved.tab) setTab(saved.tab);
          }
          const view=(fromUrl?.view)|| (new URLSearchParams(location.hash.slice(1)).get('view'));
          if(view==='editor'){
            const ok=await verifyPinFlow();
            setIsClient(!ok);
            if(!ok){
              const url=encodeState(snapshot(),{view:'client'});
              if(url) history.replaceState(null,'',url);
              alert(lang==='ru'?'Неверный PIN — открыт клиентский режим':'Wrong PIN — opened client view');
            }
          }else setIsClient(true);
        }catch(e){ console.error(e); }
        document.getElementById('app-title').textContent=t.title;
        document.title=t.title;
      })()},[]);

      const snapshot=()=>({lang,currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,catalog,lines,tab});
      useEffect(()=>{
        localStorage.setItem('arconique_v76',JSON.stringify(snapshot()));
        document.getElementById('app-title').textContent=t.title;
        document.title=t.title;
      },[lang,currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,catalog,lines,tab]);

      const findProject=pid=>catalog.find(p=>p.projectId===pid);

      const linesData=useMemo(()=>lines.map(line=>{
        const base0=line.snapshot?.baseUSD ?? ((line.snapshot?.area||0)*(line.snapshot?.ppsm||0));
        const disc=clamp(+line.discountPct||0,0,20);
        const base=base0*(1-disc/100);

        const prePct=line.prePct ?? 0;
        const k=stagesSumPct===0?0:prePct/stagesSumPct;
        const preSchedule=stages.map(s=>({
          month:Math.max(0,Math.min(handoverMonth,Math.round(+s.month||0))),
          label:s.label,
          amountUSD: base*(((+s.pct||0)*k)/100),
        })).filter(r=>r.amountUSD>0).sort((a,b)=>a.month-b.month);
        const preTotalOne=preSchedule.reduce((s,r)=>s+r.amountUSD,0);

        const vMonths=line.ownTerms && line.months ? line.months : months;
        const rate=(line.ownTerms && line.monthlyRatePct!=null)?(line.monthlyRatePct/100):(monthlyRatePct/100);
        const firstPostUSD=Math.max(0,+line.firstPostUSD||0);
        const principalBase=Math.max(0, base - preTotalOne - firstPostUSD);

        let bal=principalBase,totalInterest=0;
        const principalShare=vMonths>0?principalBase/vMonths:0;
        const postRows=[];
        for(let i=1;i<=vMonths;i++){
          const interest=bal*rate; totalInterest+=interest;
          const payment=principalShare+interest;
          postRows.push({month:handoverMonth+i,label:(lang==='ru'?'Месяц ':'Month ')+i,principalUSD:principalShare,interestUSD:interest,paymentUSD:payment,balanceAfterUSD:Math.max(0,bal-principalShare)});
          bal-=principalShare;
        }
        const lineTotalOne=base+totalInterest;

        const qty=Math.max(1,parseInt(line.qty||1,10));
        const preScheduleQ=preSchedule.map(r=>({...r,amountUSD:r.amountUSD*qty}));
        const postRowsQ=postRows.map(r=>({...r,principalUSD:r.principalUSD*qty,interestUSD:r.interestUSD*qty,paymentUSD:r.paymentUSD*qty}));
        const preTotal=preTotalOne*qty;
        const firstPostQ=firstPostUSD*qty;
        const baseQ=base*qty;
        const lineTotal=lineTotalOne*qty;

        return {line,qty,baseOne:base,base:baseQ,preSchedule:preScheduleQ,preTotal,firstPostUSD:firstPostQ,postRows:postRowsQ,lineTotal,vMonths,rate,discountPct:disc};
      }),[lines,stages,stagesSumPct,handoverMonth,months,monthlyRatePct,lang]);

      const project=useMemo(()=>{
        const totals={
          baseUSD:linesData.reduce((s,x)=>s+x.base,0),
          preUSD: linesData.reduce((s,x)=>s+x.preTotal,0),
          finalUSD:linesData.reduce((s,x)=>s+x.lineTotal,0),
        };
        totals.interestUSD = totals.finalUSD - totals.baseUSD;
        totals.afterUSD = totals.finalUSD - totals.preUSD;

        const m=new Map();
        const push=(month,amt,desc)=>{ if(amt<=0) return; const prev=m.get(month)||{month,items:[],amountUSD:0}; prev.items.push(desc); prev.amountUSD+=amt; m.set(month,prev); };
        linesData.forEach(ld=>{
          ld.preSchedule.forEach(r=> push(r.month,r.amountUSD,`${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${r.label}`));
          if(ld.firstPostUSD>0) push(handoverMonth+1, ld.firstPostUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${lang==='ru'?'Первый платёж':'First payment'}`);
          ld.postRows.forEach(r=> push(r.month, r.paymentUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${r.label}`));
        });
        const raw=[...m.values()].sort((a,b)=>a.month-b.month);
        let cumulative=0;
        const cashflow=raw.map(row=>{ cumulative+=row.amountUSD; const balanceUSD=Math.max(0, totals.finalUSD - cumulative); return {...row,cumulativeUSD:cumulative,balanceUSD}; });
        return {totals,cashflow};
      },[linesData,handoverMonth,lang]);

      const chartRef=useRef(null); const chartObj=useRef(null);
      useEffect(()=>{
        try{
          const ctx=chartRef.current?.getContext('2d'); if(!ctx) return;
          if(chartObj.current) chartObj.current.destroy();
          chartObj.current=new Chart(ctx,{
            type:'bar',
            data:{labels:project.cashflow.map(c=>String(c.month)),datasets:[{label:T[lang].chartTitle,data:project.cashflow.map(c=>toCurrency(c.amountUSD))}]},
            options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:(c)=>fmtMoney(c.parsed.y,currency)}}},scales:{y:{ticks:{callback:(v)=>fmtMoney(v,currency)}}}}
          });
        }catch(e){ /* если Chart.js не загрузился — не ломаем страницу */ }
      },[project.cashflow,currency,idrPerUsd,eurPerUsd,lang]);

      const exportCSV=()=>{
        const rows=[[t.cashMonth,t.cashDesc,t.cashTotal,t.cashBalance],...project.cashflow.map(c=>[c.month,(c.items||[]).join(' + '),toCurrency(c.amountUSD).toFixed(2),toCurrency(c.balanceUSD).toFixed(2)])];
        const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`arconique_cashflow_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(a.href);
      };
      const exportXLSX=()=>{
        const ws1=XLSX.utils.json_to_sheet(project.cashflow.map(c=>({[t.cashMonth]:c.month,[t.cashDesc]:(c.items||[]).join(' + '),[t.cashTotal]:toCurrency(c.amountUSD),[t.cashBalance]:toCurrency(c.balanceUSD)})));
        const ws2=XLSX.utils.json_to_sheet(linesData.map(ld=>({[t.project]:findProject(ld.line.projectId)?.projectName||ld.line.projectId,[t.villa]:ld.line.snapshot?.name,[t.qty]:ld.qty,[t.area]:ld.line.snapshot?.area,[t.ppsm]:ld.line.snapshot?.ppsm,[t.price]:ld.base,[t.discount]:(ld.discountPct||0)+'%',[t.prePct]:ld.line.prePct,[t.months]:ld.vMonths,[t.lineTotal]:ld.lineTotal})));
        const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws1,'Cashflow'); XLSX.utils.book_append_sheet(wb,ws2,'Lines'); XLSX.writeFile(wb,`arconique_installments_${new Date().toISOString().slice(0,10)}.xlsx`);
      };
      const exportPDF=()=>window.print();

      const share=async(view)=>{const url=encodeState(snapshot(),{view}); if(url){await navigator.clipboard.writeText(url); alert(t.shareCopied)}};

      const updLine=(id,patch)=>setLines(prev=>prev.map(l=>l.id===id?{...l,...patch}:l));
      const delLine=(id)=>setLines(prev=>prev.filter(l=>l.id!==id));
      const dupLine=(id)=>setLines(prev=>{const src=prev.find(x=>x.id===id); if(!src)return prev; const nid=(prev[prev.length-1]?.id||0)+1; return [...prev,{...src,id:nid,qty:1}]});

      return (
        <>
          <div className="grid">
            <div className="card">
              {!isClient && (
                <div className="tabs">
                  <button className={`tab ${tab==='calc'?'active':''}`} onClick={()=>setTab('calc')}>{t.tabCalc}</button>
                  <button className={`tab ${tab==='catalog'?'active':''}`} onClick={()=>setTab('catalog')}>{t.tabCatalog}</button>
                </div>
              )}

              <div className="field">
                <label>{t.lang}</label>
                <select value={lang} onChange={e=>setLang(e.target.value)}>
                  <option value="ru">Русский</option><option value="en">English</option>
                </select>
              </div>

              <div className="field">
                <label>{t.currencyDisplay}</label>
                <select value={currency} onChange={e=>setCurrency(e.target.value)}>
                  <option>USD</option><option>IDR</option><option>EUR</option>
                </select>
              </div>

              {!isClient && (
                <div className="row">
                  <div className="field" style={{flex:1}}>
                    <label>{t.idrRate}</label>
                    <input type="number" min="1" step="1" value={idrPerUsd} onChange={e=>setIdrPerUsd(clamp(parseFloat(e.target.value||0),1,1e9))}/>
                  </div>
                  <div className="field" style={{flex:1}}>
                    <label>{t.eurRate}</label>
                    <input type="number" min="0.01" step="0.01" value={eurPerUsd} onChange={e=>setEurPerUsd(clamp(parseFloat(e.target.value||0),0.01,100))}/>
                  </div>
                </div>
              )}

              <div className="row">
                <div className="field" style={{flex:1}}>
                  <label>{t.handoverMonth}</label>
                  <input type="number" min="1" step="1" value={handoverMonth} onChange={e=>setHandoverMonth(clamp(parseInt(e.target.value||0,10),1,120))}/>
                </div>
                {!isClient ? (
                  <>
                    <div className="field" style={{flex:1}}>
                      <label>{t.globalTerm}</label>
                      <input type="range" min="6" max="24" step="1" value={months} onChange={e=>setMonths(parseInt(e.target.value,10))}/>
                      <div className="pill">{t.months}: {months}</div>
                    </div>
                    <div className="field" style={{flex:1}}>
                      <label>{t.globalRate}</label>
                      <input type="number" min="0" step="0.01" value={monthlyRatePct} onChange={e=>setMonthlyRatePct(clamp(parseFloat(e.target.value||0),0,1000))}/>
                    </div>
                  </>
                ) : (
                  <div className="field" style={{flex:1}}>
                    <label>{t.clientTerm}</label>
                    <input type="number" min="6" step="1" value={months} onChange={e=>setMonths(clamp(parseInt(e.target.value||0,10),6,120))}/>
                  </div>
                )}
              </div>

              <div className="hr"></div>

              <h3 style={{margin:'6px 0'}}>{t.stagesTitle}</h3>
              <div className="scroll" style={{maxHeight:'26vh',border:'1px dashed #223',borderRadius:'8px',padding:'6px'}}>
                <table>
                  <thead><tr><th>{t.stage}</th><th>{t.percent}</th><th>{t.month}</th><th></th></tr></thead>
                  <tbody>
                    {stages.map(s=>(
                      <tr key={s.id}>
                        <td style={{textAlign:'left'}}><input type="text" value={s.label} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,label:e.target.value}:x))}/></td>
                        <td><input type="number" min="0" step="0.01" value={s.pct} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,pct:clamp(parseFloat(e.target.value||0),0,100)}:x))}/></td>
                        <td><input type="number" min="0" step="1" value={s.month} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,month:clamp(parseInt(e.target.value||0,10),0,handoverMonth)}:x))}/></td>
                        <td><button className="btn warn" onClick={()=>setStages(prev=>prev.filter(x=>x.id!==s.id))}>{t.delete}</button></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="row" style={{marginTop:8,alignItems:'center',justifyContent:'space-between'}}>
                <button className="btn" onClick={()=>setStages(prev=>{const last=prev[prev.length-1];const id=(last?.id||0)+1;const nextMonth=Math.min(handoverMonth,(last?.month??0)+1);return [...prev,{id,label:(lang==='ru'?'Этап':'Stage'),pct:5,month:nextMonth}]})}>{t.addStage}</button>
                {(() => {
                  const vals=lines.map(l=>l.prePct||0);
                  const allSame=vals.length?vals.every(v=>v===vals[0]):true;
                  const targetText=allSame?`${vals[0]||0}%`:`${Math.min(...vals||[0])}%–${Math.max(...vals||[0])}%`;
                  const mismatch=allSame ? (Math.round(stagesSumPct*100)/100!==(vals[0]||0)) : true;
                  return <div className={`hint ${mismatch?'warn':''}`}>{t.sumStages}: {Math.round(stagesSumPct*100)/100}% · {t.targetPrepay}: {targetText} {mismatch? (allSame? ` ${t.mismatch}` : ` (${t.mixedTargets})`) : ''}</div>;
                })()}
              </div>

              <div className="hr"></div>

              {!isClient && (
                <div className="row">
                  <button className="btn ok" onClick={()=>share('editor')}>Поделиться (редактор)</button>
                  <button className="btn" onClick={()=>share('client')}>Поделиться (клиент)</button>
                </div>
              )}
              {isClient && <div className="row"><button className="btn" onClick={()=>share('client')}>Поделиться</button></div>}

              {(!isClient && tab==='catalog') && (
                <>
                  <h3 style={{margin:'6px 0'}}>{t.catalogTitle}</h3>
                  <div className="row">
                    <button className="btn ok" onClick={()=>setCatalogModalOpen(true)}>{t.addProject}</button>
                    <button className="btn" onClick={()=>{
                      const json=prompt('Paste catalog JSON:', JSON.stringify(catalog,null,2));
                      if(!json) return;
                      try{ const obj=JSON.parse(json); if(Array.isArray(obj)) setCatalog(obj); else alert('Invalid JSON'); }catch{ alert('Invalid JSON'); }
                    }}>{t.importJSON}</button>
                    <button className="btn" onClick={()=>{
                      const blob=new Blob([JSON.stringify(catalog,null,2)],{type:'application/json'});
                      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`arconique_catalog_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
                    }}>{t.exportJSON}</button>
                  </div>
                  <div className="scroll" style={{maxHeight:'32vh'}}>
                    {catalog.map(p=>(
                      <div key={p.projectId} className="catalog-card">
                        <div className="catalog-header">
                          <div className="row" style={{flex:1}}>
                            <span className="badge">{t.project}:</span>
                            <input 
                              type="text" 
                              value={p.projectName} 
                              onChange={e=>setCatalog(prev=>prev.map(x=>x.projectId===p.projectId?{...x,projectName:e.target.value}:x))}
                              style={{flex:1,marginRight:8}}
                            />
                            <span className="pill">{p.projectId}</span>
                          </div>
                          <div className="catalog-actions">
                            <button className="btn" onClick={()=>setCatalogModalOpen(true)}>{t.addVilla}</button>
                            <button className="btn warn" onClick={()=>{
                              if(confirm(t.remove + ' ' + p.projectName + '?')) {
                                setCatalog(prev=>prev.filter(x=>x.projectId!==p.projectId));
                              }
                            }}>{t.remove}</button>
                          </div>
                        </div>
                        
                        <table className="catalog-table">
                          <thead>
                            <tr>
                              <th style={{textAlign:'left'}}>{t.villa}</th>
                              <th>{t.area}</th>
                              <th>{t.ppsm}</th>
                              <th>{t.price}</th>
                              <th></th>
                            </tr>
                          </thead>
                          <tbody>
                            {p.villas.map(v=>(
                              <tr key={v.villaId}>
                                <td style={{textAlign:'left'}}>
                                  <input 
                                    value={v.name} 
                                    onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,name:e.target.value}:vv)}:pr))}
                                  />
                                  <div className="muted" style={{fontSize:10}}>{v.villaId}</div>
                                </td>
                                <td>
                                  <input 
                                    type="number" 
                                    min="1" 
                                    step="0.1" 
                                    value={v.area} 
                                    onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,area:clamp(parseFloat(e.target.value||0),1,100000)}:vv)}:pr))}
                                  />
                                </td>
                                <td>
                                  <input 
                                    type="number" 
                                    min="0" 
                                    step="1" 
                                    value={v.ppsm} 
                                    onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,ppsm:clamp(parseFloat(e.target.value||0),0,1e9)}:vv)}:pr))}
                                  />
                                </td>
                                <td>
                                  <input 
                                    type="number" 
                                    min="0" 
                                    step="1" 
                                    value={v.baseUSD} 
                                    onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,baseUSD:clamp(parseFloat(e.target.value||0),0,1e12)}:vv)}:pr))}
                                  />
                                </td>
                                <td>
                                  <button 
                                    className="btn warn icon" 
                                    onClick={()=>{
                                      if(confirm(t.remove + ' ' + v.name + '?')) {
                                        setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.filter(vv=>vv.villaId!==v.villaId)}:pr));
                                      }
                                    }}
                                  >
                                    ✕
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ))}
                  </div>
                </>
              )}
            </div>

            <div className="card">
              <div className="row" style={{justifyContent:'space-between',alignItems:'baseline'}}>
                <div className="row">
                  <span className="badge">{t.lines}: {lines.length}</span>
                  <span className="badge">{t.keys} {handoverMonth}</span>
                  {!isClient && <span className="badge">{t.months}: {months}</span>}
                </div>
                <div className="muted">{isClient ? t.client : t.editor}</div>
              </div>

              <KPIBlock isClient={isClient} t={t} totals={project.totals} currency={currency} toCurrency={toCurrency}/>

              <div className="hr"></div>

              <div className="row" style={{justifyContent:'space-between',alignItems:'center'}}>
                <h3 style={{margin:'6px 0'}}>{t.villasTitle}</h3>
                {!isClient && <button className="btn ok" onClick={()=>setModalOpen(true)}>{t.addFromCatalog}</button>}
              </div>

              <div className="calc-scroll">
                <table className="calc-table">
                  <thead>
                    <tr>
                      <th className="col-project">{t.project}</th>
                      <th className="col-villa">{t.villa}</th>
                      <th className="col-qty">{t.qty}</th>
                      <th className="col-area">{t.area}</th>
                      <th className="col-ppsm">{t.ppsm}</th>
                      <th className="col-base">{t.price}</th>
                      {!isClient && <th className="col-disc">{t.discount}</th>}
                      <th className="col-pre">{t.prePct}</th>
                      {!isClient && <th className="col-months">{t.months}</th>}
                      {!isClient && <th className="col-rate">{t.rate}</th>}
                      <th className="col-first">{t.firstPost}</th>
                      <th className="col-lineTotal">{t.lineTotal}</th>
                      <th className="col-actions"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {linesData.map(ld=>{
                      const projName=findProject(ld.line.projectId)?.projectName || ld.line.projectId;
                      const villaName=ld.line.snapshot?.name || ld.line.villaId;
                      return (
                        <tr key={ld.line.id}>
                          <td className="col-project" style={{textAlign:'left'}}>
                            <input 
                              disabled 
                              value={projName}
                              style={{width:'100%',minWidth:'80px'}}
                            />
                          </td>
                          <td className="col-villa" style={{textAlign:'left'}}>
                            <input 
                              disabled 
                              value={villaName}
                              style={{width:'100%',minWidth:'100px'}}
                            />
                          </td>
                          <td className="col-qty">
                            <input 
                              type="number" 
                              min="1" 
                              step="1" 
                              value={ld.line.qty} 
                              onChange={e=>updLine(ld.line.id,{qty:clamp(parseInt(e.target.value||0,10),1,9999)})}
                              style={{width:'100%',minWidth:'50px'}}
                            />
                          </td>
                          <td className="col-area">
                            <input 
                              type="number" 
                              value={ld.line.snapshot?.area||0} 
                              disabled
                              style={{width:'100%',minWidth:'50px'}}
                            />
                          </td>
                          <td className="col-ppsm">
                            <input 
                              type="number" 
                              value={ld.line.snapshot?.ppsm||0} 
                              disabled
                              style={{width:'100%',minWidth:'60px'}}
                            />
                          </td>
                          <td className="col-base base-strong">
                            {fmtMoney(toCurrency(ld.base),currency)}
                          </td>
                          {!isClient && (
                            <td className="col-disc">
                              <input 
                                type="number" 
                                min="0" 
                                max="20" 
                                step="0.1" 
                                value={ld.line.discountPct||0} 
                                onChange={e=>updLine(ld.line.id,{discountPct:clamp(parseFloat(e.target.value||0),0,20)})}
                                style={{width:'100%',minWidth:'50px'}}
                                                 />
                            </td>
                          )}
                          <td className="col-pre">
                            <input 
                              type="range" 
                              min="0" 
                              max="100" 
                              step="1" 
                              value={ld.line.prePct||0} 
                              onChange={e=>updLine(ld.line.id,{prePct:parseInt(e.target.value,10)})}
                              style={{width:'100%',minWidth:'80px'}}
                            />
                            <div className="pill">{ld.line.prePct||0}%</div>
                          </td>
                          {!isClient && (
                            <>
                              <td className="col-months">
                                <input 
                                  type="checkbox" 
                                  checked={ld.line.ownTerms||false} 
                                  onChange={e=>updLine(ld.line.id,{ownTerms:e.target.checked})}
                                />
                                <input 
                                  type="number" 
                                  min="6" 
                                  step="1" 
                                  value={ld.line.months||months} 
                                  onChange={e=>updLine(ld.line.id,{months:clamp(parseInt(e.target.value||0,10),6,120)})}
                                  disabled={!ld.line.ownTerms}
                                  style={{width:'100%',minWidth:'50px'}}
                                />
                              </td>
                              <td className="col-rate">
                                <input 
                                  type="number" 
                                  min="0" 
                                  step="0.01" 
                                  value={ld.line.monthlyRatePct||monthlyRatePct} 
                                  onChange={e=>updLine(ld.line.id,{monthlyRatePct:clamp(parseFloat(e.target.value||0),0,1000)})}
                                  disabled={!ld.line.ownTerms}
                                  style={{width:'100%',minWidth:'60px'}}
                                />
                              </td>
                            </>
                          )}
                          <td className="col-first">
                            <input 
                              type="number" 
                              min="0" 
                              step="1" 
                              value={ld.line.firstPostUSD||0} 
                              onChange={e=>updLine(ld.line.id,{firstPostUSD:clamp(parseFloat(e.target.value||0),0,ld.base)})}
                              style={{width:'100%',minWidth:'80px'}}
                            />
                          </td>
                          <td className="col-lineTotal line-total">
                            {fmtMoney(toCurrency(ld.lineTotal),currency)}
                          </td>
                          <td className="col-actions">
                            <div className="row" style={{gap:4}}>
                              <button className="btn icon" onClick={()=>dupLine(ld.line.id)}>📋</button>
                              {!isClient && <button className="btn warn icon" onClick={()=>delLine(ld.line.id)}>🗑️</button>}
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              <div className="hr"></div>

              <h3 style={{margin:'6px 0'}}>{t.cashflowTitle}</h3>
              <div className="row" style={{justifyContent:'space-between',alignItems:'center'}}>
                <div className="export-buttons">
                  <button className="btn" onClick={exportCSV}>{t.exportCSV}</button>
                  <button className="btn" onClick={exportXLSX}>{t.exportXLSX}</button>
                  <button className="btn" onClick={exportPDF}>{t.exportPDF}</button>
                </div>
              </div>

              <div className="scroll">
                <table>
                  <thead>
                    <tr>
                      <th>{t.cashMonth}</th>
                      <th style={{textAlign:'left'}}>{t.cashDesc}</th>
                      <th>{t.cashTotal}</th>
                      <th>{t.cashBalance}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {project.cashflow.map(c=>(
                      <tr key={c.month}>
                        <td>{c.month}</td>
                        <td style={{textAlign:'left'}}>{(c.items||[]).join(' + ')}</td>
                        <td>{fmtMoney(toCurrency(c.amountUSD),currency)}</td>
                        <td>{fmtMoney(toCurrency(c.balanceUSD),currency)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="hr"></div>

              <canvas ref={chartRef} style={{height:'200px',width:'100%'}}></canvas>
            </div>
          </div>

          {/* Модальное окно добавления из каталога */}
          {modalOpen && (
            <div className="modal-overlay" onClick={()=>setModalOpen(false)}>
              <div className="modal-content" onClick={e=>e.stopPropagation()}>
                <div className="modal-header">
                  <h3>{t.selectFromCatalog}</h3>
                  <button className="btn icon" onClick={()=>setModalOpen(false)}>✕</button>
                </div>
                
                <div className="modal-body">
                  <div className="search-filters">
                    <input 
                      type="text" 
                      placeholder={t.search} 
                      className="search-input"
                      onChange={e=>{
                        const query=e.target.value.toLowerCase();
                        const filtered=catalog.map(p=>({
                          ...p,
                          villas:p.villas.filter(v=>
                            p.projectName.toLowerCase().includes(query) ||
                            v.name.toLowerCase().includes(query) ||
                            v.villaId.toLowerCase().includes(query)
                          )
                        })).filter(p=>p.villas.length>0);
                        // Здесь можно добавить состояние для фильтрации
                      }}
                    />
                    
                    <div className="filter-row">
                      <div className="filter-group">
                        <label>{t.areaFrom}</label>
                        <input type="number" min="0" step="1" placeholder="0" />
                      </div>
                      <div className="filter-group">
                        <label>{t.areaTo}</label>
                        <input type="number" min="0" step="1" placeholder="1000" />
                      </div>
                    </div>
                    
                    <div className="filter-row">
                      <div className="filter-group">
                        <label>{t.priceFrom}</label>
                        <input type="number" min="0" step="1000" placeholder="0" />
                      </div>
                      <div className="filter-group">
                        <label>{t.priceTo}</label>
                        <input type="number" min="0" step="1000" placeholder="1000000" />
                      </div>
                    </div>
                    
                    <div className="filter-row">
                      <div className="filter-group">
                        <label>{t.sort}</label>
                        <select>
                          <option value="name">{t.byName}</option>
                          <option value="area">{t.byArea}</option>
                          <option value="price">{t.byPrice}</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div className="catalog-selection">
                    {catalog.map(p=>(
                      <div key={p.projectId} className="catalog-selection-project">
                        <h4>{p.projectName}</h4>
                        <div className="villas-selection">
                          {p.villas.map(v=>(
                            <div key={v.villaId} className="villa-selection-item">
                              <div className="villa-info">
                                <div className="villa-name">{v.name}</div>
                                <div className="villa-details">
                                  <span>{v.area} {t.area}</span>
                                  <span>{v.ppsm} {t.ppsm}</span>
                                  <span>{fmtMoney(v.baseUSD,'USD')}</span>
                                </div>
                              </div>
                              <button 
                                className="btn ok" 
                                onClick={()=>{
                                  const newLine={
                                    id:Date.now()+Math.random(),
                                    projectId:p.projectId,
                                    villaId:v.villaId,
                                    qty:1,
                                    prePct:stagesSumPct,
                                    ownTerms:false,
                                    months:null,
                                    monthlyRatePct:null,
                                    firstPostUSD:0,
                                    discountPct:0,
                                    snapshot:{name:v.name,area:v.area,ppsm:v.ppsm,baseUSD:v.baseUSD}
                                  };
                                  setLines(prev=>[...prev,newLine]);
                                  setModalOpen(false);
                                }}
                              >
                                {t.addSelected}
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Модальное окно добавления проекта/виллы */}
          {catalogModalOpen && (
            <div className="modal-overlay" onClick={()=>setCatalogModalOpen(false)}>
              <div className="modal-content" onClick={e=>e.stopPropagation()}>
                <div className="modal-header">
                  <h3>{t.addProject}</h3>
                  <button className="btn icon" onClick={()=>setCatalogModalOpen(false)}>✕</button>
                </div>
                
                <div className="modal-body">
                  <div className="form-section">
                    <h4>{t.addProject}</h4>
                    <div className="form-row">
                      <div className="form-group">
                        <label>{t.projectId}</label>
                        <input 
                          type="text" 
                          placeholder="project-id"
                          onChange={e=>{
                            // Здесь можно добавить состояние для нового проекта
                          }}
                        />
                      </div>
                      <div className="form-group">
                        <label>{t.projectName}</label>
                        <input 
                          type="text" 
                          placeholder={t.projectName}
                          onChange={e=>{
                            // Здесь можно добавить состояние для нового проекта
                          }}
                        />
                      </div>
                    </div>
                  </div>
                  
                  <div className="form-section">
                    <h4>{t.addVilla}</h4>
                    <div className="form-row">
                      <div className="form-group">
                        <label>{t.villaId}</label>
                        <input 
                          type="text" 
                          placeholder="villa-id"
                          onChange={e=>{
                            // Здесь можно добавить состояние для новой виллы
                          }}
                        />
                      </div>
                      <div className="form-group">
                        <label>{t.villaName}</label>
                        <input 
                          type="text" 
                          placeholder={t.villaName}
                          onChange={e=>{
                            // Здесь можно добавить состояние для новой виллы
                          }}
                        />
                      </div>
                    </div>
                    
                    <div className="form-row">
                      <div className="form-group">
                        <label>{t.villaArea}</label>
                        <input 
                          type="number" 
                          min="1" 
                          step="0.1" 
                          placeholder="100"
                          onChange={e=>{
                            // Здесь можно добавить состояние для новой виллы
                          }}
                        />
                      </div>
                      <div className="form-group">
                        <label>{t.villaPpsm}</label>
                        <input 
                          type="number" 
                          min="0" 
                          step="1" 
                          placeholder="2500"
                          onChange={e=>{
                            // Здесь можно добавить состояние для новой виллы
                          }}
                        />
                      </div>
                    </div>
                    
                    <div className="form-row">
                      <div className="form-group">
                        <label>{t.villaBasePrice}</label>
                        <input 
                          type="number" 
                          min="0" 
                          step="1000" 
                          placeholder="250000"
                          onChange={e=>{
                            // Здесь можно добавить состояние для новой виллы
                          }}
                        />
                      </div>
                    </div>
                  </div>
                  
                  <div className="form-actions">
                    <button className="btn" onClick={()=>setCatalogModalOpen(false)}>{t.cancel}</button>
                    <button className="btn ok" onClick={()=>{
                      // Здесь можно добавить логику сохранения
                      setCatalogModalOpen(false);
                    }}>{t.save}</button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </>
      );
    }

    /* ---------- KPI Block Component ---------- */
    function KPIBlock({isClient, t, totals, currency, toCurrency}){
      return (
        <div className="kpis">
          <div className="kpi">
            <div className="muted">{t.base}</div>
            <div className="v">{fmtMoney(toCurrency(totals.baseUSD),currency)}</div>
          </div>
          <div className="kpi">
            <div className="muted">{t.prepay}</div>
            <div className="v">{fmtMoney(toCurrency(totals.preUSD),currency)}</div>
          </div>
          <div className="kpi">
            <div className="muted">{t.after}</div>
            <div className="v">{fmtMoney(toCurrency(totals.afterUSD),currency)}</div>
          </div>
          {!isClient && (
            <div className="kpi">
              <div className="muted">{t.interestTotal}</div>
              <div className="v">{fmtMoney(toCurrency(totals.interestUSD),currency)}</div>
            </div>
          )}
          <div className="kpi">
            <div className="muted">{t.final}</div>
            <div className="v">{fmtMoney(toCurrency(totals.finalUSD),currency)}</div>
          </div>
        </div>
      );
    }

    /* ---------- Render ---------- */
    ReactDOM.render(<App/>,document.getElementById('root'));
  </script>
</body>
</html>

                              
