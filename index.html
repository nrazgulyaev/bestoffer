<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Installments • Editor / Client (v7)</title>
  <style>
    *{box-sizing:border-box}
    :root{--bg:#0b0d12;--card:#0f1420;--line:#1c2233;--muted:#9fb0d0;--ink:#e7ebf3}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 12px;font-size:22px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .col-4{grid-column:span 4}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{display:grid;gap:6px;margin-bottom:10px}
    label{color:var(--muted);font-size:13px}
    input[type="text"],input[type="number"],input[type="range"],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #26304a;background:#111828;color:var(--ink)}
    input[type="range"]{padding:0;height:32px}
    .pill{padding:6px 10px;border-radius:999px;background:#10192a;border:1px solid #22304a;font-size:12px}
    .badge{background:#132039;border:1px solid #243353;padding:4px 8px;border-radius:999px;font-size:12px}
    .muted{color:#9fb0d0}
    .hr{height:1px;background:#1c2233;border:0;margin:10px 0}
    .btn{appearance:none;border:1px solid #2a3756;background:#132039;color:#dfe7ff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.warn{background:#2a1420;border-color:#513042;color:#ffd8de}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;border-bottom:1px solid #202a42;text-align:right;font-variant-numeric:tabular-nums}
    th:first-child,td:first-child{text-align:left}
    .scroll{overflow:auto;max-height:50vh}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:10px 0}
    .kpi{background:#0f1420;border:1px solid #1c2233;border-radius:10px;padding:10px 12px}
    .kpi .v{font-size:18px;font-weight:700}
    .banner{background:#12233e;border:1px dashed #2b4d86;padding:8px 12px;border-radius:10px;color:#bcd3ff;margin-bottom:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="app-title">Калькулятор рассрочки • Editor / Client (v7)</h1>
    <div id="root"></div>
  </div>

  <!-- libs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script type="text/babel">
    const {useEffect,useMemo,useRef,useState} = React;

    // i18n
    const T = {
      ru: {
        title: 'Калькулятор рассрочки • Editor / Client (v7)',
        editor: 'Редактор',
        client: 'Клиент',
        lang: 'Язык интерфейса',
        currencyDisplay: 'Валюта отображения',
        idrRate: 'IDR за 1 USD',
        eurRate: 'EUR за 1 USD',
        handoverMonth: 'Месяц получения ключей',
        globalTerm: 'Глобальный срок post‑handover (6–24 мес)',
        globalRate: 'Глобальная ставка, %/мес',
        clientTerm: 'Срок post‑handover (мес)',
        rateHidden: 'Ставка (скрыта)',
        stagesTitle: 'Этапы ДО ключей',
        stage: 'Этап',
        percent: '%',
        month: 'Месяц',
        addStage: 'Добавить этап',
        shareEditor: 'Поделиться (редактор)',
        shareClient: 'Поделиться (клиенту)',
        banner: 'Клиентский режим: ставка и сумма процентов скрыты. Можно менять: цену, % «до ключей», первый платёж после ключей и этапы.',
        villasTitle: 'Список вилл',
        name: 'Название',
        area: 'м²',
        ppsm: '$ / м²',
        price: 'Цена (USD)',
        prePct: 'До ключей, %',
        ownPost: 'СВОИ post‑условия',
        months: 'Срок, мес',
        rate: 'Ставка, %/мес',
        firstPost: 'Первый платёж после ключей',
        delete: 'Удалить',
        addVilla: 'Добавить виллу',
        cashflowTitle: 'Сводный кэшфлоу по месяцам',
        cashMonth: 'Месяц',
        cashDesc: 'Описание',
        cashTotal: 'Сумма (в выбранной валюте)',
        totals: 'Итоги',
        base: 'База',
        prepay: 'Оплата до ключей',
        after: 'Остаток после ключей',
        interestTotal: 'Проценты (post)',
        final: 'Итоговая цена',
        projects: 'Вилл',
        keys: 'Ключи: мес.',
        chartTitle: 'Платежи по месяцам',
        shareCopied: 'Ссылка скопирована',
      },
      en: {
        title: 'Installments Calculator • Editor / Client (v7)',
        editor: 'Editor',
        client: 'Client',
        lang: 'Language',
        currencyDisplay: 'Display currency',
        idrRate: 'IDR per 1 USD',
        eurRate: 'EUR per 1 USD',
        handoverMonth: 'Handover month',
        globalTerm: 'Global post‑handover term (6–24 mo)',
        globalRate: 'Global rate, %/month',
        clientTerm: 'Post‑handover term (months)',
        rateHidden: 'Rate (hidden)',
        stagesTitle: 'Pre‑handover stages',
        stage: 'Stage',
        percent: '%',
        month: 'Month',
        addStage: 'Add stage',
        shareEditor: 'Share (editor)',
        shareClient: 'Share (client)',
        banner: 'Client view: rate and interest are hidden. You can change price, pre‑handover %, first post‑handover payment and stages.',
        villasTitle: 'Villas',
        name: 'Name',
        area: 'sqm',
        ppsm: '$ / sqm',
        price: 'Price (USD)',
        prePct: 'Pre‑handover, %',
        ownPost: 'Own post‑terms',
        months: 'Term, mo',
        rate: 'Rate, %/mo',
        firstPost: 'First payment after handover',
        delete: 'Delete',
        addVilla: 'Add villa',
        cashflowTitle: 'Monthly consolidated cashflow',
        cashMonth: 'Month',
        cashDesc: 'Description',
        cashTotal: 'Amount (display currency)',
        totals: 'Totals',
        base: 'Base',
        prepay: 'Paid before keys',
        after: 'Balance after keys',
        interestTotal: 'Interest (post)',
        final: 'Final price',
        projects: 'Villas',
        keys: 'Keys: mo.',
        chartTitle: 'Payments by month',
        shareCopied: 'Link copied',
      }
    };

    const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
    const fmtMoney = (n, currency='USD') => new Intl.NumberFormat('en-US',{style:'currency',currency,maximumFractionDigits:2}).format(n ?? 0);

    // URL hash helpers: #s=<base64>&view=client
    const readHashParams = () => {
      const h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
      const sp = new URLSearchParams(h);
      return { s: sp.get('s'), view: sp.get('view') };
    };
    const encodeStateToUrl = (state, {view}={}) => {
      try{
        const s = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
        const url = new URL(location.href);
        const sp = new URLSearchParams();
        sp.set('s', s);
        if(view) sp.set('view', view);
        url.hash = sp.toString();
        return url.toString();
      }catch{ return ''; }
    };
    const decodeStateFromUrl = () => {
      try{
        const {s, view} = readHashParams();
        if(!s) return null;
        const obj = JSON.parse(decodeURIComponent(escape(atob(s))));
        return { state: obj, view };
      }catch{ return null; }
    };

    function App(){
      // language
      const [lang,setLang] = useState('ru');
      const t = T[lang];

      // client/editor flag
      const [isClient,setIsClient] = useState(false);

      // currency (both modes can change display currency; rates editable only in editor)
      const [currency,setCurrency] = useState('USD');
      const [idrPerUsd,setIdrPerUsd] = useState(16500);
      const [eurPerUsd,setEurPerUsd] = useState(0.92);
      const toCurrency = usd => currency==='USD' ? usd : currency==='IDR' ? usd*idrPerUsd : usd*eurPerUsd;

      // global terms
      const [handoverMonth,setHandoverMonth] = useState(12);
      const [months,setMonths] = useState(12);
      const [monthlyRatePct,setMonthlyRatePct] = useState(8.33);

      // stages (global)
      const [stages,setStages] = useState([
        {id:1,label:'Договор', pct:30, month:0},
        {id:2,label:'50% готовности', pct:30, month:6},
        {id:3,label:'70% готовности', pct:20, month:9},
        {id:4,label:'90% готовности', pct:15, month:11},
        {id:5,label:'Ключи', pct:5, month:12},
      ]);

      // villas
      const [villas,setVillas] = useState([
        {id:1,name:'Enso 2BR', area:100, ppsm:2500, override:false, base:250000, prePct:70,
         ownTerms:false, months:null, monthlyRatePct:null, firstPostUSD:0},
      ]);

      // restore / persist
      useEffect(()=>{
        const fromUrl = decodeStateFromUrl();
        const saved = fromUrl?.state || JSON.parse(localStorage.getItem('installments_v7')||'null');
        if(saved){
          try{
            if(saved.lang) setLang(saved.lang);
            if(saved.currency) setCurrency(saved.currency);
            if(typeof saved.idrPerUsd==='number') setIdrPerUsd(saved.idrPerUsd);
            if(typeof saved.eurPerUsd==='number') setEurPerUsd(saved.eurPerUsd);
            if(typeof saved.handoverMonth==='number') setHandoverMonth(saved.handoverMonth);
            if(typeof saved.months==='number') setMonths(saved.months);
            if(typeof saved.monthlyRatePct==='number') setMonthlyRatePct(saved.monthlyRatePct);
            if(Array.isArray(saved.stages)) setStages(saved.stages);
            if(Array.isArray(saved.villas)) setVillas(saved.villas.map(v=>({firstPostUSD:0, ...v})));
          }catch{}
        }
        if(fromUrl?.view === 'client') setIsClient(true);
      },[]);
      useEffect(()=>{
        const state = {lang,currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,villas};
        localStorage.setItem('installments_v7', JSON.stringify(state));
        // update meta titles
        document.getElementById('app-title').textContent = t.title;
        document.title = t.title;
      },[lang,currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,villas]);

      // ------- calculations per-villa -------
      const stagesSumPct = useMemo(()=> stages.reduce((s,x)=>s+(+x.pct||0),0), [stages]);

      const villasData = useMemo(()=>{
        return villas.map(v=>{
          const baseComputed = v.area * v.ppsm;
          const base = v.override ? (v.base||0) : baseComputed;

          // pre-handover: distribute by global stages scaled to v.prePct
          const k = stagesSumPct===0 ? 0 : (v.prePct||0)/stagesSumPct;
          const preSchedule = stages.map(s=>({
            month: Math.max(0, Math.min(handoverMonth, Math.round(+s.month||0))),
            label: s.label,
            amountUSD: base * (((+s.pct||0)*k)/100),
          })).filter(r=>r.amountUSD>0).sort((a,b)=>a.month-b.month);
          const preTotal = preSchedule.reduce((s,r)=>s+r.amountUSD,0);

          // post-handover: first immediate payment then equal principal + monthly interest
          const vMonths = v.ownTerms && v.months ? v.months : months;
          const rate = (v.ownTerms && v.monthlyRatePct!=null) ? (v.monthlyRatePct/100) : (monthlyRatePct/100);

          // balance after keys BEFORE interest: base - preTotal - firstPost
          const firstPostUSD = Math.max(0, +v.firstPostUSD||0);
          const principalBase = Math.max(0, base - preTotal - firstPostUSD);

          const postRows=[];
          let bal = principalBase, totalInterest=0;
          const principalShare = vMonths>0 ? principalBase / vMonths : 0;
          for(let i=1;i<=vMonths;i++){
            const interest = bal * rate;
            totalInterest += interest;
            const payment = principalShare + interest;
            postRows.push({
              month: handoverMonth + i,
              label: (lang==='ru'?'Месяц ':'Month ')+i,
              principalUSD: principalShare,
              interestUSD: interest,
              paymentUSD: payment,
              balanceAfterUSD: Math.max(0, bal - principalShare),
            });
            bal -= principalShare;
          }

          const finalPrice = base + totalInterest; // === что увидит клиент как «итог»
          return { v, base, preSchedule, preTotal, firstPostUSD, postRows, totalInterest, finalPrice, principalBase };
        });
      },[villas, stages, stagesSumPct, handoverMonth, months, monthlyRatePct, lang]);

      // ------- project-level aggregates & cashflow -------
      const project = useMemo(()=>{
        const totals = {
          baseUSD: villasData.reduce((s,x)=>s+x.base,0),
          preUSD: villasData.reduce((s,x)=>s+x.preTotal,0),
          interestUSD: villasData.reduce((s,x)=>s+x.totalInterest,0),
          finalUSD: villasData.reduce((s,x)=>s+x.finalPrice,0),
        };
        // Остаток после ключей = Итоговая цена − Оплата до ключей
        totals.afterUSD = totals.finalUSD - totals.preUSD;

        // Consolidated cashflow per month (includes: pre stages, first post payment, and post schedule)
        const m = new Map();
        const push = (month, amt, desc) => {
          if(amt<=0) return;
          const prev = m.get(month) || {month, items:[], amountUSD:0};
          prev.items.push(desc);
          prev.amountUSD += amt;
          m.set(month, prev);
        };
        villasData.forEach(vc=>{
          vc.preSchedule.forEach(r=> push(r.month, r.amountUSD, `${vc.v.name}: ${r.label}`));
          if(vc.firstPostUSD>0) push(handoverMonth+1, vc.firstPostUSD, `${vc.v.name}: ${lang==='ru'?'Первый платёж':'First payment'}`);
          vc.postRows.forEach(r=> push(r.month, r.paymentUSD, `${vc.v.name}: ${r.label}`));
        });
        const cashflow = Array.from(m.values()).sort((a,b)=>a.month-b.month);
        return { totals, cashflow };
      },[villasData, handoverMonth, lang]);

      // ------- chart -------
      const chartRef = useRef(null);
      const chartObj = useRef(null);
      useEffect(()=>{
        const ctx = chartRef.current?.getContext('2d');
        if(!ctx) return;
        const labels = project.cashflow.map(c=>String(c.month));
        const data = project.cashflow.map(c=> toCurrency(c.amountUSD));
        if(chartObj.current){ chartObj.current.destroy(); }
        chartObj.current = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [{ label: (T[lang].chartTitle), data }] },
          options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: { callbacks: {
              label: (ctx)=> fmtMoney(ctx.parsed.y, currency)
            }}},
            scales: {
              y: { ticks: { callback: v => fmtMoney(v, currency) } }
            }
          }
        });
      },[project.cashflow, currency, idrPerUsd, eurPerUsd, lang]);

      // ------- actions -------
      const updateVilla = (id, patch)=> setVillas(prev=> prev.map(v=> v.id===id? {...v, ...patch}: v));
      const addVilla = ()=> setVillas(prev=>{
        const last = prev[prev.length-1];
        const id = (last?.id || 0) + 1;
        return [...prev, {id,name: (lang==='ru'?'Новая вилла':'New villa'), area:last?last.area:100, ppsm:last?last.ppsm:2500, override:false, base:last?last.base:250000, prePct:last?last.prePct:70, ownTerms:false, months:null, monthlyRatePct:null, firstPostUSD:0}];
      });
      const removeVilla = (id)=> setVillas(prev=> prev.filter(v=> v.id!==id));

      const shareEditor = async ()=>{
        const state = {lang,currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,villas};
        const url = encodeStateToUrl(state, {view:null});
        if(url){ await navigator.clipboard.writeText(url); alert(t.shareCopied); }
      };
      const shareClient = async ()=>{
        const state = {lang,currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,villas};
        const url = encodeStateToUrl(state, {view:'client'});
        if(url){ await navigator.clipboard.writeText(url); alert(t.shareCopied); }
      };

      // ------- UI -------
      return (
        <div className="grid">
          <div className="card col-4">
            {isClient && <div className="banner">{t.banner}</div>}

            {/* Language */}
            <div className="field">
              <label>{t.lang}</label>
              <select value={lang} onChange={e=>setLang(e.target.value)}>
                <option value="ru">Русский</option>
                <option value="en">English</option>
              </select>
            </div>

            {/* Currency (both modes), rates only in editor */}
            <div className="field">
              <label>{t.currencyDisplay}</label>
              <select value={currency} onChange={e=>setCurrency(e.target.value)}>
                <option>USD</option><option>IDR</option><option>EUR</option>
              </select>
            </div>
            {!isClient && (
              <div className="row">
                <div className="field" style={{flex:1}}>
                  <label>{t.idrRate}</label>
                  <input type="number" min="1" step="1" value={idrPerUsd} onChange={e=>setIdrPerUsd(clamp(parseFloat(e.target.value||0),1,1e9))}/>
                </div>
                <div className="field" style={{flex:1}}>
                  <label>{t.eurRate}</label>
                  <input type="number" min="0.01" step="0.01" value={eurPerUsd} onChange={e=>setEurPerUsd(clamp(parseFloat(e.target.value||0),0.01,100))}/>
                </div>
              </div>
            )}

            <div className="row">
              <div className="field" style={{flex:1}}>
                <label>{t.handoverMonth}</label>
                <input type="number" min="1" step="1" value={handoverMonth} onChange={e=>setHandoverMonth(clamp(parseInt(e.target.value||0,10),1,120))}/>
              </div>

              {!isClient ? (
                <>
                  <div className="field" style={{flex:1}}>
                    <label>{t.globalTerm}</label>
                    <input type="range" min="6" max="24" step="1" value={months} onChange={e=>setMonths(parseInt(e.target.value,10))}/>
                    <div className="pill">{t.months}: {months}</div>
                  </div>
                  <div className="field" style={{flex:1}}>
                    <label>{t.globalRate}</label>
                    <input type="number" min="0" step="0.01" value={monthlyRatePct} onChange={e=>setMonthlyRatePct(clamp(parseFloat(e.target.value||0),0,1000))}/>
                  </div>
                </>
              ) : (
                <>
                  <div className="field" style={{flex:1}}>
                    <label>{t.clientTerm}</label>
                    <input type="number" min="6" step="1" value={months} onChange={e=>setMonths(clamp(parseInt(e.target.value||0,10),6,120))}/>
                  </div>
                  <div className="field" style={{flex:1}}>
                    <label>{t.rateHidden}</label>
                    <input type="text" value={lang==='ru'?'скрыто':'hidden'} disabled />
                  </div>
                </>
              )}
            </div>

            <div className="hr"></div>

            {/* Stages (editable in both modes) */}
            <h3 style={{margin:'6px 0'}}>{t.stagesTitle}</h3>
            <div className="scroll" style={{maxHeight:'26vh',border:'1px dashed #223',borderRadius:'8px',padding:'6px'}}>
              <table>
                <thead><tr><th>{t.stage}</th><th>{t.percent}</th><th>{t.month}</th><th></th></tr></thead>
                <tbody>
                  {stages.map(s=>(
                    <tr key={s.id}>
                      <td style={{textAlign:'left'}}><input type="text" value={s.label} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,label:e.target.value}:x))}/></td>
                      <td><input type="number" min="0" step="0.01" value={s.pct} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,pct:clamp(parseFloat(e.target.value||0),0,100)}:x))}/></td>
                      <td><input type="number" min="0" step="1" value={s.month} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,month:clamp(parseInt(e.target.value||0,10),0,handoverMonth)}:x))}/></td>
                      <td><button className="btn warn" onClick={()=>setStages(prev=>prev.filter(x=>x.id!==s.id))}>{t.delete}</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="row" style={{marginTop:8}}>
              <button className="btn" onClick={()=>{
                setStages(prev=>{
                  const last = prev[prev.length-1];
                  const id = (last?.id||0)+1;
                  const nextMonth = Math.min(handoverMonth, (last?.month ?? 0)+1);
                  return [...prev,{id,label:(lang==='ru'?'Этап':'Stage'),pct:5,month:nextMonth}];
                })
              }}>{t.addStage}</button>
            </div>

            <div className="hr"></div>

            {/* Share (editor only; в клиенте скрыто полностью) */}
            {!isClient && (
              <div className="row">
                <button className="btn" onClick={shareEditor}>{t.shareEditor}</button>
                <button className="btn" onClick={shareClient}>{t.shareClient}</button>
              </div>
            )}
          </div>

          <div className="card col-8">
            <div className="row" style={{justifyContent:'space-between',alignItems:'baseline'}}>
              <div className="row">
                <span className="badge">{t.projects}: {villas.length}</span>
                <span className="badge">{t.keys} {handoverMonth}</span>
                {!isClient && <span className="badge">{t.globalRate.replace(', %/мес','').replace(', %/month','')}: {monthlyRatePct}%</span>}
                {!isClient && <span className="badge">{t.months}: {months}</span>}
              </div>
              <div className="muted">{isClient ? t.client : t.editor}</div>
            </div>

            {/* KPIs — after = final − prepay */}
            {isClient ? (
              <div className="kpis" style={{gridTemplateColumns:'repeat(3,1fr)'}}>
                <KPI label={t.final} value={fmtMoney(toCurrency(project.totals.finalUSD), currency)}/>
                <KPI label={t.prepay} value={fmtMoney(toCurrency(project.totals.preUSD), currency)}/>
                <KPI label={t.after} value={fmtMoney(toCurrency(project.totals.afterUSD), currency)}/>
              </div>
            ) : (
              <div className="kpis">
                <KPI label={t.base} value={fmtMoney(toCurrency(project.totals.baseUSD), currency)}/>
                <KPI label={t.prepay} value={fmtMoney(toCurrency(project.totals.preUSD), currency)}/>
                <KPI label={t.after} value={fmtMoney(toCurrency(project.totals.afterUSD), currency)}/>
                <KPI label={t.interestTotal} value={fmtMoney(toCurrency(project.totals.interestUSD), currency)}/>
                <KPI label={t.final} value={fmtMoney(toCurrency(project.totals.finalUSD), currency)}/>
              </div>
            )}

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>{t.villasTitle}</h3>
            <div className="scroll" style={{maxHeight:'34vh'}}>
              <table>
                <thead>
                  <tr>
                    <th>{t.name}</th><th>{t.area}</th><th>{t.ppsm}</th><th>{t.price}</th><th>{t.prePct}</th>
                    {!isClient && <th>{t.ownPost}</th>}
                    {!isClient && <th>{t.months}</th>}
                    {!isClient && <th>{t.rate}</th>}
                    <th>{t.firstPost}</th>
                    <th>{t.delete}</th>
                  </tr>
                </thead>
                <tbody>
                  {villasData.map(vc=>(
                    <tr key={vc.v.id}>
                      <td style={{textAlign:'left'}}>
                        <input type="text" value={vc.v.name} onChange={e=>updateVilla(vc.v.id,{name:e.target.value})}/>
                      </td>
                      <td><input type="number" min="1" step="0.1" value={vc.v.area} onChange={e=>updateVilla(vc.v.id,{area:clamp(parseFloat(e.target.value||0),1,100000), ...(isClient?{override:false}:{})})}/></td>
                      <td><input type="number" min="0" step="1" value={vc.v.ppsm} onChange={e=>updateVilla(vc.v.id,{ppsm:clamp(parseFloat(e.target.value||0),0,1e9), ...(isClient?{override:false}:{})})}/></td>
                      <td>
                        <label className="pill" style={{display:'inline-flex',gap:6,alignItems:'center',margin-bottom:6px}}>
                          <input type="checkbox" checked={vc.v.override} onChange={e=>updateVilla(vc.v.id,{override:e.target.checked})}/>
                          {lang==='ru'?'вручную':'manual'}
                        </label>
                        <input type="number" min="0" step="1" value={vc.v.override ? vc.v.base : Math.round(vc.v.area*vc.v.ppsm)} onChange={e=>updateVilla(vc.v.id,{base:clamp(parseFloat(e.target.value||0),0,1e12), override:true})}/>
                      </td>
                      <td>
                        <input type="range" min="0" max="100" step="1" value={vc.v.prePct} onChange={e=>updateVilla(vc.v.id,{prePct:parseInt(e.target.value,10)})}/>
                        <div className="pill" style={{display:'inline-block',margin-top:6px}}>{vc.v.prePct}%</div>
                      </td>

                      {!isClient && (
                        <>
                          <td>
                            <label className="pill" style={{display:'inline-flex',gap:6,alignItems:'center'}}>
                              <input type="checkbox" checked={vc.v.ownTerms} onChange={e=>updateVilla(vc.v.id,{ownTerms:e.target.checked})}/>
                              {lang==='ru'?'включить':'enable'}
                            </label>
                          </td>
                          <td>
                            <input type="number" min="6" step="1" value={vc.v.ownTerms ? (vc.v.months??months) : months}
                              onChange={e=>updateVilla(vc.v.id,{months:clamp(parseInt(e.target.value||0,10),6,120)})} disabled={!vc.v.ownTerms}/>
                          </td>
                          <td>
                            <input type="number" min="0" step="0.01" value={vc.v.ownTerms ? (vc.v.monthlyRatePct??monthlyRatePct) : monthlyRatePct}
                              onChange={e=>updateVilla(vc.v.id,{monthlyRatePct:clamp(parseFloat(e.target.value||0),0,1000)})} disabled={!vc.v.ownTerms}/>
                          </td>
                        </>
                      )}

                      <td>
                        <input type="number" min="0" step="1" value={vc.v.firstPostUSD} onChange={e=>updateVilla(vc.v.id,{firstPostUSD:clamp(parseFloat(e.target.value||0),0,1e12)})}/>
                      </td>
                      <td><button className="btn warn" onClick={()=>removeVilla(vc.v.id)}>{t.delete}</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {!isClient && (
              <div className="row" style={{marginTop:8}}>
                <button className="btn" onClick={addVilla}>{t.addVilla}</button>
              </div>
            )}

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>{t.cashflowTitle}</h3>
            <div className="scroll">
              <table>
                <thead>
                  <tr>
                    <th>{t.cashMonth}</th><th>{t.cashDesc}</th><th>{t.cashTotal}</th>
                  </tr>
                </thead>
                <tbody>
                  {project.cashflow.map(c=>(
                    <tr key={c.month}>
                      <td>{c.month}</td>
                      <td style={{textAlign:'left'}}>{(c.items||[]).join(' + ')}</td>
                      <td>{fmtMoney(toCurrency(c.amountUSD), currency)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>{t.chartTitle}</h3>
            <canvas id="paymentsChart" height="200" ref={chartRef}></canvas>

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>{t.totals}</h3>
            <div className="kpis" style={{gridTemplateColumns: isClient ? 'repeat(3,1fr)' : 'repeat(5,1fr)'}}>
              {!isClient && <KPI label={t.base} value={fmtMoney(toCurrency(project.totals.baseUSD), currency)}/>}
              <KPI label={t.prepay} value={fmtMoney(toCurrency(project.totals.preUSD), currency)}/>
              <KPI label={t.after} value={fmtMoney(toCurrency(project.totals.afterUSD), currency)}/>
              {!isClient && <KPI label={t.interestTotal} value={fmtMoney(toCurrency(project.totals.interestUSD), currency)}/>}
              <KPI label={t.final} value={fmtMoney(toCurrency(project.totals.finalUSD), currency)}/>
            </div>
          </div>
        </div>
      );
    }

    function KPI({label,value}) {
      return (
        <div className="kpi">
          <div className="muted">{label}</div>
          <div className="v">{value}</div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
