<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arconique / Калькулятор рассрочки для любимых клиентов — v7.6</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    *{box-sizing:border-box}
    
    :root{
      /* Современная цветовая палитра */
      --bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      --card: rgba(255,255,255,0.05);
      --card-hover: rgba(255,255,255,0.08);
      --line: rgba(255,255,255,0.1);
      --muted: #94a3b8;
      --ink: #f1f5f9;
      --warn: #ef4444;
      --ok: #10b981;
      --strong: #3b82f6;
      --good: #059669;
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      
      /* Тени и эффекты */
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      
      /* Скругления */
      --radius-sm: 8px;
      --radius: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      
      /* Брейкпоинты */
      --mobile: 480px;
      --tablet: 768px;
      --laptop: 1024px;
      --desktop: 1200px;
    }
    
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      min-height:100vh;
      line-height:1.6;
    }
    
    .wrap{
      max-width:1400px;
      margin:16px auto;
      padding:0 16px;
    }
    
    @media (min-width: 768px) {
      .wrap {
        margin: 32px auto;
        padding: 0 24px;
      }
    }
    
    h1{
      margin:0 0 20px;
      font-size:20px;
      font-weight:700;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      text-align:center;
    }
    
    @media (min-width: 768px) {
      h1 {
        font-size: 28px;
        margin-bottom: 24px;
      }
    }
    
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
    }
    
    @media (min-width: 1024px) {
      .grid {
        grid-template-columns: 450px 1fr;
        gap: 24px;
      }
    }
    
    .card{
      background:var(--card);
      backdrop-filter:blur(20px);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:16px;
      transition:all 0.3s ease;
      box-shadow:var(--shadow-lg);
    }
    
    @media (min-width: 768px) {
      .card {
        padding: 24px;
      }
    }
    
    .card:hover{
      background:var(--card-hover);
      transform:translateY(-2px);
      box-shadow:var(--shadow-xl);
    }
    
    .row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    
    @media (min-width: 768px) {
      .row {
        gap: 16px;
      }
    }
    
    .field{
      display:grid;
      gap:8px;
      margin-bottom:16px;
      width:100%;
    }
    
    @media (min-width: 768px) {
      .field {
        margin-bottom: 20px;
      }
    }
    
    label{
      color:var(--muted);
      font-size:13px;
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    @media (min-width: 768px) {
      label {
        font-size: 14px;
      }
    }
    
    input[type="text"],input[type="number"],input[type="range"],select,textarea{
      width:100%;
      padding:12px 14px;
      border-radius:var(--radius);
      border:2px solid transparent;
      background:rgba(255,255,255,0.05);
      color:var(--ink);
      font-size:14px;
      transition:all 0.3s ease;
      backdrop-filter:blur(10px);
    }
    
    @media (min-width: 768px) {
      input[type="text"],input[type="number"],input[type="range"],select,textarea {
        padding: 14px 16px;
      }
    }
    
    input[type="text"]:focus,input[type="number"]:focus,select:focus,textarea:focus{
      outline:none;
      border-color:var(--accent);
      background:rgba(255,255,255,0.08);
      box-shadow:0 0 0 4px rgba(139,92,246,0.1);
    }
    
    input[type="range"]{
      padding:0;
      height:6px;
      background:rgba(255,255,255,0.1);
      border-radius:3px;
      outline:none;
    }
    
    input[type="range"]::-webkit-slider-thumb{
      appearance:none;
      width:20px;
      height:20px;
      background:var(--accent);
      border-radius:50%;
      cursor:pointer;
      box-shadow:var(--shadow);
      transition:all 0.3s ease;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover{
      transform:scale(1.2);
      box-shadow:var(--shadow-lg);
    }
    
    .pill{
      padding:6px 12px;
      border-radius:999px;
      background:rgba(139,92,246,0.1);
      border:1px solid rgba(139,92,246,0.2);
      font-size:11px;
      font-weight:600;
      color:var(--accent-light);
      text-align:center;
    }
    
    @media (min-width: 768px) {
      .pill {
        padding: 8px 16px;
        font-size: 12px;
      }
    }
    
    .badge{
      background:rgba(59,130,246,0.1);
      border:1px solid rgba(59,130,246,0.2);
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      color:var(--strong);
    }
    
    @media (min-width: 768px) {
      .badge {
        padding: 6px 12px;
        font-size: 12px;
      }
    }
    
    .muted{color:var(--muted)}
    
    .hr{
      height:1px;
      background:linear-gradient(90deg, transparent, var(--line), transparent);
      border:0;
      margin:16px 0;
    }
    
    @media (min-width: 768px) {
      .hr {
        margin: 24px 0;
      }
    }
    
    .btn{
      appearance:none;
      border:none;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white;
      padding:10px 18px;
      border-radius:var(--radius);
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition:all 0.3s ease;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      white-space:nowrap;
    }
    
    @media (min-width: 768px) {
      .btn {
        padding: 12px 24px;
        font-size: 14px;
      }
    }
    
    .btn::before{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition:left 0.5s ease;
    }
    
    .btn:hover::before{
      left:100%;
    }
    
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow-lg);
    }
    
    .btn.warn{
      background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .btn.ok{
      background:linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .btn.icon{
      padding:8px;
      border-radius:var(--radius-sm);
      min-width:36px;
    }
    
    @media (min-width: 768px) {
      .btn.icon {
        padding: 10px;
        min-width: 40px;
      }
    }
    
    table{
      width:100%;
      border-collapse:collapse;
      background:rgba(255,255,255,0.02);
      border-radius:var(--radius);
      overflow:hidden;
      font-size:13px;
    }
    
    @media (min-width: 768px) {
      table {
        font-size: 14px;
      }
    }
    
    th,td{
      padding:10px 8px;
      border-bottom:1px solid rgba(255,255,255,0.05);
      text-align:right;
      font-variant-numeric:tabular-nums;
      vertical-align:middle;
    }
    
    @media (min-width: 768px) {
      th,td {
        padding: 16px 12px;
      }
    }
    
    th:first-child,td:first-child{text-align:left}
    
    th{
      background:rgba(255,255,255,0.05);
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:var(--muted);
    }
    
    @media (min-width: 768px) {
      th {
        font-size: 13px;
      }
    }
    
    .scroll{
      overflow:auto;
      max-height:40vh;
      border-radius:var(--radius);
    }
    
    @media (min-width: 768px) {
      .scroll {
        max-height: 50vh;
      }
    }
    
    .kpis{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      margin:16px 0;
    }
    
    @media (min-width: 768px) {
      .kpis {
        grid-template-columns: repeat(5,1fr);
        gap: 16px;
        margin: 20px 0;
      }
    }
    
    @media (min-width: 480px) and (max-width: 767px) {
      .kpis {
        grid-template-columns: repeat(3,1fr);
      }
    }
    
    .kpi{
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.05);
      border-radius:var(--radius);
      padding:16px;
      text-align:center;
      transition:all 0.3s ease;
    }
    
    @media (min-width: 768px) {
      .kpi {
        padding: 20px;
      }
    }
    
    .kpi:hover{
      background:rgba(255,255,255,0.05);
      transform:translateY(-2px);
    }
    
    .kpi .v{
      font-size:18px;
      font-weight:700;
      color:var(--accent-light);
      margin-top:6px;
    }
    
    @media (min-width: 768px) {
      .kpi .v {
        font-size: 24px;
        margin-top: 8px;
      }
    }
    
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-left:8px;
      padding:3px 6px;
      border-radius:var(--radius-sm);
      background:rgba(255,255,255,0.05);
    }
    
    @media (min-width: 768px) {
      .hint {
        font-size: 13px;
        margin-left: 12px;
        padding: 4px 8px;
      }
    }
    
    .hint.warn{
      color:var(--warn);
      background:rgba(239,68,68,0.1);
    }
    
    .tabs{
      display:flex;
      gap:6px;
      margin-bottom:16px;
      background:rgba(255,255,255,0.03);
      padding:3px;
      border-radius:var(--radius);
      overflow-x:auto;
    }
    
    @media (min-width: 768px) {
      .tabs {
        gap: 8px;
        margin-bottom: 20px;
        padding: 4px;
      }
    }
    
    .tab{
      padding:10px 16px;
      border-radius:var(--radius);
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:500;
      transition:all 0.3s ease;
      flex:1;
      text-align:center;
      white-space:nowrap;
      min-width:80px;
    }
    
    @media (min-width: 768px) {
      .tab {
        padding: 12px 20px;
        min-width: 100px;
      }
    }
    
    .tab.active{
      background:var(--accent);
      color:white;
      box-shadow:var(--shadow);
    }
    
    .tab:hover:not(.active){
      background:rgba(255,255,255,0.05);
      color:var(--ink);
    }

        /* calc table */
    .calc-scroll{
      overflow:auto;
      max-height:35vh;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:var(--radius);
      background:rgba(255,255,255,0.02);
    }
    
    @media (min-width: 768px) {
      .calc-scroll {
        max-height: 45vh;
      }
    }
    
    .calc-table{
      min-width:800px;
    }
    
    @media (min-width: 1024px) {
      .calc-table {
        min-width: 1200px;
      }
    }
    
    .calc-table th{
      position:sticky;
      top:0;
      background:rgba(255,255,255,0.05);
      z-index:1;
      backdrop-filter:blur(10px);
    }
    
    .col-project{min-width:120px}.col-villa{min-width:150px}.col-qty{min-width:60px}.col-area{min-width:70px}.col-ppsm{min-width:80px}
    .col-base{min-width:120px}.col-disc{min-width:80px}.col-pre{min-width:90px}.col-months{min-width:80px}.col-rate{min-width:90px}
    .col-first{min-width:100px}.col-lineTotal{min-width:120px}.col-actions{min-width:80px}
    
    @media (min-width: 1024px) {
      .col-project{min-width:200px}.col-villa{min-width:260px}.col-qty{min-width:80px}.col-area{min-width:90px}.col-ppsm{min-width:110px}
      .col-base{min-width:190px}.col-disc{min-width:130px}.col-pre{min-width:120px}.col-months{min-width:110px}.col-rate{min-width:120px}
      .col-first{min-width:140px}.col-lineTotal{min-width:190px}.col-actions{min-width:110px}
    }
    
    .base-strong{
      font-weight:700;
      font-size:14px;
      color:var(--strong);
    }
    
    @media (min-width: 768px) {
      .base-strong {
        font-size: 16px;
      }
    }
    
    .line-strong{
      font-weight:700;
      font-size:14px;
      color:var(--good);
    }
    
    @media (min-width: 768px) {
      .line-strong {
        font-size: 16px;
      }
    }
    
    /* modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      backdrop-filter:blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
      animation:fadeIn 0.3s ease;
      padding:16px;
    }
    
    @media (min-width: 768px) {
      .modal {
        padding: 24px;
      }
    }
    
    @keyframes fadeIn{
      from{opacity:0} to{opacity:1}
    }
    
    .modal .panel{
      background:var(--card);
      backdrop-filter:blur(20px);
      border:1px solid var(--line);
      border-radius:var(--radius-xl);
      width:100%;
      max-width:1100px;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      box-shadow:var(--shadow-xl);
      animation:slideUp 0.3s ease;
    }
    
    @media (min-width: 768px) {
      .modal .panel {
        max-height: 86vh;
      }
    }
    
    @keyframes slideUp{
      from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1}
    }
    
    .modal .head{
      padding:16px 20px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    
    @media (min-width: 768px) {
      .modal .head {
        padding: 20px 24px;
        gap: 16px;
      }
    }
    
    .modal .body{
      display:grid;
      grid-template-columns:1fr;
      min-height:50vh;
    }
    
    @media (min-width: 768px) {
      .modal .body {
        grid-template-columns: 280px 1fr;
        min-height: 60vh;
      }
    }
    
    .modal .side{
      border-right:none;
      border-bottom:1px solid var(--line);
      overflow:auto;
      background:rgba(255,255,255,0.02);
      max-height:200px;
    }
    
    @media (min-width: 768px) {
      .modal .side {
        border-right: 1px solid var(--line);
        border-bottom: none;
        max-height: none;
      }
    }
    
    .modal .content{overflow:auto;padding:16px}
    
    @media (min-width: 768px) {
      .modal .content {
        padding: 20px;
      }
    }
    
    .side .proj{
      padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,0.05);
      cursor:pointer;
      transition:all 0.3s ease;
    }
    
    @media (min-width: 768px) {
      .side .proj {
        padding: 16px 20px;
      }
    }
    
    .side .proj:hover{
      background:rgba(255,255,255,0.05);
    }
    
    .side .proj.active{
      background:var(--accent);
      color:white;
    }
    
    .filters{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
      margin-bottom:16px;
    }
    
    @media (min-width: 480px) {
      .filters {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
    }
    
    @media (min-width: 768px) {
      .filters {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }
    }
    
    .modal table{
      min-width:600px;
      font-size:12px;
    }
    
    @media (min-width: 768px) {
      .modal table {
        min-width: 800px;
        font-size: 14px;
      }
    }
    
    .modal .foot{
      padding:16px 20px;
      border-top:1px solid var(--line);
      display:flex;
      gap:12px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    
    @media (min-width: 768px) {
      .modal .foot {
        padding: 20px 24px;
        gap: 16px;
      }
    }
    
    /* Адаптивные стили для мобильных устройств */
    @media (max-width: 767px) {
      .row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .field {
        margin-bottom: 12px;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 8px;
      }
      
      .btn.icon {
        width: auto;
        margin-bottom: 0;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        min-width: auto;
      }
      
      .kpis {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .calc-scroll {
        max-height: 30vh;
      }
      
      .scroll {
        max-height: 30vh;
      }
      
      .modal .panel {
        margin: 16px;
        max-height: calc(100vh - 32px);
      }
      
      .modal .body {
        min-height: 40vh;
      }
      
      .modal .side {
        max-height: 150px;
      }
    }
    
    /* Стили для планшетов */
    @media (min-width: 768px) and (max-width: 1023px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .card {
        padding: 20px;
      }
      
      .calc-scroll {
        max-height: 40vh;
      }
      
      .kpis {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    /* Стили для ноутбуков */
    @media (min-width: 1024px) and (max-width: 1199px) {
      .grid {
        grid-template-columns: 400px 1fr;
        gap: 20px;
      }
      
      .wrap {
        max-width: 1200px;
      }
    }
    
    /* Стили для больших экранов */
    @media (min-width: 1200px) {
      .wrap {
        max-width: 1400px;
      }
      
      .grid {
        grid-template-columns: 450px 1fr;
        gap: 24px;
      }
    }
    
    @media print{
      body{background:#fff;color:#000}
      .wrap{max-width:none;margin:0;padding:0}
      .grid{display:block}
      .card{border:0;border-radius:0}
      .hr{margin:12px 0}
      .tabs,.row button,.field select,.field input{display:none !important}
      canvas{break-inside:avoid}
    }
    
    /* Анимации для элементов */
    .card, .btn, .kpi, .tab {
      animation: fadeInUp 0.6s ease forwards;
      opacity: 0;
      transform: translateY(20px);
    }
    
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Задержка анимации для разных элементов */
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .kpi:nth-child(1) { animation-delay: 0.3s; }
    .kpi:nth-child(2) { animation-delay: 0.4s; }
    .kpi:nth-child(3) { animation-delay: 0.5s; }
    .kpi:nth-child(4) { animation-delay: 0.6s; }
    .kpi:nth-child(5) { animation-delay: 0.7s; }
    
    /* Улучшенные стили для форм */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    @media (min-width: 480px) {
      .form-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--ink);
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid transparent;
      border-radius: var(--radius);
      background: rgba(255,255,255,0.05);
      color: var(--ink);
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.08);
      box-shadow: 0 0 0 4px rgba(139,92,246,0.1);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-select {
      cursor: pointer;
    }
    
    .form-select option {
      background: var(--card);
      color: var(--ink);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="app-title">Arconique / Калькулятор рассрочки для любимых клиентов — v7.6</h1>
    <div id="boot-diagnostics" style="position:fixed;left:10px;top:10px;z-index:99999;background:#1b2336;color:#fff;border:1px solid #334;padding:8px 10px;border-radius:8px;font:12px/1.4 system-ui;max-width:80vw;display:none"></div>
    <div id="root"></div>
  </div>

    <!-- libs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <!-- boot diagnostics: ловим CDN/JSX ошибки и запускаем компиляцию -->
  <script>
    (function(){
      const box=document.getElementById('boot-diagnostics');
      const log=(msg)=>{ box.style.display='block'; box.innerHTML+=(box.innerHTML?'<br>':'')+msg; };
      window.addEventListener('error',e=>log('JS error: '+(e?.message||e)));
      window.addEventListener('unhandledrejection',e=>log('Promise error: '+(e?.reason?.message||e?.reason||e)));

      let tries=0;
      function tick(){
        const okReact=!!(window.React&&window.ReactDOM);
        const okBabel=!!window.Babel;
        if(!okReact) log('React не загрузился (CDN?)');
        if(!okBabel) log('Babel не загрузился — JSX не скомпилируется');
        if(okReact&&okBabel){
          try{ window.Babel.transformScriptTags(); }
          catch(e){ log('Babel.transformScriptTags() error: '+e.message); }
          return;
        }
        if(++tries<30) setTimeout(tick,200);
        else log('Таймаут ожидания библиотек — проверь блокировщики/фаервол/CDN');
      }
      setTimeout(tick,0);
    })();
  </script>

  <!-- v7.6 (stable) -->
  <script type="text/babel" data-presets="env,react">
    const {useEffect,useMemo,useRef,useState} = React;

    /* ---------- PIN / security ---------- */
    const PIN_CODE = '334346';
    const PIN_SALT = 'enso-v7.4-salt-1';
    const PIN_HASH_HEX = 'c0b37fd5b1ebc835af06c260b9ceb435285f79ecffd7f0a68be695db347d2aa6'; // sha256('334346|enso-v7.4-salt-1')

    async function sha256Hex(str){
      try{
        // Проверяем доступность crypto.subtle
        if (!crypto.subtle) {
          console.warn('crypto.subtle not available, using fallback');
          return '';
        }
        const buf = new TextEncoder().encode(str);
        const digest = await crypto.subtle.digest('SHA-256', buf);
        return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(e){ 
        console.warn('SHA-256 failed:', e);
        return ''; 
      }
    }
    async function verifyPinFlow(){
      const pin = prompt('Enter PIN');
      if(pin==null) return false;
      const hex = await sha256Hex(`${pin}|${PIN_SALT}`);
      if(hex && hex === PIN_HASH_HEX) return true;
      return pin === PIN_CODE; // fallback
    }

    /* ---------- i18n ---------- */
    const T = {
      ru: {
        title:'Arconique / Калькулятор рассрочки для любимых клиентов — v7.6',
        editor:'Редактор', client:'Клиент',
        lang:'Язык интерфейса', currencyDisplay:'Валюта отображения',
        idrRate:'IDR за 1 USD', eurRate:'EUR за 1 USD',
        handoverMonth:'Месяц получения ключей',
        globalTerm:'Глобальный срок post‑handover (6–24 мес)',
        globalRate:'Глобальная ставка, %/мес',
        clientTerm:'Срок post‑handover (мес)',
        stagesTitle:'Этапы ДО ключей',
        stage:'Этап', percent:'%', month:'Месяц',
        addStage:'Добавить этап', delete:'Удалить',
        villasTitle:'Расчёт (позиции)',
        project:'Проект', villa:'Вилла', qty:'Кол-во',
        area:'м²', ppsm:'$ / м²', price:'База (USD)',
        discount:'Скидка, %', prePct:'До ключей, %',
        months:'Срок, мес', rate:'Ставка, %/мес',
        firstPost:'Первый платёж', lineTotal:'Итог по строке',
        addFromCatalog:'Добавить из каталога',
        cashflowTitle:'Сводный кэшфлоу по месяцам',
        cashMonth:'Месяц', cashDesc:'Описание',
        cashTotal:'Сумма к оплате', cashBalance:'Остаток долга',
        totals:'Итоги', base:'База', prepay:'Оплата до ключей',
        after:'Остаток после ключей', interestTotal:'Проценты (post)',
        final:'Итоговая цена',
        lines:'Позиций', keys:'Ключи: мес.',
        chartTitle:'Платежи по месяцам',
        sumStages:'Сумма этапов', targetPrepay:'Целевой % до ключей',
        mismatch:'— отличается от целевого', mixedTargets:'разные цели у строк',
        shareCopied:'Ссылка скопирована',
        exportCSV:'Экспорт CSV', exportXLSX:'Экспорт Excel', exportPDF:'Сохранить в PDF',
        tabCalc:'Расчёт', tabCatalog:'Каталог',
        catalogTitle:'Каталог проектов и вилл (редактор)',
        addProject:'Добавить проект', addVilla:'Добавить виллу',
        importJSON:'Импорт JSON', exportJSON:'Экспорт JSON',
        selectFromCatalog:'Выбор из каталога',
        search:'Поиск', areaFrom:'м² от', areaTo:'м² до',
        priceFrom:'Цена от', priceTo:'Цена до',
        sort:'Сортировать', byPrice:'по цене', byArea:'по площади', byName:'по названию',
        addSelected:'Добавить выбранные', cancel:'Отмена',
        qtyShort:'Кол-во', baseUSD:'База (USD)',
        // Новые поля для улучшенного каталога
        projectId:'ID проекта', projectName:'Название проекта',
        villaId:'ID виллы', villaName:'Название виллы',
        villaArea:'Площадь (м²)', villaPpsm:'Цена за м² ($)',
        villaBasePrice:'Базовая цена ($)', save:'Сохранить',
        edit:'Редактировать', remove:'Удалить'
      },
      en: {
        title:'Arconique / Installments Calculator — v7.6',
        editor:'Editor', client:'Client',
        lang:'Language', currencyDisplay:'Display currency',
        idrRate:'IDR per 1 USD', eurRate:'EUR per 1 USD',
        handoverMonth:'Handover month',
        globalTerm:'Global post‑handover term (6–24 mo)',
        globalRate:'Global rate, %/month',
        clientTerm:'Post‑handover term (months)',
        stagesTitle:'Pre‑handover stages',
        stage:'Stage', percent:'%', month:'Month',
        addStage:'Add stage', delete:'Delete',
        villasTitle:'Calculation (lines)',
        project:'Project', villa:'Villa', qty:'Qty',
        area:'sqm', ppsm:'$ / sqm', price:'Base (USD)',
        discount:'Discount, %', prePct:'Pre‑handover, %',
        months:'Term, mo', rate:'Rate, %/mo',
        firstPost:'First payment', lineTotal:'Line total',
        addFromCatalog:'Add from catalog',
        cashflowTitle:'Monthly consolidated cashflow',
        cashMonth:'Month', cashDesc:'Description',
        cashTotal:'Amount due', cashBalance:'Remaining balance',
        totals:'Totals', base:'Base', prepay:'Paid before keys',
        after:'Balance after keys', interestTotal:'Interest (post)',
        final:'Final price',
        lines:'Lines', keys:'Keys: mo.',
        chartTitle:'Payments by month',
        sumStages:'Stages sum', targetPrepay:'Target pre‑handover %',
        mismatch:'— differs from target', mixedTargets:'different line targets',
        shareCopied:'Link copied',
        exportCSV:'Export CSV', exportXLSX:'Export Excel', exportPDF:'Save to PDF',
        tabCalc:'Calculation', tabCatalog:'Catalog',
        catalogTitle:'Projects & Villas Catalog (editor)',
        addProject:'Add project', addVilla:'Add villa',
        importJSON:'Import JSON', exportJSON:'Export JSON',
        selectFromCatalog:'Select from catalog',
        search:'Search', areaFrom:'sqm from', areaTo:'sqm to',
        priceFrom:'Price from', priceTo:'Price to',
        sort:'Sort', byPrice:'by price', byArea:'by area', byName:'by name',
        addSelected:'Add selected', cancel:'Cancel',
        qtyShort:'Qty', baseUSD:'Base (USD)',
        // Новые поля для улучшенного каталога
        projectId:'Project ID', projectName:'Project Name',
        villaId:'Villa ID', villaName:'Villa Name',
        villaArea:'Area (sqm)', villaPpsm:'Price per sqm ($)',
        villaBasePrice:'Base Price ($)', save:'Save',
        edit:'Edit', remove:'Remove'
      }
    };

    const clamp=(v,lo,hi)=>Math.min(hi,Math.max(lo,v));
    const fmtMoney=(n,c='USD')=>new Intl.NumberFormat('en-US',{style:'currency',currency:c,maximumFractionDigits:2}).format(n??0);

    /* ---------- URL state (compressed hash) ---------- */
    const readHash=()=>{const h=location.hash.startsWith('#')?location.hash.slice(1):location.hash;const sp=new URLSearchParams(h);return {s:sp.get('s'),view:sp.get('view')}};
    const encodeState=(state,{view}={})=>{try{const s=LZString.compressToEncodedURIComponent(JSON.stringify(state));const u=new URL(location.href);const sp=new URLSearchParams();sp.set('s',s);if(view)sp.set('view',view);u.hash=sp.toString();return u.toString()}catch{return''}};
    const decodeState=()=>{try{const {s,view}=readHash();if(!s)return null;const json=LZString.decompressFromEncodedURIComponent(s);return {state:JSON.parse(json),view}}catch{return null}};

    /* ---------- demo catalog ---------- */
    const DEFAULT_CATALOG=[
      {projectId:'ahao',projectName:'AHAO Gardens',villas:[
        {villaId:'ahao-2br',name:'2BR Garden Villa',area:100,ppsm:2500,baseUSD:250000},
        {villaId:'ahao-3br',name:'3BR Garden Villa',area:130,ppsm:2450,baseUSD:318500}
      ]},
      {projectId:'enso',projectName:'Enso Villas',villas:[
        {villaId:'enso-2br',name:'Enso 2BR',area:100,ppsm:2500,baseUSD:250000},
        {villaId:'enso-3br',name:'Enso 3BR',area:120,ppsm:2700,baseUSD:324000}
      ]},
      {projectId:'eternal',projectName:'Eternal Villas',villas:[
        {villaId:'eternal-1br',name:'Eternal 1BR Loft',area:80,ppsm:2600,baseUSD:208000},
        {villaId:'eternal-2br',name:'Eternal 2BR',area:110,ppsm:2550,baseUSD:280500}
      ]}
    ];

    /* ---------- Components ---------- */
    function App(){
      const [lang,setLang]=useState('ru'); const t=T[lang];
      const [tab,setTab]=useState('calc'); // 'calc'|'catalog'
      const [isClient,setIsClient]=useState(true);

      const [currency,setCurrency]=useState('USD');
      const [idrPerUsd,setIdrPerUsd]=useState(16500);
      const [eurPerUsd,setEurPerUsd]=useState(0.92);
      const toCurrency=usd=>currency==='USD'?usd:(currency==='IDR'?usd*idrPerUsd:usd*eurPerUsd);

      const [handoverMonth,setHandoverMonth]=useState(12);
      const [months,setMonths]=useState(12);
      const [monthlyRatePct,setMonthlyRatePct]=useState(8.33);

      const [stages,setStages]=useState([
        {id:1,label:'Договор',pct:30,month:0},
        {id:2,label:'50% готовности',pct:30,month:6},
        {id:3,label:'70% готовности',pct:20,month:9},
        {id:4,label:'90% готовности',pct:15,month:11},
        {id:5,label:'Ключи',pct:5,month:12},
      ]);
      const stagesSumPct=useMemo(()=>stages.reduce((s,x)=>s+(+x.pct||0),0),[stages]);

      const [catalog,setCatalog]=useState(DEFAULT_CATALOG);

      const [lines,setLines]=useState([
        {id:1,projectId:'enso',villaId:'enso-2br',qty:1,prePct:70,ownTerms:false,months:null,monthlyRatePct:null,firstPostUSD:0,discountPct:0,
         snapshot:{name:'Enso 2BR',area:100,ppsm:2500,baseUSD:250000}}
      ]);

      const [modalOpen,setModalOpen]=useState(false);
      const [catalogModalOpen,setCatalogModalOpen]=useState(false);

      useEffect(()=>{(async()=>{
        try{
          const fromUrl=decodeState();
          const saved=fromUrl?.state || JSON.parse(localStorage.getItem('arconique_v76')||'null');
          if(saved){
            if(saved.lang) setLang(saved.lang);
            if(saved.currency) setCurrency(saved.currency);
            if(typeof saved.idrPerUsd==='number') setIdrPerUsd(saved.idrPerUsd);
            if(typeof saved.eurPerUsd==='number') setEurPerUsd(saved.eurPerUsd);
            if(typeof saved.handoverMonth==='number') setHandoverMonth(saved.handoverMonth);
            if(typeof saved.months==='number') setMonths(saved.months);
            if(typeof saved.monthlyRatePct==='number') setMonthlyRatePct(saved.monthlyRatePct);
            if(Array.isArray(saved.stages)) setStages(saved.stages);
            if(Array.isArray(saved.catalog)) setCatalog(saved.catalog);
            if(Array.isArray(saved.lines)) setLines(saved.lines);
            if(saved.tab) setTab(saved.tab);
          }
          const view=(fromUrl?.view)|| (new URLSearchParams(location.hash.slice(1)).get('view'));
          if(view==='editor'){
            const ok=await verifyPinFlow();
            setIsClient(!ok);
            if(!ok){
              const url=encodeState(snapshot(),{view:'client'});
              if(url) history.replaceState(null,'',url);
              alert(lang==='ru'?'Неверный PIN — открыт клиентский режим':'Wrong PIN — opened client view');
            }
          }else setIsClient(true);
        }catch(e){ console.error(e); }
        document.getElementById('app-title').textContent=t.title;
        document.title=t.title;
      })()},[]);

      const snapshot=()=>({lang,currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,catalog,lines,tab});
      useEffect(()=>{
        localStorage.setItem('arconique_v76',JSON.stringify(snapshot()));
        document.getElementById('app-title').textContent=t.title;
        document.title=t.title;
      },[lang,currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,catalog,lines,tab]);

      const findProject=pid=>catalog.find(p=>p.projectId===pid);

      const linesData=useMemo(()=>lines.map(line=>{
        const base0=line.snapshot?.baseUSD ?? ((line.snapshot?.area||0)*(line.snapshot?.ppsm||0));
        const disc=clamp(+line.discountPct||0,0,20);
        const base=base0*(1-disc/100);

        const prePct=line.prePct ?? 0;
        const k=stagesSumPct===0?0:prePct/stagesSumPct;
        const preSchedule=stages.map(s=>({
          month:Math.max(0,Math.min(handoverMonth,Math.round(+s.month||0))),
          label:s.label,
          amountUSD: base*(((+s.pct||0)*k)/100),
        })).filter(r=>r.amountUSD>0).sort((a,b)=>a.month-b.month);
        const preTotalOne=preSchedule.reduce((s,r)=>s+r.amountUSD,0);

        const vMonths=line.ownTerms && line.months ? line.months : months;
        const rate=(line.ownTerms && line.monthlyRatePct!=null)?(line.monthlyRatePct/100):(monthlyRatePct/100);
        const firstPostUSD=Math.max(0,+line.firstPostUSD||0);
        const principalBase=Math.max(0, base - preTotalOne - firstPostUSD);

        let bal=principalBase,totalInterest=0;
        const principalShare=vMonths>0?principalBase/vMonths:0;
        const postRows=[];
        for(let i=1;i<=vMonths;i++){
          const interest=bal*rate; totalInterest+=interest;
          const payment=principalShare+interest;
          postRows.push({month:handoverMonth+i,label:(lang==='ru'?'Месяц ':'Month ')+i,principalUSD:principalShare,interestUSD:interest,paymentUSD:payment,balanceAfterUSD:Math.max(0,bal-principalShare)});
          bal-=principalShare;
        }
        const lineTotalOne=base+totalInterest;

        const qty=Math.max(1,parseInt(line.qty||1,10));
        const preScheduleQ=preSchedule.map(r=>({...r,amountUSD:r.amountUSD*qty}));
        const postRowsQ=postRows.map(r=>({...r,principalUSD:r.principalUSD*qty,interestUSD:r.interestUSD*qty,paymentUSD:r.paymentUSD*qty}));
        const preTotal=preTotalOne*qty;
        const firstPostQ=firstPostUSD*qty;
        const baseQ=base*qty;
        const lineTotal=lineTotalOne*qty;

        return {line,qty,baseOne:base,base:baseQ,preSchedule:preScheduleQ,preTotal,firstPostUSD:firstPostQ,postRows:postRowsQ,lineTotal,vMonths,rate,discountPct:disc};
      }),[lines,stages,stagesSumPct,handoverMonth,months,monthlyRatePct,lang]);

      const project=useMemo(()=>{
        const totals={
          baseUSD:linesData.reduce((s,x)=>s+x.base,0),
          preUSD: linesData.reduce((s,x)=>s+x.preTotal,0),
          finalUSD:linesData.reduce((s,x)=>s+x.lineTotal,0),
        };
        totals.interestUSD = totals.finalUSD - totals.baseUSD;
        totals.afterUSD = totals.finalUSD - totals.preUSD;

        const m=new Map();
        const push=(month,amt,desc)=>{ if(amt<=0) return; const prev=m.get(month)||{month,items:[],amountUSD:0}; prev.items.push(desc); prev.amountUSD+=amt; m.set(month,prev); };
        linesData.forEach(ld=>{
          ld.preSchedule.forEach(r=> push(r.month,r.amountUSD,`${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${r.label}`));
          if(ld.firstPostUSD>0) push(handoverMonth+1, ld.firstPostUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${lang==='ru'?'Первый платёж':'First payment'}`);
          ld.postRows.forEach(r=> push(r.month, r.paymentUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${r.label}`));
        });
        const raw=[...m.values()].sort((a,b)=>a.month-b.month);
        let cumulative=0;
        const cashflow=raw.map(row=>{ cumulative+=row.amountUSD; const balanceUSD=Math.max(0, totals.finalUSD - cumulative); return {...row,cumulativeUSD:cumulative,balanceUSD}; });
        return {totals,cashflow};
      },[linesData,handoverMonth,lang]);

      const chartRef=useRef(null); const chartObj=useRef(null);
      useEffect(()=>{
        try{
          const ctx=chartRef.current?.getContext('2d'); if(!ctx) return;
          if(chartObj.current) chartObj.current.destroy();
          chartObj.current=new Chart(ctx,{
            type:'bar',
            data:{labels:project.cashflow.map(c=>String(c.month)),datasets:[{label:T[lang].chartTitle,data:project.cashflow.map(c=>toCurrency(c.amountUSD))}]},
            options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:(c)=>fmtMoney(c.parsed.y,currency)}}},scales:{y:{ticks:{callback:(v)=>fmtMoney(v,currency)}}}}
          });
        }catch(e){ /* если Chart.js не загрузился — не ломаем страницу */ }
      },[project.cashflow,currency,idrPerUsd,eurPerUsd,lang]);

      const exportCSV=()=>{
        const rows=[[t.cashMonth,t.cashDesc,t.cashTotal,t.cashBalance],...project.cashflow.map(c=>[c.month,(c.items||[]).join(' + '),toCurrency(c.amountUSD).toFixed(2),toCurrency(c.balanceUSD).toFixed(2)])];
        const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`arconique_cashflow_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(a.href);
      };
      const exportXLSX=()=>{
        const ws1=XLSX.utils.json_to_sheet(project.cashflow.map(c=>({[t.cashMonth]:c.month,[t.cashDesc]:(c.items||[]).join(' + '),[t.cashTotal]:toCurrency(c.amountUSD),[t.cashBalance]:toCurrency(c.balanceUSD)})));
        const ws2=XLSX.utils.json_to_sheet(linesData.map(ld=>({[t.project]:findProject(ld.line.projectId)?.projectName||ld.line.projectId,[t.villa]:ld.line.snapshot?.name,[t.qty]:ld.qty,[t.area]:ld.line.snapshot?.area,[t.ppsm]:ld.line.snapshot?.ppsm,[t.price]:ld.base,[t.discount]:(ld.discountPct||0)+'%',[t.prePct]:ld.line.prePct,[t.months]:ld.vMonths,[t.lineTotal]:ld.lineTotal})));
        const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws1,'Cashflow'); XLSX.utils.book_append_sheet(wb,ws2,'Lines'); XLSX.writeFile(wb,`arconique_installments_${new Date().toISOString().slice(0,10)}.xlsx`);
      };
      const exportPDF=()=>window.print();

      const share=async(view)=>{const url=encodeState(snapshot(),{view}); if(url){await navigator.clipboard.writeText(url); alert(t.shareCopied)}};

      const updLine=(id,patch)=>setLines(prev=>prev.map(l=>l.id===id?{...l,...patch}:l));
      const delLine=(id)=>setLines(prev=>prev.filter(l=>l.id!==id));
      const dupLine=(id)=>setLines(prev=>{const src=prev.find(x=>x.id===id); if(!src)return prev; const nid=(prev[prev.length-1]?.id||0)+1; return [...prev,{...src,id:nid,qty:1}]});

      return (
        <>
          <div className="grid">
            <div className="card">
              {!isClient && (
                <div className="tabs">
                  <button className={`tab ${tab==='calc'?'active':''}`} onClick={()=>setTab('calc')}>{t.tabCalc}</button>
                  <button className={`tab ${tab==='catalog'?'active':''}`} onClick={()=>setTab('catalog')}>{t.tabCatalog}</button>
                </div>
              )}

              <div className="field">
                <label>{t.lang}</label>
                <select value={lang} onChange={e=>setLang(e.target.value)}>
                  <option value="ru">Русский</option><option value="en">English</option>
                </select>
              </div>

              <div className="field">
                <label>{t.currencyDisplay}</label>
                <select value={currency} onChange={e=>setCurrency(e.target.value)}>
                  <option>USD</option><option>IDR</option><option>EUR</option>
                </select>
              </div>

              {!isClient && (
                <div className="row">
                  <div className="field" style={{flex:1}}>
                    <label>{t.idrRate}</label>
                    <input type="number" min="1" step="1" value={idrPerUsd} onChange={e=>setIdrPerUsd(clamp(parseFloat(e.target.value||0),1,1e9))}/>
                  </div>
                  <div className="field" style={{flex:1}}>
                    <label>{t.eurRate}</label>
                    <input type="number" min="0.01" step="0.01" value={eurPerUsd} onChange={e=>setEurPerUsd(clamp(parseFloat(e.target.value||0),0.01,100))}/>
                  </div>
                </div>
              )}

              <div className="row">
                <div className="field" style={{flex:1}}>
                  <label>{t.handoverMonth}</label>
                  <input type="number" min="1" step="1" value={handoverMonth} onChange={e=>setHandoverMonth(clamp(parseInt(e.target.value||0,10),1,120))}/>
                </div>
                {!isClient ? (
                  <>
                    <div className="field" style={{flex:1}}>
                      <label>{t.globalTerm}</label>
                      <input type="range" min="6" max="24" step="1" value={months} onChange={e=>setMonths(parseInt(e.target.value,10))}/>
                      <div className="pill">{t.months}: {months}</div>
                    </div>
                    <div className="field" style={{flex:1}}>
                      <label>{t.globalRate}</label>
                      <input type="number" min="0" step="0.01" value={monthlyRatePct} onChange={e=>setMonthlyRatePct(clamp(parseFloat(e.target.value||0),0,1000))}/>
                    </div>
                  </>
                ) : (
                  <div className="field" style={{flex:1}}>
                    <label>{t.clientTerm}</label>
                    <input type="number" min="6" step="1" value={months} onChange={e=>setMonths(clamp(parseInt(e.target.value||0,10),6,120))}/>
                  </div>
                )}
              </div>

              <div className="hr"></div>

              <h3 style={{margin:'6px 0'}}>{t.stagesTitle}</h3>
              <div className="scroll" style={{maxHeight:'26vh',border:'1px dashed #223',borderRadius:'8px',padding:'6px'}}>
                <table>
                  <thead><tr><th>{t.stage}</th><th>{t.percent}</th><th>{t.month}</th><th></th></tr></thead>
                  <tbody>
                    {stages.map(s=>(
                      <tr key={s.id}>
                        <td style={{textAlign:'left'}}><input type="text" value={s.label} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,label:e.target.value}:x))}/></td>
                        <td><input type="number" min="0" step="0.01" value={s.pct} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,pct:clamp(parseFloat(e.target.value||0),0,100)}:x))}/></td>
                        <td><input type="number" min="0" step="1" value={s.month} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,month:clamp(parseInt(e.target.value||0,10),0,handoverMonth)}:x))}/></td>
                        <td><button className="btn warn" onClick={()=>setStages(prev=>prev.filter(x=>x.id!==s.id))}>{t.delete}</button></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="row" style={{marginTop:8,alignItems:'center',justifyContent:'space-between'}}>
                <button className="btn" onClick={()=>setStages(prev=>{const last=prev[prev.length-1];const id=(last?.id||0)+1;const nextMonth=Math.min(handoverMonth,(last?.month??0)+1);return [...prev,{id,label:(lang==='ru'?'Этап':'Stage'),pct:5,month:nextMonth}]})}>{t.addStage}</button>
                {(() => {
                  const vals=lines.map(l=>l.prePct||0);
                  const allSame=vals.length?vals.every(v=>v===vals[0]):true;
                  const targetText=allSame?`${vals[0]||0}%`:`${Math.min(...vals||[0])}%–${Math.max(...vals||[0])}%`;
                  const mismatch=allSame ? (Math.round(stagesSumPct*100)/100!==(vals[0]||0)) : true;
                  return <div className={`hint ${mismatch?'warn':''}`}>{t.sumStages}: {Math.round(stagesSumPct*100)/100}% · {t.targetPrepay}: {targetText} {mismatch? (allSame? ` ${t.mismatch}` : ` (${t.mixedTargets})`) : ''}</div>;
                })()}
              </div>

              <div className="hr"></div>

              {!isClient && (
                <div className="row">
                  <button className="btn ok" onClick={()=>share('editor')}>Поделиться (редактор)</button>
                  <button className="btn" onClick={()=>share('client')}>Поделиться (клиент)</button>
                </div>
              )}
              {isClient && <div className="row"><button className="btn" onClick={()=>share('client')}>Поделиться</button></div>}

              {(!isClient && tab==='catalog') && (
                <>
                  <h3 style={{margin:'6px 0'}}>{t.catalogTitle}</h3>
                  <div className="row">
                    <button className="btn ok" onClick={()=>setCatalogModalOpen(true)}>{t.addProject}</button>
                    <button className="btn" onClick={()=>{
                      const json=prompt('Paste catalog JSON:', JSON.stringify(catalog,null,2));
                      if(!json) return;
                      try{ const obj=JSON.parse(json); if(Array.isArray(obj)) setCatalog(obj); else alert('Invalid JSON'); }catch{ alert('Invalid JSON'); }
                    }}>{t.importJSON}</button>
                    <button className="btn" onClick={()=>{
                      const blob=new Blob([JSON.stringify(catalog,null,2)],{type:'application/json'});
                      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`arconique_catalog_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
                    }}>{t.exportJSON}</button>
                  </div>
                  <div className="scroll" style={{maxHeight:'32vh'}}>
                    {catalog.map(p=>(
                      <div key={p.projectId} className="card" style={{marginTop:8}}>
                        <div className="row" style={{justifyContent:'space-between'}}>
                          <div className="row">
                            <span className="badge">{t.project}:</span>
                            <input type="text" value={p.projectName} onChange={e=>setCatalog(prev=>prev.map(x=>x.projectId===p.projectId?{...x,projectName:e.target.value}:x))}/>
                            <span className="pill">{p.projectId}</span>
                          </div>
                          <button className="btn" onClick={()=>setCatalogModalOpen(true)}>{t.addVilla}</button>
                        </div>
                        <table style={{marginTop:8}}>
                          <thead><tr><th>{t.villa}</th><th>{t.area}</th><th>{t.ppsm}</th><th>{t.price}</th></tr></thead>
                          <tbody>
                            {p.villas.map(v=>(
                              <tr key={v.villaId}>
                                <td style={{textAlign:'left'}}>
                                  <input value={v.name} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,name:e.target.value}:vv)}:pr))}/>
                                  <div className="muted" style={{fontSize:12}}>{v.villaId}</div>
                                </td>
                                <td><input type="number" min="1" step="0.1" value={v.area} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,area:clamp(parseFloat(e.target.value||0),1,100000)}:vv)}:pr))}/></td>
                                <td><input type="number" min="0" step="1" value={v.ppsm} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,ppsm:clamp(parseFloat(e.target.value||0),0,1e9)}:vv)}:pr))}/></td>
                                <td><input type="number" min="0" step="1" value={v.baseUSD} onChange={e=>setCatalog(prev=>prev.map(pr=>pr.projectId===p.projectId?{...pr,villas:pr.villas.map(vv=>vv.villaId===v.villaId?{...vv,baseUSD:clamp(parseFloat(e.target.value||0),0,1e12)}:vv)}:pr))}/></td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ))}
                  </div>
                </>
              )}
            </div>

            <div className="card">
              <div className="row" style={{justifyContent:'space-between',alignItems:'baseline'}}>
                <div className="row">
                  <span className="badge">{t.lines}: {lines.length}</span>
                  <span className="badge">{t.keys} {handoverMonth}</span>
                  {!isClient && <span className="badge">{t.months}: {months}</span>}
                </div>
                <div className="muted">{isClient ? t.client : t.editor}</div>
              </div>

              <KPIBlock isClient={isClient} t={t} totals={project.totals} currency={currency} toCurrency={toCurrency}/>

              <div className="hr"></div>

              <div className="row" style={{justifyContent:'space-between',alignItems:'center'}}>
                <h3 style={{margin:'6px 0'}}>{t.villasTitle}</h3>
                {!isClient && <button className="btn ok" onClick={()=>setModalOpen(true)}>{t.addFromCatalog}</button>}
              </div>

              <div className="calc-scroll">
                <table className="calc-table">
                  <thead>
                    <tr>
                      <th className="col-project">{t.project}</th>
                      <th className="col-villa">{t.villa}</th>
                      <th className="col-qty">{t.qty}</th>
                      <th className="col-area">{t.area}</th>
                      <th className="col-ppsm">{t.ppsm}</th>
                      <th className="col-base">{t.price}</th>
                      {!isClient && <th className="col-disc">{t.discount}</th>}
                      <th className="col-pre">{t.prePct}</th>
                      {!isClient && <th className="col-months">{t.months}</th>}
                      {!isClient && <th className="col-rate">{t.rate}</th>}
                      <th className="col-first">{t.firstPost}</th>
                      <th className="col-lineTotal">{t.lineTotal}</th>
                      <th className="col-actions"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {linesData.map(ld=>{
                      const projName=findProject(ld.line.projectId)?.projectName || ld.line.projectId;
                      const villaName=ld.line.snapshot?.name || ld.line.villaId;
                      return (
                        <tr key={ld.line.id}>
                          <td className="col-project" style={{textAlign:'left'}}><input disabled value={projName}/></td>
                          <td className="col-villa" style={{textAlign:'left'}}><input disabled value={villaName}/></td>
                          <td className="col-qty"><input type="number" min="1" step="1" value={ld.line.qty} onChange={e=>updLine(ld.line.id,{qty:clamp(parseInt(e.target.value||0,10),1,9999)})}/></td>
                          <td className="col-area"><input type="number" value={ld.line.snapshot?.area||0} disabled/></td>
                          <td className="col-ppsm"><input type="number" value={ld.line.snapshot?.ppsm||0} disabled/></td>
                          <td className="col-base base-strong">{fmtMoney(toCurrency(ld.base),currency)}</td>
                          {!isClient && <td className="col-disc"><input type="number" min="0" max="20" step="0.1" value={ld.line.discountPct||0} onChange={e=>updLine(ld.line.id,{discountPct:clamp(parseFloat(e.target.value||0),0,20)})}/></td>}
                          <td className="col-pre">
                            <input type="range" min="0" max="100" step="1" value={ld.line.prePct} onChange={e=>updLine(ld.line.id,{prePct:parseInt(e.target.value,10)})}/>
                            <div className="pill" style={{display:'inline-block',marginTop:6}}>{ld.line.prePct}%</div>
                          </td>
                          {!isClient && <>
                            <td className="col-months"><input type="number" min="6" step="1" value={ld.line.ownTerms?(ld.line.months??months):months} onChange={e=>updLine(ld.line.id,{ownTerms:true,months:clamp(parseInt(e.target.value||0,10),6,120)})}/></td>
                            <td className="col-rate"><input type="number" min="0" step="0.01" value={ld.line.ownTerms?(ld.line.monthlyRatePct??monthlyRatePct):monthlyRatePct} onChange={e=>updLine(ld.line.id,{ownTerms:true,monthlyRatePct:clamp(parseFloat(e.target.value||0),0,1000)})}/></td>
                          </>}
                          <td className="col-first"><input type="number" min="0" step="1" value={ld.line.firstPostUSD} onChange={e=>updLine(ld.line.id,{firstPostUSD:clamp(parseFloat(e.target.value||0),0,1e12)})}/></td>
                          <td className="col-lineTotal line-strong">{fmtMoney(toCurrency(ld.lineTotal),currency)}</td>
                          <td className="col-actions" style={{textAlign:'right'}}>{!isClient && <><button className="btn icon" title="Duplicate" onClick={()=>dupLine(ld.line.id)}>⧉</button><button className="btn icon warn" title="Delete" onClick={()=>delLine(ld.line.id)}>✕</button></>}</td>
                        </tr>
                      )
                    })}
                  </tbody>
                </table>
              </div>

              <div className="hr"></div>

              <div className="row" style={{justifyContent:'space-between',alignItems:'center'}}>
                <h3 style={{margin:'6px 0'}}>{t.cashflowTitle}</h3>
                <div className="row" style={{gap:8}}>
                  <button className="btn" onClick={exportCSV}>{t.exportCSV}</button>
                  <button className="btn" onClick={exportXLSX}>{t.exportXLSX}</button>

                                    <button className="btn" onClick={exportPDF}>{t.exportPDF}</button>
                </div>
              </div>

              <div className="scroll">
                <table>
                  <thead><tr><th>{t.cashMonth}</th><th>{t.cashDesc}</th><th>{t.cashTotal}</th><th>{t.cashBalance}</th></tr></thead>
                  <tbody>
                    {project.cashflow.map(c=>(
                      <tr key={c.month}>
                        <td>{c.month}</td>
                        <td style={{textAlign:'left'}}>{(c.items||[]).join(' + ')}</td>
                        <td>{fmtMoney(toCurrency(c.amountUSD),currency)}</td>
                        <td>{fmtMoney(toCurrency(c.balanceUSD),currency)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="hr"></div>
              <h3 style={{margin:'6px 0'}}>{T[lang].chartTitle}</h3>
              <canvas id="paymentsChart" height="200" ref={chartRef}></canvas>

              <div className="hr"></div>
              <h3 style={{margin:'6px 0'}}>{t.totals}</h3>
              <KPIBlock isClient={isClient} t={t} totals={project.totals} currency={currency} toCurrency={toCurrency}/>
            </div>
          </div>

          {modalOpen && (
            <CatalogModal
              t={t}
              catalog={catalog}
              onClose={()=>setModalOpen(false)}
              onAdd={(items)=>{
                setLines(prev=>{
                  const start=(prev[prev.length-1]?.id||0)+1; let id=start;
                  const appended=items.map(it=>({
                    id:id++, projectId:it.projectId, villaId:it.villaId, qty:it.qty,
                    prePct:(prev[0]?.prePct ?? 70), discountPct:0,
                    ownTerms:false, months:null, monthlyRatePct:null, firstPostUSD:0,
                    snapshot:{name:it.name,area:it.area,ppsm:it.ppsm,baseUSD:it.baseUSD}
                  }));
                  return [...prev,...appended];
                });
                setModalOpen(false);
              }}
            />
          )}

          {catalogModalOpen && (
            <CatalogEditorModal
              t={t}
              catalog={catalog}
              onClose={()=>setCatalogModalOpen(false)}
              onSave={(newCatalog)=>{
                setCatalog(newCatalog);
                setCatalogModalOpen(false);
              }}
            />
          )}
        </>
      );
    }

    function KPIBlock({isClient,t,totals,currency,toCurrency}){
      return isClient ? (
        <div className="kpis" style={{gridTemplateColumns:'repeat(3,1fr)'}}>
          <KPI label={t.final} value={fmtMoney(toCurrency(totals.finalUSD),currency)}/>
          <KPI label={t.prepay} value={fmtMoney(toCurrency(totals.preUSD),currency)}/>
          <KPI label={t.after} value={fmtMoney(toCurrency(totals.afterUSD),currency)}/>
        </div>
      ) : (
        <div className="kpis">
          <KPI label={t.base} value={fmtMoney(toCurrency(totals.baseUSD),currency)}/>
          <KPI label={t.prepay} value={fmtMoney(toCurrency(totals.preUSD),currency)}/>
          <KPI label={t.after} value={fmtMoney(toCurrency(totals.afterUSD),currency)}/>
          <KPI label={t.interestTotal} value={fmtMoney(toCurrency(totals.interestUSD),currency)}/>
          <KPI label={t.final} value={fmtMoney(toCurrency(totals.finalUSD),currency)}/>
        </div>
      );
    }

    function CatalogModal({t,catalog,onClose,onAdd}){
      const [activeProject,setActiveProject]=React.useState(catalog[0]?.projectId||'');
      const [q,setQ]=React.useState('');
      const [areaMin,setAreaMin]=React.useState(''); const [areaMax,setAreaMax]=React.useState('');
      const [priceMin,setPriceMin]=React.useState(''); const [priceMax,setPriceMax]=React.useState('');
      const [sortBy,setSortBy]=React.useState('price');
      const [selected,setSelected]=React.useState({});

      const list=React.useMemo(()=>{ const rows=[]; catalog.forEach(p=>p.villas.forEach(v=>rows.push({projectId:p.projectId,projectName:p.projectName,villaId:v.villaId,name:v.name,area:v.area,ppsm:v.ppsm,baseUSD:v.baseUSD}))); return rows; },[catalog]);

      const filtered=React.useMemo(()=>list.filter(r=>{
        if(activeProject && r.projectId!==activeProject) return false;
        if(q && !(`${r.name} ${r.projectName}`.toLowerCase().includes(q.toLowerCase()))) return false;
        if(areaMin!=='' && r.area<+areaMin) return false;
        if(areaMax!=='' && r.area>+areaMax) return false;
        if(priceMin!=='' && r.baseUSD<+priceMin) return false;
        if(priceMax!=='' && r.baseUSD>+priceMax) return false;
        return true;
      }).sort((a,b)=>{
        if(sortBy==='area') return a.area-b.area; 
        if(sortBy==='name') return a.name.localeCompare(b.name); 
        return a.baseUSD-b.baseUSD; 
      }),[list,activeProject,q,areaMin,areaMax,priceMin,priceMax,sortBy]);

      const toggle=(key)=>setSelected(prev=>{const n={...prev}; if(n[key]) delete n[key]; else n[key]=1; return n;});
      const setQty=(key,val)=>setSelected(prev=>({...prev,[key]:Math.max(1,parseInt(val||'1',10))}));
      const add=()=>{ const items=[]; Object.entries(selected).forEach(([key,qty])=>{const [pid,vid]=key.split('|'); const r=list.find(x=>x.projectId===pid&&x.villaId===vid); if(r) items.push({...r,qty});}); if(items.length>0) onAdd(items); else onClose(); };

      return (
        <div className="modal" onClick={onClose}>
          <div className="panel" onClick={e=>e.stopPropagation()}>
            <div className="head">
              <strong>{t.selectFromCatalog}</strong>
              <button className="btn" onClick={onClose}>✕</button>
            </div>
            <div className="body">
              <div className="side">
                {catalog.map(p=>(
                  <div key={p.projectId} className={`proj ${activeProject===p.projectId?'active':''}`} onClick={()=>setActiveProject(p.projectId)}>
                    <div style={{fontWeight:600}}>{p.projectName}</div>
                    <div className="muted" style={{fontSize:12}}>{p.villas.length} {t.villa.toLowerCase()}</div>
                  </div>
                ))}
              </div>
              <div className="content">
                <div className="filters">
                  <input placeholder={t.search} value={q} onChange={e=>setQ(e.target.value)} />
                  <input type="number" placeholder={t.areaFrom} value={areaMin} onChange={e=>setAreaMin(e.target.value)} style={{maxWidth:120}}/>
                  <input type="number" placeholder={t.areaTo} value={areaMax} onChange={e=>setAreaMax(e.target.value)} style={{maxWidth:120}}/>
                  <input type="number" placeholder={t.priceFrom} value={priceMin} onChange={e=>setPriceMin(e.target.value)} style={{maxWidth:140}}/>
                  <input type="number" placeholder={t.priceTo} value={priceMax} onChange={e=>setPriceMax(e.target.value)} style={{maxWidth:140}}/>
                  <select value={sortBy} onChange={e=>setSortBy(e.target.value)}>
                    <option value="price">{t.byPrice}</option>
                    <option value="area">{t.byArea}</option>
                    <option value="name">{t.byName}</option>
                  </select>
                </div>
                <div className="scroll" style={{maxHeight:'56vh',marginTop:8}}>
                  <table>
                    <thead><tr>
                      <th style={{textAlign:'left'}}>{t.project}</th>
                      <th style={{textAlign:'left'}}>{t.villa}</th>
                      <th>{t.area}</th><th>{t.ppsm}</th><th>{t.baseUSD}</th><th>{t.qtyShort}</th><th></th>
                    </tr></thead>
                    <tbody>
                      {filtered.map(r=>{
                        const key=`${r.projectId}|${r.villaId}`; const isSel=key in selected;
                        return (
                          <tr key={key}>
                            <td style={{textAlign:'left'}}>{r.projectName}</td>
                            <td style={{textAlign:'left'}}>{r.name}</td>
                            <td>{r.area}</td><td>{r.ppsm}</td><td>{r.baseUSD.toLocaleString('en-US')}</td>
                            <td><input type="number" min="1" step="1" disabled={!isSel} value={isSel?selected[key]:''} onChange={e=>setQty(key,e.target.value)} style={{width:90}}/></td>
                            <td><button className={`btn ${isSel?'ok':''}`} onClick={()=>toggle(key)}>{isSel?'✓':'+'}</button></td>
                          </tr>
                        )
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div className="foot">
              <button className="btn" onClick={onClose}>{t.cancel}</button>
              <button className="btn ok" onClick={add}>{t.addSelected}</button>
            </div>
          </div>
        </div>
      );
    }

    // Новый компонент для редактирования каталога
    function CatalogEditorModal({t,catalog,onClose,onSave}){
      const [editingProject,setEditingProject]=useState(null);
      const [editingVilla,setEditingVilla]=useState(null);
      const [newProject,setNewProject]=useState({projectId:'',projectName:'',villas:[]});
      const [newVilla,setNewVilla]=useState({villaId:'',name:'',area:100,ppsm:2500,baseUSD:250000});

      const addProject=()=>{
        if(!newProject.projectId || !newProject.projectName) return;
        const updatedCatalog=[...catalog,{...newProject}];
        onSave(updatedCatalog);
        setNewProject({projectId:'',projectName:'',villas:[]});
      };

      const addVilla=(projectId)=>{
        if(!newVilla.villaId || !newVilla.name) return;
        const updatedCatalog=catalog.map(p=>
          p.projectId===projectId 
            ? {...p,villas:[...p.villas,{...newVilla}]}
            : p
        );
        onSave(updatedCatalog);
        setNewVilla({villaId:'',name:'',area:100,ppsm:2500,baseUSD:250000});
      };

      const updateProject=(projectId,field,value)=>{
        const updatedCatalog=catalog.map(p=>
          p.projectId===projectId ? {...p,[field]:value} : p
        );
        onSave(updatedCatalog);
      };

      const updateVilla=(projectId,villaId,field,value)=>{
        const updatedCatalog=catalog.map(p=>
          p.projectId===projectId 
            ? {...p,villas:p.villas.map(v=>v.villaId===villaId ? {...v,[field]:value} : v)}
            : p
        );
        onSave(updatedCatalog);
      };

      const removeProject=(projectId)=>{
        const updatedCatalog=catalog.filter(p=>p.projectId!==projectId);
        onSave(updatedCatalog);
      };

      const removeVilla=(projectId,villaId)=>{
        const updatedCatalog=catalog.map(p=>
          p.projectId===projectId 
            ? {...p,villas:p.villas.filter(v=>v.villaId!==villaId)}
            : p
        );
        onSave(updatedCatalog);
      };

      return (
        <div className="modal" onClick={onClose}>
          <div className="panel" onClick={e=>e.stopPropagation()}>
            <div className="head">
              <strong>{t.catalogTitle}</strong>
              <button className="btn" onClick={onClose}>✕</button>
            </div>
            <div className="body">
              <div className="content">
                {/* Добавление нового проекта */}
                <div className="card" style={{marginBottom:20}}>
                  <h4 style={{margin:'0 0 16px'}}>{t.addProject}</h4>
                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">{t.projectId}</label>
                      <input 
                        className="form-input" 
                        type="text" 
                        value={newProject.projectId} 
                        onChange={e=>setNewProject(prev=>({...prev,projectId:e.target.value}))}
                        placeholder="project-id"
                      />
                    </div>
                    <div className="form-group">
                      <label className="form-label">{t.projectName}</label>
                      <input 
                        className="form-input" 
                        type="text" 
                        value={newProject.projectName} 
                        onChange={e=>setNewProject(prev=>({...prev,projectName:e.target.value}))}
                        placeholder="Project Name"
                      />
                    </div>
                  </div>
                  <button className="btn ok" onClick={addProject} style={{width:'100%'}}>{t.addProject}</button>
                </div>

                {/* Добавление новой виллы */}
                <div className="card" style={{marginBottom:20}}>
                  <h4 style={{margin:'0 0 16px'}}>{t.addVilla}</h4>
                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">{t.project}</label>
                      <select 
                        className="form-input form-select" 
                        onChange={e=>setNewVilla(prev=>({...prev,projectId:e.target.value}))}
                      >
                        <option value="">{t.selectFromCatalog}</option>
                        {catalog.map(p=>(<option key={p.projectId} value={p.projectId}>{p.projectName}</option>))}
                      </select>
                    </div>
                    <div className="form-group">
                      <label className="form-label">{t.villaId}</label>
                      <input 
                        className="form-input" 
                        type="text" 
                        value={newVilla.villaId} 
                        onChange={e=>setNewVilla(prev=>({...prev,villaId:e.target.value}))}
                        placeholder="villa-id"
                      />
                    </div>
                  </div>
                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">{t.villaName}</label>
                      <input 
                        className="form-input" 
                        type="text" 
                        value={newVilla.name} 
                        onChange={e=>setNewVilla(prev=>({...prev,name:e.target.value}))}
                        placeholder="Villa Name"
                      />
                    </div>
                    <div className="form-group">
                      <label className="form-label">{t.villaArea}</label>
                      <input 
                        className="form-input" 
                        type="number" 
                        min="1" 
                        step="0.1"
                        value={newVilla.area} 
                        onChange={e=>setNewVilla(prev=>({...prev,area:parseFloat(e.target.value)||0}))}
                      />
                    </div>
                  </div>
                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">{t.villaPpsm}</label>
                      <input 
                        className="form-input" 
                        type="number" 
                        min="0" 
                        step="1"
                        value={newVilla.ppsm} 
                        onChange={e=>setNewVilla(prev=>({...prev,ppsm:parseFloat(e.target.value)||0}))}
                      />
                    </div>
                    <div className="form-group">
                      <label className="form-label">{t.villaBasePrice}</label>
                      <input 
                        className="form-input" 
                        type="number" 
                        min="0" 
                        step="1"
                        value={newVilla.baseUSD} 
                        onChange={e=>setNewVilla(prev=>({...prev,baseUSD:parseFloat(e.target.value)||0}))}
                      />
                    </div>
                  </div>
                  <button 
                    className="btn ok" 
                    onClick={()=>addVilla(newVilla.projectId)} 
                    style={{width:'100%'}}
                    disabled={!newVilla.projectId || !newVilla.villaId || !newVilla.name}
                  >
                    {t.addVilla}
                  </button>
                </div>

                {/* Редактирование существующего каталога */}
                <div className="scroll" style={{maxHeight:'40vh'}}>
                  {catalog.map(p=>(
                    <div key={p.projectId} className="card" style={{marginBottom:16}}>
                      <div className="row" style={{justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
                        <div className="row" style={{flex:1}}>
                          <span className="badge">{t.project}:</span>
                          <input 
                            type="text" 
                            value={p.projectName} 
                            onChange={e=>updateProject(p.projectId,'projectName',e.target.value)}
                            style={{flex:1,marginRight:8}}
                          />
                          <span className="pill">{p.projectId}</span>
                        </div>
                        <button className="btn warn" onClick={()=>removeProject(p.projectId)}>{t.remove}</button>
                      </div>
                      
                      <table>
                        <thead>
                          <tr>
                            <th style={{textAlign:'left'}}>{t.villa}</th>
                            <th>{t.area}</th>
                            <th>{t.ppsm}</th>
                            <th>{t.price}</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody>
                          {p.villas.map(v=>(
                            <tr key={v.villaId}>
                              <td style={{textAlign:'left'}}>
                                <input 
                                  value={v.name} 
                                  onChange={e=>updateVilla(p.projectId,v.villaId,'name',e.target.value)}
                                  style={{width:'100%'}}
                                />
                                <div className="muted" style={{fontSize:11}}>{v.villaId}</div>
                              </td>
                              <td>
                                <input 
                                  type="number" 
                                  min="1" 
                                  step="0.1" 
                                  value={v.area} 
                                  onChange={e=>updateVilla(p.projectId,v.villaId,'area',parseFloat(e.target.value)||0)}
                                  style={{width:80}}
                                />
                              </td>
                              <td>
                                <input 
                                  type="number" 
                                  min="0" 
                                  step="1" 
                                  value={v.ppsm} 
                                  onChange={e=>updateVilla(p.projectId,v.villaId,'ppsm',parseFloat(e.target.value)||0)}
                                  style={{width:80}}
                                />
                              </td>
                              <td>
                                <input 
                                  type="number" 
                                  min="0" 
                                  step="1" 
                                  value={v.baseUSD} 
                                  onChange={e=>updateVilla(p.projectId,v.villaId,'baseUSD',parseFloat(e.target.value)||0)}
                                  style={{width:100}}
                                />
                              </td>
                              <td>
                                <button className="btn warn icon" onClick={()=>removeVilla(p.projectId,v.villaId)}>✕</button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  ))}
                </div>
              </div>
            </div>
            <div className="foot">
              <button className="btn" onClick={onClose}>{t.cancel}</button>
              <button className="btn ok" onClick={()=>onSave(catalog)}>{t.save}</button>
            </div>
          </div>
        </div>
      );
    }

    function KPI({label,value}){ 
      return (
        <div className="kpi">
          <div className="muted">{label}</div>
          <div className="v">{value}</div>
        </div>
      ); 
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
